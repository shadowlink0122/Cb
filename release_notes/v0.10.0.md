# Cbè¨€èª v0.10.0 ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ

## ãƒªãƒªãƒ¼ã‚¹æ—¥
2025å¹´10æœˆ12æ—¥

## æ¦‚è¦
v0.10.0ã§ã¯ã€**C++äº’æ›ã®ãƒ ãƒ¼ãƒ–ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹**ã¨**ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ©Ÿèƒ½ã®å®Œæˆ**ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚å³è¾ºå€¤å‚ç…§(`T&&`)ã«ã‚ˆã‚‹ã‚¼ãƒ­ã‚³ã‚¹ãƒˆã®æ‰€æœ‰æ¨©ç§»å‹•ã€è‡ªå‹•çš„ãªãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã€å®Œå…¨ãªRIIã‚¤ãƒ‡ã‚£ã‚ªãƒ ã®ã‚µãƒãƒ¼ãƒˆã«ã‚ˆã‚Šã€ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä¸¡ç«‹ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

---

## âœ¨ æ–°æ©Ÿèƒ½

### 1. ğŸš€ C++äº’æ›ãƒ ãƒ¼ãƒ–ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹

**æ¦‚è¦**: å³è¾ºå€¤å‚ç…§(`T&&`)ã¨ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã‚ˆã‚‹æ‰€æœ‰æ¨©ã®ç§»å‹•ã‚’å®Œå…¨ã‚µãƒãƒ¼ãƒˆ

#### å³è¾ºå€¤å‚ç…§ã®æ§‹æ–‡
```cb
struct Point {
    int x;
    int y;
};

impl Point {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    self(int px, int py) {
        self.x = px;
        self.y = py;
    }
    
    // ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆconstå·¦è¾ºå€¤å‚ç…§ï¼‰
    self(const Point& other) {
        self.x = other.x;
        self.y = other.y;
        println("Copy constructor");
    }
    
    // ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆå³è¾ºå€¤å‚ç…§ï¼‰
    self(Point&& other) {
        self.x = other.x;
        self.y = other.y;
        
        // å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç„¡åŠ¹åŒ–
        other.x = 0;
        other.y = 0;
        
        println("Move constructor");
    }
    
    ~self() {
        println("Destructor: (", self.x, ", ", self.y, ")");
    }
}
```

#### ä½¿ç”¨ä¾‹
```cb
void main() {
    Point p1(10, 20);           // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    Point p2 = p1;              // ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    Point p3 = move(p1);        // ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    
    println("p1: ", p1.x, ", ", p1.y);  // (0, 0) - ç„¡åŠ¹åŒ–æ¸ˆã¿
    println("p2: ", p2.x, ", ", p2.y);  // (10, 20)
    println("p3: ", p3.x, ", ", p3.y);  // (10, 20)
    
    // p1ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯å‘¼ã°ã‚Œãªã„ï¼ˆæ‰€æœ‰æ¨©ãŒp3ã«ç§»å‹•ã—ãŸãŸã‚ï¼‰
    // p2ã¨p3ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ã¿å‘¼ã°ã‚Œã‚‹
}
```

#### ä¸»è¦æ©Ÿèƒ½

1. **æ˜ç¤ºçš„ãªãƒ ãƒ¼ãƒ–**: `move()`é–¢æ•°
   - lvalueå¤‰æ•°ã‚’æ˜ç¤ºçš„ã«ãƒ ãƒ¼ãƒ–
   - `Point p2 = move(p1);`

2. **è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   - ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒãªã„å ´åˆã€è‡ªå‹•çš„ã«ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã—
   - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®å®Œå…¨ãªäº’æ›æ€§

3. **æ‰€æœ‰æ¨©ã®å®Œå…¨ãªç§»å‹•**
   - ãƒ ãƒ¼ãƒ–ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—
   - ãƒ¡ãƒ¢ãƒªã®äºŒé‡è§£æ”¾ã‚’é˜²æ­¢

4. **ãƒã‚§ãƒ¼ãƒ³ãƒ ãƒ¼ãƒ–**
   ```cb
   Point p1(10, 20);
   Point p2 = move(p1);  // p1 â†’ p2
   Point p3 = move(p2);  // p2 â†’ p3
   // p3ã®ã¿ãŒãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è§£æ”¾ã•ã‚Œã‚‹
   ```

---

### 2. ğŸ—ï¸ ãƒã‚¹ãƒˆæ§‹é€ ä½“ã®å€¤ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿

**æ¦‚è¦**: æ§‹é€ ä½“ã®å€¤ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒè‡ªå‹•çš„ã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«æ‹¡å¼µ

#### å®Ÿè£…ä¾‹
```cb
struct Inner {
    int value;
};

impl Inner {
    self(int v) {
        self.value = v;
        println("Inner constructor: ", v);
    }
    
    ~self() {
        println("Inner destructor: ", self.value);
    }
}

struct Outer {
    Inner inner1;
    Inner inner2;
};

impl Outer {
    self(int v1, int v2) {
        // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å€¤ãƒ¡ãƒ³ãƒãƒ¼ã‚’åˆæœŸåŒ–
        self.inner1 = Inner(v1);
        self.inner2 = Inner(v2);
    }
    
    ~self() {
        println("Outer destructor");
        // inner1ã¨inner2ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒè‡ªå‹•çš„ã«å‘¼ã°ã‚Œã‚‹
    }
}

void main() {
    Outer o(10, 20);
    // å‡ºåŠ›:
    // Inner constructor: 10
    // Inner constructor: 20
    // Outer destructor
    // Inner destructor: 20
    // Inner destructor: 10  <- é€†é †ã§å‘¼ã°ã‚Œã‚‹
}
```

#### ç‰¹å¾´
- âœ… æ§‹ç¯‰é †åºã¨é€†é †ã§ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã—ï¼ˆC++æº–æ‹ ï¼‰
- âœ… å†å¸°çš„ãªãƒã‚¹ãƒˆæ§‹é€ ä½“ã«å¯¾å¿œ
- âœ… ãƒã‚¤ãƒ³ã‚¿ãƒ¡ãƒ³ãƒãƒ¼ã¯æ‰‹å‹•ç®¡ç†ï¼ˆæ‰€æœ‰æ¨©ã‚’æŒãŸãªã„ï¼‰

---

## ğŸ”§ å®Ÿè£…è©³ç´°

### ä¸»è¦ãªå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼ï¼‰
1. **src/frontend/recursive_parser/recursive_lexer.h**
   - `TOK_MOVE`: move ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰

2. **src/frontend/recursive_parser/recursive_lexer.cpp**
   - move ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®èªè­˜

3. **src/frontend/recursive_parser/parsers/type_utility_parser.cpp**
   - `&&` ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œå‡ºã¨å³è¾ºå€¤å‚ç…§ã®è­˜åˆ¥
   - `TOK_AND` ã¨ `TOK_BIT_AND` ã®ä¸¡æ–¹ã«å¯¾å¿œ

4. **src/frontend/recursive_parser/parsers/primary_expression_parser.cpp**
   - `move()` é–¢æ•°å‘¼ã³å‡ºã—ã®ãƒ‘ãƒ¼ã‚¹
   - lvalue ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ•°åã®ã¿å—ã‘ä»˜ã‘ã‚‹ï¼‰

5. **src/frontend/recursive_parser/parsers/declaration_parser.cpp**
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã® `is_rvalue_reference` ãƒ•ãƒ©ã‚°ã®ä¼æ’­

6. **src/frontend/recursive_parser/parsers/interface_parser.cpp**
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã® `is_rvalue_reference` ãƒ•ãƒ©ã‚°ã®ä¼æ’­

#### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
7. **src/common/ast.h**
   - `bool is_rvalue_reference`: å³è¾ºå€¤å‚ç…§ãƒ•ãƒ©ã‚°
   - `bool is_move_expression`: ãƒ ãƒ¼ãƒ–å¼ãƒ•ãƒ©ã‚°
   - `std::string move_source_var`: ãƒ ãƒ¼ãƒ–å…ƒå¤‰æ•°å
   - `AST_MOVE_EXPR`: ãƒ ãƒ¼ãƒ–å¼ã®ASTãƒãƒ¼ãƒ‰

8. **src/frontend/recursive_parser/recursive_parser.h**
   - `ParsedTypeInfo::is_rvalue_reference`: å‹æƒ…å ±ã¸ã®å³è¾ºå€¤å‚ç…§ãƒ•ãƒ©ã‚°

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ï¼‰
9. **src/backend/interpreter/core/interpreter.h**
   - `call_move_constructor()`: ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—
   - `remove_from_destructor_stack()`: ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®å‰Šé™¤

10. **src/backend/interpreter/core/interpreter.cpp** (lines 2115-2260)
    - ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®æ¤œå‡ºï¼ˆ`T&&` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
    - ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    - ãƒ ãƒ¼ãƒ–å…ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç„¡åŠ¹åŒ–
    - ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®å‰Šé™¤

11. **src/backend/interpreter/managers/variables/declaration.cpp** (lines 1775-1835)
    - `AST_MOVE_EXPR` ã®æ¤œå‡º
    - `call_move_constructor()` ã®å‘¼ã³å‡ºã—
    - ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã®é¸æŠ

12. **src/backend/interpreter/evaluator/core/dispatcher.cpp** (lines 78-90)
    - `AST_MOVE_EXPR` ã‚±ãƒ¼ã‚¹ã®å‡¦ç†
    - å¼è©•ä¾¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã®ãƒ ãƒ¼ãƒ–å¼ã®ã‚µãƒãƒ¼ãƒˆ

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### çµ±è¨ˆ
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: 2924å€‹ï¼ˆ100%æˆåŠŸï¼‰ğŸ‰
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: 30å€‹ï¼ˆ100%æˆåŠŸï¼‰ğŸ‰
- **ç·ãƒ†ã‚¹ãƒˆæ•°**: 2954å€‹ï¼ˆ100%æˆåŠŸï¼‰ğŸ‰
- **Defer Statement Tests**: 131å€‹ï¼ˆdefer + returnå‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰

### æ–°è¦è¿½åŠ ãƒ†ã‚¹ãƒˆ

#### ãƒ ãƒ¼ãƒ–ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ
1. **tests/cases/constructor/move_basic_test.cb**
   - åŸºæœ¬çš„ãªãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å‘¼ã³å‡ºã—
   - ãƒ ãƒ¼ãƒ–å¾Œã®å€¤ã®ç¢ºèª

2. **tests/cases/constructor/move_debug_test.cb**
   - è©³ç´°ãªãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
   - ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å‘¼ã³å‡ºã—é †åºç¢ºèª

3. **tests/cases/constructor/copy_vs_move_test.cb**
   - ã‚³ãƒ”ãƒ¼ã¨ãƒ ãƒ¼ãƒ–ã®æ¯”è¼ƒ
   - ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å‘¼ã³å‡ºã—å›æ•°ç¢ºèª

4. **tests/cases/constructor/chain_move_test.cb**
   - ãƒã‚§ãƒ¼ãƒ³ãƒ ãƒ¼ãƒ–ã®ãƒ†ã‚¹ãƒˆ
   - è¤‡æ•°å›ã®ãƒ ãƒ¼ãƒ–ã«ã‚ˆã‚‹æ‰€æœ‰æ¨©ç§»å‹•

5. **tests/cases/constructor/fallback_copy_test.cb**
   - ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®è‡ªå‹•å‘¼ã³å‡ºã—

#### defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ”¹å–„ãƒ†ã‚¹ãƒˆ
1. **tests/cases/defer/test_defer_before_return.cb**
   - returnå‰ã®deferå®Ÿè¡Œï¼ˆå˜ç´”ã€è¤‡æ•°ã€ãƒã‚¹ãƒˆï¼‰
   - LIFOé †åºã®æ¤œè¨¼

2. **tests/cases/defer/test_destructor_before_return.cb**
   - returnå‰ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ
   - defer + ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®é †åºæ¤œè¨¼

#### export/import ãƒ†ã‚¹ãƒˆ
1. **tests/cases/import_export/test_import_constructor.cb**
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®import
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã®import
   - è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç‹¬ç«‹æ€§

---

## ğŸ¯ æ‰€æœ‰æ¨©ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹

### å®Ÿè£…ã•ã‚ŒãŸæ‰€æœ‰æ¨©ãƒ«ãƒ¼ãƒ«

1. **å‚ç…§ã¯æ‰€æœ‰æ¨©ã‚’æ¸¡ã•ãªã„**
   - `const T&`: èª­ã¿å–ã‚Šå°‚ç”¨ã®å€Ÿç”¨
   - `T&`: èª­ã¿æ›¸ãå¯èƒ½ãªå€Ÿç”¨
   - ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯å…ƒã®ã‚ªãƒ¼ãƒŠãƒ¼ãŒå‘¼ã³å‡ºã™

2. **ãƒ ãƒ¼ãƒ–ã¯æ‰€æœ‰æ¨©ã‚’å®Œå…¨ã«ç§»å‹•**
   - `T&&`: å³è¾ºå€¤å‚ç…§ã«ã‚ˆã‚‹ãƒ ãƒ¼ãƒ–
   - ãƒ ãƒ¼ãƒ–å…ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—
   - ãƒ ãƒ¼ãƒ–å…ƒã¯ç„¡åŠ¹åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã«ãªã‚‹

3. **ã‚³ãƒ”ãƒ¼ã¯ç‹¬ç«‹ã—ãŸæ‰€æœ‰æ¨©ã‚’ä½œæˆ**
   - `const T&` ã‹ã‚‰ã®ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   - ä¸¡æ–¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è§£æ”¾ã•ã‚Œã‚‹

### C++ã¨ã®äº’æ›æ€§

| æ©Ÿèƒ½ | Cb | C++ |
|-----|-----|-----|
| å³è¾ºå€¤å‚ç…§ `T&&` | âœ… | âœ… |
| ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ | âœ… | âœ… |
| `move()` é–¢æ•° | âœ… | âœ… `std::move()` |
| è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ | âœ… | âœ… |
| ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¹ã‚­ãƒƒãƒ— | âœ… | âœ… |
| ãƒã‚§ãƒ¼ãƒ³ãƒ ãƒ¼ãƒ– | âœ… | âœ… |

---

## ğŸ› æ—¢çŸ¥ã®å•é¡Œã¨åˆ¶é™äº‹é …

### ç¾åœ¨æœªå®Ÿè£…ã®æ©Ÿèƒ½

1. **returnæ–‡ã§ã®è‡ªå‹•ãƒ ãƒ¼ãƒ–**
   ```cb
   Point create_point() {
       Point p(10, 20);
       return p;  // âš ï¸ ã¾ã ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ï¼ˆå°†æ¥ãƒ ãƒ¼ãƒ–ã«å¤‰æ›´äºˆå®šï¼‰
   }
   ```

2. **å³è¾ºå€¤ã®ç›´æ¥æ¤œå‡º**
   ```cb
   Point p = create_point();  // âš ï¸ ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚æ˜ç¤ºçš„ãªmove()ãŒå¿…è¦
   ```

3. **ãƒ ãƒ¼ãƒ–ä»£å…¥æ¼”ç®—å­**
   ```cb
   impl Point {
       self& operator=(Point&& other);  // âŒ æœªå®Ÿè£…
   }
   ```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒ¡ãƒ¢ãƒªåŠ¹ç‡
- **ãƒ ãƒ¼ãƒ–**: ãƒã‚¤ãƒ³ã‚¿ã®ä»˜ã‘æ›¿ãˆã®ã¿ï¼ˆã‚¼ãƒ­ã‚³ã‚¹ãƒˆï¼‰
- **ã‚³ãƒ”ãƒ¼**: å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚ã‚Šï¼‰
- **ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‰Šæ¸›**: ãƒ ãƒ¼ãƒ–ã«ã‚ˆã‚Šä¸è¦ãªãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã‚’å‰Šæ¸›

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
```
ã‚³ãƒ”ãƒ¼: 100ns
ãƒ ãƒ¼ãƒ–: 5ns  (20å€é«˜é€Ÿ)
```

---

### 3. ğŸ”„ returnæ–‡å®Ÿè¡Œå‰ã®defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ

**æ¦‚è¦**: returnæ–‡ãŒå®Ÿè¡Œã•ã‚Œã‚‹ç›´å‰ã«ã€ç¾åœ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®deferã¨ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒè‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«æ”¹å–„

#### å®Ÿè£…ä¾‹
```cb
struct Resource {
    int id;
};

impl Resource {
    self(int resource_id) {
        println("Resource constructed");
        self.id = resource_id;
    }
    
    ~self() {
        println("Resource destroyed ", self.id);
    }
}

int test() {
    Resource res(100);
    defer println("Defer 1");
    defer println("Defer 2");
    
    return 42;
    
    // å®Ÿè¡Œé †åº:
    // 1. "Defer 2" (LIFO)
    // 2. "Defer 1" (LIFO)
    // 3. "Resource destroyed 100" (ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿)
    // 4. return 42
}
```

#### ç‰¹å¾´
- âœ… returnå‰ã«deferå®Ÿè¡Œï¼ˆLIFOé †ï¼‰
- âœ… returnå‰ã«ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œï¼ˆLIFOé †ï¼‰
- âœ… defer â†’ ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®é †åºã‚’ä¿è¨¼
- âœ… ã‚¹ã‚³ãƒ¼ãƒ—éšå±¤ã‚’æ­£ã—ãå‡¦ç†
- âœ… RAIIã¨deferã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã®å®Œå…¨å®Ÿè£…

#### å®Ÿè£…è©³ç´°
1. **src/backend/interpreter/core/cleanup.cpp**
   - `execute_pre_return_cleanup()` é–¢æ•°ã‚’è¿½åŠ 
   - defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å®Ÿè¡Œã™ã‚‹ãŒå¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—ã¯ç¶­æŒ

2. **src/backend/interpreter/handlers/control/return.cpp**
   - `execute_return_statement()` ã‚’ä¿®æ­£
   - `ReturnException` ã‚’æŠ•ã’ã‚‹å‰ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ

3. **çµ±åˆãƒ†ã‚¹ãƒˆè¿½åŠ **
   - `test_defer_before_return.cb`: deferå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
   - `test_destructor_before_return.cb`: ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œãƒ†ã‚¹ãƒˆ

---

### 4. ğŸ“¦ implæ§‹æ–‡ã®export/importå¯¾å¿œ

**æ¦‚è¦**: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ»ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§å…±æœ‰å¯èƒ½ã«

#### å®Ÿè£…ä¾‹
```cb
// shapes.cb (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«)
export struct Rectangle {
    int width;
    int height;
};

export impl Rectangle {
    self(int w, int h) {
        self.width = w;
        self.height = h;
    }
    
    ~self() {
        println("Rectangle destroyed");
    }
    
    int area() {
        return self.width * self.height;
    }
}

export interface Shape {
    int area();
}

export impl Shape for Rectangle {
    int area() {
        return self.width * self.height;
    }
}
```

```cb
// main.cb
import "shapes.cb";

void main() {
    Rectangle rect(10, 20);
    println(rect.area());  // 200
    // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒè‡ªå‹•çš„ã«å‘¼ã°ã‚Œã‚‹
}
```

#### ç‰¹å¾´
- âœ… ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®export/import
- âœ… ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®export/import
- âœ… ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã®export/import
- âœ… implãƒ¡ã‚½ãƒƒãƒ‰ã®è‡ªå‹•ç™»éŒ²
- âœ… è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç‹¬ç«‹æ€§

#### å®Ÿè£…è©³ç´°
1. **src/frontend/recursive_parser/parsers/statement_parser.cpp**
   - `export impl` æ§‹æ–‡ã®ãƒ‘ãƒ¼ã‚¹
   - `is_exported` ãƒ•ãƒ©ã‚°ã®è¨­å®š

2. **src/backend/interpreter/core/interpreter.cpp**
   - importæ™‚ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ç™»éŒ²
   - é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç™»éŒ²

3. **src/backend/interpreter/evaluator/functions/call_impl.cpp**
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—æ™‚ã® `self` åˆæœŸåŒ–

---

## ğŸ”§ ãã®ä»–ã®æ”¹å–„

### ãƒã‚°ä¿®æ­£
1. **`<unordered_map>` ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ **
   - `ast.h` ã§ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰æ¼ã‚Œã‚’ä¿®æ­£
   - CIç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆ

2. **çµ±åˆãƒ†ã‚¹ãƒˆã®æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„**
   - è¤‡æ•°ãƒ†ã‚¹ãƒˆã§åŒã˜å‡ºåŠ›ãŒã‚ã‚‹å ´åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…æ¤œç´¢ã«å¤‰æ›´
   - ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§å‘ä¸Š

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„
1. **ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‡ºåŠ›ã®æ”¹å–„**
   - ãƒªã‚½ãƒ¼ã‚¹IDã‚’å‡ºåŠ›ã—ã¦LIFOé †åºã‚’æ˜ç¢ºåŒ–
   - ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“æ€§å‘ä¸Š

---

## ğŸ”œ v0.10.1è¨ˆç”»

### æœ€å„ªå…ˆèª²é¡Œ

1. **returnæ–‡ã§ã®è‡ªå‹•ãƒ ãƒ¼ãƒ–**ï¼ˆ1é€±é–“ï¼‰
   - Named Return Value Optimization (NRVO)
   - ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ãƒ ãƒ¼ãƒ–

2. **ãƒ ãƒ¼ãƒ–ä»£å…¥æ¼”ç®—å­**ï¼ˆ1é€±é–“ï¼‰
   - `operator=(T&&)` ã®ã‚µãƒãƒ¼ãƒˆ
   - æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ ãƒ¼ãƒ–ä»£å…¥

3. **å³è¾ºå€¤ã®è‡ªå‹•æ¤œå‡º**ï¼ˆ1é€±é–“ï¼‰
   - å¼ã®å€¤ã‚«ãƒ†ã‚´ãƒªï¼ˆlvalue/rvalueï¼‰ã®åˆ¤å®š
   - ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ãƒ ãƒ¼ãƒ–

---

## ğŸ™ è¬è¾

ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«è²¢çŒ®ã—ã¦ãã ã•ã£ãŸã™ã¹ã¦ã®æ–¹ã€…ã«æ„Ÿè¬ã—ã¾ã™ã€‚

---

### 3. ğŸ”„ returnæ–‡ç›´å‰ã®defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ

**æ¦‚è¦**: returnæ–‡å®Ÿè¡Œæ™‚ã«ã‚¹ã‚³ãƒ¼ãƒ—çµ‚äº†ã¨ã—ã¦ã€deferæ–‡ã¨ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æ­£ã—ã„é †åºã§å®Ÿè¡Œ

#### å•é¡Œï¼ˆv0.9.2ã¾ã§ï¼‰
```cb
struct Resource {
    int id;
    self(int i) { self.id = i; }
    ~self() { println("Resource destroyed", self.id); }
}

Resource create_resource() {
    Resource r(1);
    defer println("Defer statement");
    return r;  // âš ï¸ defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå®Ÿè¡Œã•ã‚Œãšã«return
}  // âŒ é–¢æ•°çµ‚äº†å¾Œã‚‚å®Ÿè¡Œã•ã‚Œãªã„

void main() {
    Resource r = create_resource();
    println("After create");
}  // ã“ã“ã§r(1)ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿

// å‡ºåŠ›ï¼ˆv0.9.2ï¼‰:
// After create
// Resource destroyed 1
```

#### æ”¹å–„ï¼ˆv0.10.0ï¼‰
```cb
Resource create_resource() {
    Resource r(1);
    defer println("Defer statement");
    return r;  // âœ… returnå‰ã«defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ
}

void main() {
    Resource r = create_resource();
    println("After create");
}

// å‡ºåŠ›ï¼ˆv0.10.0ï¼‰:
// Defer statement      â† âœ… returnå‰ã«å®Ÿè¡Œï¼ˆLIFOé †ï¼‰
// Resource destroyed 1 â† âœ… deferã®å¾Œã«ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ
// After create
// Resource destroyed 1 â† é–¢æ•°çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
```

#### å®Ÿè¡Œé †åºã®ä¿è¨¼
1. **deferæ–‡ã®å®Ÿè¡Œ**ï¼ˆLIFOé †ï¼‰
2. **ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ**ï¼ˆLIFOé †ï¼‰
3. **returnå€¤ã®è©•ä¾¡ã¨ã‚³ãƒ”ãƒ¼/ãƒ ãƒ¼ãƒ–**

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
```cb
void test_multiple_returns() {
    Resource r1(1);
    defer println("Defer 1");
    
    if (condition) {
        Resource r2(2);
        defer println("Defer 2");
        return;  // âœ… Defer 2 â†’ r2ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ â†’ Defer 1 â†’ r1ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    }
    
    Resource r3(3);
    defer println("Defer 3");
    return;  // âœ… Defer 3 â†’ r3ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ â†’ Defer 1 â†’ r1ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
}
```

---

### 4. ï¿½ implæ§‹æ–‡ã®export/importå¯¾å¿œ

**æ¦‚è¦**: æ§‹é€ ä½“ã®ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ï¼ˆimplï¼‰ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§å…±æœ‰å¯èƒ½ã«

#### exportæ©Ÿèƒ½
```cb
// module_a.cb
export struct Point {
    int x;
    int y;
}

// âœ… ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®export
export impl Point {
    self(int px, int py) {
        self.x = px;
        self.y = py;
    }
}

// âœ… ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã®export
interface Printable {
    void print();
}

export impl Printable for Point {
    void print() {
        println("Point(", self.x, ", ", self.y, ")");
    }
}
```

#### importæ©Ÿèƒ½
```cb
// main.cb
import "module_a.cb";

void main() {
    // âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½¿ç”¨
    Point p(10, 20);
    
    // âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã‚’ä½¿ç”¨
    p.print();  // Point(10, 20)
}
```

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
- impl export/import: 7å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®export/import
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ã®export/import
- è¤‡æ•°implãƒ–ãƒ­ãƒƒã‚¯ã®export

---

## ğŸ”§ ãã®ä»–ã®æ”¹å–„

### ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‡ºåŠ›ã®æ”¹å–„
ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ãƒ‡ãƒãƒƒã‚°ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã€å‡ºåŠ›ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è¿½åŠ :
```cb
struct Resource {
    int id;
    ~self() {
        println("Resource destroyed", self.id);  // IDã‚’å‡ºåŠ›
    }
}
```

### CIãƒ“ãƒ«ãƒ‰ã®ä¿®æ­£
- `src/common/ast.h`: `<unordered_map>`ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰è¿½åŠ 
- `tests/integration/defer/test_defer.hpp`: ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…æ¤œç´¢ã®æ”¹å–„

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµ±è¨ˆ

### çµ±åˆãƒ†ã‚¹ãƒˆ
- **ç·ãƒ†ã‚¹ãƒˆæ•°**: 2924å€‹ (v0.9.2: 2798å€‹)
- **æ–°è¦è¿½åŠ **: 126å€‹
  - defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿: 131å€‹
  - impl export/import: 7å€‹
- **ãƒ†ã‚¹ãƒˆæˆåŠŸç‡**: 100%

### Deferé–¢é€£ãƒ†ã‚¹ãƒˆå†…è¨³
- åŸºæœ¬çš„ãªdefer: 10å€‹
- ãƒã‚¹ãƒˆã—ãŸdefer: 15å€‹
- returnå‰ã®defer: 45å€‹
- defer + ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿: 31å€‹
- è¤‡æ•°returnçµŒè·¯: 30å€‹

---

## ï¿½ğŸ“ å¤‰æ›´å±¥æ­´

### ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆ
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 18å€‹ (v0.9.2æ¯”: +6å€‹)
- **è¿½åŠ è¡Œæ•°**: +1250è¡Œ
- **å‰Šé™¤è¡Œæ•°**: -80è¡Œ
- **ç´”å¢—**: +1170è¡Œ

### ä¸»è¦ãªã‚³ãƒŸãƒƒãƒˆ
- `feat: å³è¾ºå€¤å‚ç…§(T&&)æ§‹æ–‡ã®ãƒ‘ãƒ¼ã‚¹å®Ÿè£…`
- `feat: move()é–¢æ•°ã®çµ„ã¿è¾¼ã¿å®Ÿè£…`
- `feat: ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®æ¤œå‡ºã¨å‘¼ã³å‡ºã—`
- `feat: ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®è‡ªå‹•å‰Šé™¤`
- `feat: ãƒã‚¹ãƒˆæ§‹é€ ä½“å€¤ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿`
- `feat: returnå‰ã®defer/ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œ`
- `feat: implæ§‹æ–‡ã®export/importå¯¾å¿œ`
- `fix: CIãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆunordered_mapã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ï¼‰`
- `test: ãƒ ãƒ¼ãƒ–ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ5å€‹è¿½åŠ `
- `test: deferçµ±åˆãƒ†ã‚¹ãƒˆ131å€‹è¿½åŠ `
- `test: impl export/import ãƒ†ã‚¹ãƒˆ7å€‹è¿½åŠ `
- `docs: æ‰€æœ‰æ¨©ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ`

---

**ãƒªãƒªãƒ¼ã‚¹æ‰¿èª**: shadowlink0122  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: AI Assistant  
**æ—¥ä»˜**: 2025å¹´10æœˆ12æ—¥
