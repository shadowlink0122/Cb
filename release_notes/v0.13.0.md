# Cb言語 v0.13.0 リリースノート

**リリース日**: 2025-11-13（予定）
**ステータス**: 開発中

## 概要

v0.13.0では、**開発者体験の向上**と**外部ライブラリとの統合**に焦点を当てた機能を提供します。

## 🆕 新機能

### 1. VSCode拡張機能 ✨

**Cb Language Support for VSCode**が正式リリースされました！

#### 主要機能

**✅ フルシンタックスハイライト**
- すべてのキーワード（`if`, `for`, `while`, `match`, `defer`, `async`, `await`等）
- 型定義（`struct`, `enum`, `interface`, `typedef`, `union`）
- 型修飾子（`const`, `static`, `private`, `unsigned`）
- プリミティブ型（`int`, `long`, `float`, `double`, `string`, `bool`等）

**✅ 高度なシンタックス対応**
```cb
// 文字列補間のハイライト
string msg = "Hello, {name}! Result: {x + y}";

// ジェネリクスのハイライト
Vec<int> numbers;
Option<Result<int, string>> result;

// Async/Awaitのハイライト
async int compute() {
    yield;
    return 42;
}
```

**✅ コメント対応**
```cb
// 単一行コメント

/*
 * 複数行コメント
 * ブロックコメント対応
 */
```

**✅ エディタ機能**
- 自動括弧閉じ（`{}`, `[]`, `()`, `""`, `''`）
- スマートインデント
- コード折りたたみ（regionマーカー対応）
- コメントトグル（Ctrl+/）

**✅ Cbファイルアイコン**
- `.cb`ファイル専用のカスタムアイコン
- ファイルエクスプローラーで視認性向上

#### インストール方法

```bash
# VSIXファイルからインストール
code --install-extension vscode-extension/cb-language-0.13.0.vsix
```

または、VSCode拡張機能マーケットプレイスで「Cb Language」を検索（公開後）

#### サポート対象

- VSCode 1.80.0以上
- すべてのプラットフォーム（Windows, macOS, Linux）

---

### 2. FFI (Foreign Function Interface) 🔗

外部のC/C++/Rust/Zig等のライブラリを簡単に呼び出せるようになりました。

#### 基本構文

```cb
// 外部モジュールの宣言
use foreign.math {
    int add(int a, int b);
    double sqrt(double x);
    void* malloc(int size);
}

void main() {
    int result = math.add(10, 20);
    double s = math.sqrt(16.0);
    println(result, s);  // 30 4.0
}
```

#### 対応言語

| 言語 | 対応 | 必要な設定 |
|------|------|-----------|
| **C** | ✅ | そのまま使える |
| **C++** | ✅ | `extern "C"` が必要 |
| **Rust** | ✅ | `#[no_mangle]` + `extern "C"` |
| **Zig** | ✅ | `export fn` で自動対応 |
| **Go** | ✅ | `//export` コメント |
| **Assembly** | ✅ | C ABIに準拠 |

**原則**: C ABIを公開できる任意の言語に対応

#### 使用例：Rustライブラリの呼び出し

**Rust側**（lib.rs）:
```rust
#[no_mangle]
pub extern "C" fn factorial(n: i32) -> i64 {
    (1..=n as i64).product()
}
```

**Cb側**:
```cb
use foreign.math {
    long factorial(int n);
}

void main() {
    long fact = math.factorial(10);
    println(fact);  // 3628800
}
```

#### 対応ファイル形式

- `.so` (Linux)
- `.dylib` (macOS)
- `.dll` (Windows)
- `.cbf` (Cb Foreign定義ファイル・型情報)

---

### 3. プリプロセッサ 📋

C/C++スタイルのプリプロセッサディレクティブをサポート。

#### サポートするディレクティブ

```cb
#define DEBUG                    // マクロ定義
#define MAX_BUFFER_SIZE 1024     // 定数定義
#define VERSION "0.13.0"         // 文字列定数

#ifdef DEBUG                     // 条件チェック
    void log(string msg) {
        println("[DEBUG]", msg);
    }
#else
    void log(string msg) { }
#endif

#ifndef MAX_SIZE                 // 未定義チェック
    #define MAX_SIZE 256
#endif

#undef DEBUG                     // マクロ削除

#error "This is an error"        // コンパイルエラー
#warning "This is a warning"     // 警告
```

#### 複数条件分岐

```cb
#ifdef OS_LINUX
    #define PLATFORM "Linux"
#elseif OS_MACOS
    #define PLATFORM "macOS"
#elseif OS_WINDOWS
    #define PLATFORM "Windows"
#else
    #error "Unknown platform"
#endif
```

**注**: `#elif`ではなく`#elseif`を採用（より明確）

#### 組み込みマクロ

```cb
void main() {
    println("File:", __FILE__);       // ファイル名
    println("Line:", __LINE__);       // 行番号
    println("Date:", __DATE__);       // コンパイル日付
    println("Time:", __TIME__);       // コンパイル時刻
    println("Version:", __VERSION__); // Cbバージョン
}
```

---

### 4. C風マクロ 🔧

シンプルで理解しやすいC風のマクロシステム。

#### 定数マクロ

```cb
#define PI 3.14159265359
#define MAX_BUFFER_SIZE 1024
#define APP_NAME "MyApp"

void main() {
    double area = PI * r * r;
    int buffer[MAX_BUFFER_SIZE];
    println(APP_NAME, "started");
}
```

#### 関数マクロ

```cb
#define MAX(a, b) ((a) > (b) ? (a) : (b))
#define MIN(a, b) ((a) < (b) ? (a) : (b))
#define SQUARE(x) ((x) * (x))

void main() {
    int max_val = MAX(10, 20);  // 20
    int sq = SQUARE(5);         // 25
}
```

#### 複数行マクロ

```cb
#define DEBUG_PRINT(msg) \
    do { \
        println("[DEBUG]", __FILE__, ":", __LINE__, ":", msg); \
    } while(0)

void main() {
    DEBUG_PRINT("Application started");
    // 出力: [DEBUG] main.cb : 10 : Application started
}
```

#### 可変長引数マクロ

```cb
#define LOG(level, ...) \
    println("[" + level + "]", __VA_ARGS__)

void main() {
    LOG("INFO", "Server started on port", 8080);
    LOG("ERROR", "Connection failed:", "timeout");
}
```

---

## 🔄 改善

### 1. コメント機能の拡張

**複数行コメント（ブロックコメント）**が正式にサポートされました：

```cb
/*
 * これはブロックコメントです
 * 複数行にわたってコメントを書けます
 */

void main() {
    int x = 10;  // 単一行コメント

    /* インライン /* ネスト不可 */ コメント */
}
```

**VSCode拡張機能と連携**:
- `Ctrl+/` (Cmd+/) で単一行コメントのトグル
- `Shift+Alt+A` でブロックコメントのトグル

---

## 📊 テスト

### 統合テスト

- **v0.12.1**: 740+個のテスト（100%成功）
- **v0.13.0**: テスト追加予定
  - FFIテスト: 50個以上
  - プリプロセッサテスト: 30個以上
  - マクロテスト: 20個以上

---

## 🚫 実装しない機能（明確化）

### インラインアセンブリ (`asm("")`)

**理由**: インタプリタでは技術的に困難

**代替手段**: FFI経由でアセンブリを含むC/C++ライブラリを使用

**将来**: v1.0.0（ネイティブコンパイラ）で再検討

### インラインC++ (`cpp("")`)

**理由**: 動的コンパイルのオーバーヘッドが大きい

**代替手段**: FFI経由でC++ライブラリを使用

### Rust風マクロ (`macro_rules!`)

**理由**: 複雑すぎて学習コストが高い

**代替手段**:
- 既存のジェネリクス（v0.11.0で実装済み）
- C風マクロ（v0.13.0）
- inline関数（将来）
- constexpr（将来）

---

## 🗺️ ロードマップ

### v0.13.0（現在）
- ✅ VSCode拡張機能
- 🚧 FFI (Foreign Function Interface)
- 🚧 プリプロセッサ
- 🚧 C風マクロ

### v0.14.0 - v0.20.0（将来）
- inline関数
- constexpr
- 標準ライブラリの拡充

### v1.0.0（長期目標）
- ネイティブコンパイラ
- インラインアセンブリ
- 実行ファイル生成

**注**: JITコンパイラは実装しない（複雑すぎる）

---

## 🔧 技術詳細

### FFIの実装方式

**オブジェクトファイル方式**を採用:
- モジュール名で指定（`use foreign.math`）
- プラットフォーム差異を自動吸収（.so/.dylib/.dll）
- 既存のimport構文と一貫性がある

### プリプロセッサの実装

**処理フロー**:
```
ソースコード (.cb)
    ↓
プリプロセッサ（マクロ展開、条件付きコンパイル）
    ↓
パーサー（AST生成）
    ↓
インタプリタ（実行）
```

---

## 📚 ドキュメント

### 新規ドキュメント

- `docs/todo/v0.13.0/README.md` - v0.13.0実装計画
- `docs/todo/v0.13.0/version_roadmap.md` - バージョン戦略
- `docs/todo/v0.13.0/modern_ffi_macro_design.md` - FFI/マクロ設計
- `docs/todo/v0.13.0/inline_asm_cpp_feasibility.md` - 技術調査

### VSCode拡張機能ドキュメント

- `vscode-extension/README.md` - 拡張機能の使い方
- `vscode-extension/CHANGELOG.md` - 変更履歴

---

## 🎉 まとめ

v0.13.0は、以下の3つの柱で**開発者体験**と**実用性**を大幅に向上させます：

1. **VSCode拡張機能** - コードの読み書きが快適に
2. **FFI** - 既存のライブラリ資産を活用可能
3. **プリプロセッサ/マクロ** - 柔軟なコード生成

### インストール方法

#### Cbインタプリタ

```bash
git clone https://github.com/shadowlink0122/Cb.git
cd Cb
make
```

#### VSCode拡張機能

```bash
code --install-extension vscode-extension/cb-language-0.13.0.vsix
```

### 次のステップ

- FFI/プリプロセッサ/マクロの実装完了
- 統合テストの追加
- ドキュメントの充実
- VSCode拡張機能のマーケットプレイス公開

---

**Cb言語 v0.13.0 - 開発者体験の向上と外部連携の強化**

🎨 **VSCode拡張機能で快適な開発環境**
🔗 **FFIで既存ライブラリを活用**
📋 **プリプロセッサで柔軟なコード生成**
