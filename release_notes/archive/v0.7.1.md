# Cb言語 v0.7.1 リリースノート

## 🎉 メジャー機能追加: 多次元配列戻り値処理の完全対応

**リリース日**: 2025年9月29日  
**バージョン**: v0.7.1  
**テスト成功率**: 100% (1116/1116 テスト成功)

---

## ✨ 主な新機能

### 🔧 多次元配列戻り値処理の完全実装

typedef配列関数からの多次元配列戻り値が完全にサポートされました。

#### 修正前の問題
```cb
typedef Matrix2D = int[2][2];

Matrix2D create_matrix() {
    Matrix2D result;
    result[0][0] = 1; result[0][1] = 2;
    result[1][0] = 3; result[1][1] = 4;
    return result;
}

int main() {
    Matrix2D matrix = create_matrix();
    // 修正前: 以下で境界エラーが発生
    printf("Row 1: [%d, %d]", matrix[1][0], matrix[1][1]);
    //     ^^^^^^^^^^^^^^^^
    //     Error: Array index out of bounds: flat_index=2
    return 0;
}
```

#### 修正後の動作
```cb
typedef Matrix2D = int[2][2];

Matrix2D create_matrix() {
    Matrix2D result;
    result[0][0] = 1; result[0][1] = 2;
    result[1][0] = 3; result[1][1] = 4;
    return result;
}

int main() {
    Matrix2D matrix = create_matrix();
    printf("Matrix (2x2):\n");
    printf("Row 0: [%d, %d]\n", matrix[0][0], matrix[0][1]);
    printf("Row 1: [%d, %d]\n", matrix[1][0], matrix[1][1]);
    
    // 出力:
    // Matrix (2x2):
    // Row 0: [1, 2]
    // Row 1: [3, 4]  ← 修正により正常動作
    
    return 0;
}
```

---

## 🔧 技術的改善

### 1. Variable Manager改善
**ファイル**: `src/backend/interpreter/managers/variable_manager.cpp`

**問題**: 配列戻り値処理で`ret.int_array_3d[0][0]`として1次元配列のみを処理
```cpp
// 修正前
if (!ret.int_array_3d.empty() && !ret.int_array_3d[0].empty() && 
    !ret.int_array_3d[0][0].empty()) {
    var.array_values = ret.int_array_3d[0][0];  // 1次元のみ
    var.array_size = var.array_values.size();
}
```

**解決**: 多次元配列の全要素を展開して`multidim_array_values`に設定
```cpp
// 修正後
std::string actual_type = interpreter_->type_manager_->resolve_typedef(ret.array_type_name);
bool is_multidim = (actual_type.find("[][]") != std::string::npos || 
                   ret.array_type_name.find("[][]") != std::string::npos ||
                   ret.int_array_3d.size() > 1 || 
                   (ret.int_array_3d.size() == 1 && ret.int_array_3d[0].size() > 1));

if (is_multidim) {
    // 多次元配列の場合 - 全要素を展開
    var.multidim_array_values.clear();
    for (const auto &plane : ret.int_array_3d) {
        for (const auto &row : plane) {
            for (const auto &element : row) {
                var.multidim_array_values.push_back(element);
            }
        }
    }
    var.array_size = var.multidim_array_values.size();
    var.is_multidimensional = true;
    
    // 配列の次元情報を設定
    if (!ret.int_array_3d[0].empty()) {
        var.array_dimensions.clear();
        var.array_dimensions.push_back(ret.int_array_3d[0].size());     // 行数
        var.array_dimensions.push_back(ret.int_array_3d[0][0].size()); // 列数
    }
}
```

### 2. Statement Executor強化
**ファイル**: `src/backend/interpreter/executor/statement_executor.cpp`

**追加機能**: ReturnException処理で多次元配列判定・次元情報設定を実装
```cpp
// 多次元配列かどうかを判定（typedef配列名に[][]が含まれる場合）
bool is_multidim = (ret.array_type_name.find("[][]") != std::string::npos);
if (is_multidim) {
    // 多次元配列の場合は全要素を展開してmultidim_array_valuesに設定
    target_var.multidim_array_values.clear();
    for (const auto &plane : ret.int_array_3d) {
        for (const auto &row : plane) {
            for (const auto &element : row) {
                target_var.multidim_array_values.push_back(element);
            }
        }
    }
    // 配列の次元情報も設定（2D配列の場合）
    target_var.is_multidimensional = true;
    target_var.array_size = target_var.multidim_array_values.size();
    target_var.array_values.clear(); // 1次元配列はクリア
    
    // 2次元配列の次元情報を設定
    if (!ret.int_array_3d.empty() && !ret.int_array_3d[0].empty()) {
        target_var.array_dimensions.clear();
        target_var.array_dimensions.push_back(ret.int_array_3d[0].size());     // 行数
        target_var.array_dimensions.push_back(ret.int_array_3d[0][0].size()); // 列数
    }
}
```

### 3. Array Manager境界チェック改善
**ファイル**: `src/backend/interpreter/managers/array_manager.cpp`

**問題**: デバッグ出力が標準エラーに出力されていた
**解決**: 構造化されたデバッグシステムに移行、境界チェックロジックを簡素化

---

## 📊 テスト結果

### テスト統計
- **総テスト数**: 1116テスト（統合: 1116, 単体: 26）
- **成功率**: 100% (1116/1116 テスト成功)
- **新規テスト**: Function Type Check Tests（複雑なtypedef配列関数）
- **修正されたテストカテゴリ**:
  - ✅ Array Return Tests: 文字列配列戻り値
  - ✅ Printf Tests: デバッグ出力クリーンアップ
  - ✅ Global/Static Variable Tests: TEMP_DEBUG_VAR出力除去
  - ✅ **Function Type Check Tests**: typedef多次元配列戻り値（今回の主要修正）

### パフォーマンス
```
=== Test Summary ===
Total:  1116
Passed: 1116
Failed: 0

🎉 ALL TESTS PASSED! 🎉

============================================================
=== Timing Summary ===
Tests with timing: 39
Total time: 563.97 ms
Average time: 14.46 ms
Min time: 7.38 ms
Max time: 198.53 ms
```

---

## 🔍 技術的詳細

### 多次元配列戻り値処理フロー
1. **関数実行**: `create_matrix()`等のtypedef配列関数を実行
2. **ReturnException生成**: `int_array_3d`に多次元配列データを格納
3. **Variable Manager処理**: 
   - typedef名解決による多次元配列判定
   - `int_array_3d`構造からの多次元判定
   - 全要素を`multidim_array_values`に展開
   - `array_dimensions`に次元情報設定
4. **Array Manager**: 境界チェック時に`multidim_array_values`を使用
5. **OutputManager**: printf等での多次元配列要素アクセス

### 対応する型定義パターン
```cb
// すべて正常に処理される
typedef Matrix2D = int[2][2];           // 2次元配列
typedef Matrix3D = int[2][2][2];        // 3次元配列
typedef StringMatrix = string[3][4];    // 文字列2次元配列
typedef LargeMatrix = int[10][20];      // 大きな2次元配列
```

---

## 🚧 互換性情報

### 下位互換性
- **完全下位互換**: 既存のコードは変更不要
- **影響なし**: 1次元配列、基本型、Union型等の既存機能

### 新機能の恩恵を受けるコード
```cb
// これらのパターンが修正の恩恵を受ける
typedef Matrix2D = int[2][2];
Matrix2D create_matrix() { /* ... */ }
int main() {
    Matrix2D m = create_matrix();  // 修正前: 境界エラー → 修正後: 正常動作
    printf("%d", m[1][1]);         // 修正前: エラー → 修正後: 正常動作
}
```

---

## 📚 実装事例

### 行列演算システム
```cb
typedef Matrix3x3 = int[3][3];

Matrix3x3 create_identity() {
    Matrix3x3 result;
    for (int i = 0; i < 3; i++) {
        for (int j = 0; j < 3; j++) {
            result[i][j] = (i == j) ? 1 : 0;
        }
    }
    return result;
}

Matrix3x3 matrix_multiply(Matrix3x3 a, Matrix3x3 b) {
    Matrix3x3 result;
    for (int i = 0; i < 3; i++) {
        for (int j = 0; j < 3; j++) {
            result[i][j] = 0;
            for (int k = 0; k < 3; k++) {
                result[i][j] += a[i][k] * b[k][j];
            }
        }
    }
    return result;
}

int main() {
    Matrix3x3 identity = create_identity();
    Matrix3x3 matrix = {{1, 2, 3}, {4, 5, 6}, {7, 8, 9}};
    Matrix3x3 result = matrix_multiply(matrix, identity);
    
    // すべて正常に動作（修正前はここで境界エラー）
    for (int i = 0; i < 3; i++) {
        for (int j = 0; j < 3; j++) {
            printf("%d ", result[i][j]);
        }
        println("");
    }
    
    return 0;
}
```

---

## 🔮 次期バージョンの予定

### v0.8.0 予定機能
- **浮動小数点数型**: `float`, `double`のサポート
- **enum機能拡張**: Union型との完全統合
- **標準ライブラリ拡充**: `math.cb`, `string.cb`モジュール
- **動的配列**: 可変長配列の基本実装

### 長期計画
- **interface/trait**: 抽象化機能
- **ジェネリクス**: 型パラメータ化
- **モジュールシステム**: import/export機能
- **Result型**: 安全なエラーハンドリング

---

## 🙏 謝辞

今回のリリースにより、Cb言語の多次元配列処理が大幅に改善され、より実用的なプログラムが書けるようになりました。行列計算、画像処理、科学計算等の分野での活用が期待されます。

継続的な改善にご協力いただいているコミュニティの皆様に感謝いたします。

---

**Cb言語開発チーム**  
2025年9月29日
