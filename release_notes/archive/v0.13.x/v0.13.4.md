# Cb言語 v0.13.4 リリースノート

**リリース日**: 2025年11月16日  
**ステータス**: ✅ Released

---

## 🎯 ハイライト

v0.13.4では、v0.13.3で特定された既知の問題のうち、最も重要な**文字列配列**と**Vector<string>**のサポートを実装しました。

- ✅ **文字列配列の初期化と代入** - `string[N]` 配列への代入が完全に動作
- ✅ **Vector<string>のサポート** - `Vector<string>` でpush_back/at/pop_backなどが動作
- ✅ **const文字列配列のサポート** - const修飾子が正しく機能
- ✅ **すべてのテストが成功** - 4207個の統合テスト + 単体テスト + stdlib tests

---

## 📋 主な変更点

### 1. 文字列配列の初期化と代入 🆕

**問題**（v0.13.3）:
```cb
string[3] arr;  // 宣言は成功
arr[0] = "Hello";  // ❌ セグメンテーションフォールト
```

**修正後**（v0.13.4）:
```cb
string[3] arr;  // 宣言成功
arr[0] = "Hello";  // ✅ 正常に動作
arr[1] = "World";  // ✅ 正常に動作
println("First: '{arr[0]}'");  // First: 'Hello'
```

**実装内容**:
- `simple_assignment.cpp`: 文字列配列への代入処理を追加
- 配列要素への代入時に基底型（TYPE_STRING）をチェック
- `array_strings`ベクターへの直接代入をサポート
- const修飾子のチェックを追加

**影響範囲**:
- `src/backend/interpreter/executors/assignments/simple_assignment.cpp`

---

### 2. Vector<string>のサポート 🆕

**問題**（v0.13.3）:
```cb
Vector<string> vec;
vec.push_back("Hello");  // ❌ セグメンテーションフォールト
```

**修正後**（v0.13.4）:
```cb
Vector<string> vec;
vec.push_back("Hello");  // ✅ 正常に動作
vec.push_back("World");  // ✅ 正常に動作
string first = vec.at(0);  // ✅ "Hello"
```

**実装内容**:
- `array_get<T>()`ビルトイン関数に文字列型のサポートを追加
- `array_set<T>()`ビルトイン関数に文字列のdeep copyを実装
- メモリレイアウト: `char*`ポインタの配列として扱う
- 文字列の自動deep copy: `malloc()`で新しいメモリを確保してコピー
- 既存文字列の自動解放: 上書き時に古い文字列を`free()`

**技術的詳細**:
```cpp
// array_get<string>の実装
char **arr = reinterpret_cast<char **>(ptr_value);
char *str = arr[index];
return std::string(str);  // char*をstd::stringに変換

// array_set<string>の実装
char *str_copy = (char*)malloc(str_value.size() + 1);
strcpy(str_copy, str_value.c_str());
if (arr[index] != nullptr) {
    free(arr[index]);  // 既存の文字列を解放
}
arr[index] = str_copy;  // 新しい文字列を設定
```

**影響範囲**:
- `src/backend/interpreter/evaluator/functions/call_impl.cpp`

---

## 📊 テスト統計

### テスト実行結果
- **総テスト数**: 4207個の統合テスト + 単体テスト + stdlib tests
- **成功率**: **100%** ✅
- **テストスイート**: 4/4 パス

### テストカバレッジ
- Integration tests: ✅ 4207 tests passed
- Unit tests: ✅ All tests passed
- Stdlib C++ tests: ✅ All tests passed
- Stdlib Cb tests: ✅ 33 tests passed (5 suites)

### 新規テストケース
- ✅ `tests/cases/v0.13.3/test_simple_string_array.cb` - 文字列配列の基本操作
- ✅ `/tmp/test_string_array_literal.cb` - リテラルからの初期化
- ✅ `/tmp/test_vector_string_simple.cb` - Vector<string>の基本操作
- ✅ `/tmp/test_vector_string_advanced.cb` - Vector<string>の高度な操作
- ✅ `tests/cases/const_array/const_string_array_assign_error.cb` - const文字列配列

---

## 🐛 修正されたバグ

### 1. 文字列配列の初期化問題
- **状態**: ✅ 修正完了
- **根本原因**: 配列要素への代入時に文字列型が考慮されていなかった
- **修正方法**: 基底型チェックを追加し、文字列配列への代入処理を実装

### 2. Vector<string>のセグメンテーションフォールト
- **状態**: ✅ 修正完了
- **根本原因**: `array_get/set<T>()`ビルトイン関数が文字列のdeep copyを行っていなかった
- **修正方法**: 文字列型の場合に`malloc`でメモリを確保し、`strcpy`でコピー

---

## ⚠️ 既知の問題（v0.13.4で未修正）

以下の問題は将来のバージョンで修正予定です：

### 3. ジェネリック構造体配列
**問題**:
```cb
Future<int>[3] futures;
futures[0] = compute(10);
int r = await futures[0];  // 型情報が失われる可能性
```

**状態**: 部分的にサポート  
**計画**: v0.13.5で完全サポート予定

### 4. ネストしたmatch式
**問題**:
```cb
Option<Result<int, string>> outer = ...;
match (outer) {
    Some(inner) => {
        match (inner) {  // 型情報が失われる
            Ok(v) => { /* ... */ }
        }
    }
}
```

**状態**: 調査中  
**計画**: v0.13.5で修正予定

---

## 🔄 後方互換性

v0.13.3からv0.13.4へのアップグレードは完全に後方互換性があります：

1. 既存のコードはすべて動作します
2. 新機能（文字列配列、Vector<string>）を使用する場合のみコードを更新
3. ビルドやテストの変更は不要

**アップグレード手順**:
```bash
# 最新のソースコードを取得
git pull

# ビルド
make clean && make

# テスト実行（オプション）
make test
```

---

## 📚 ドキュメント

### 更新されたドキュメント
- `docs/todo/v0.13.4_implementation_plan.md` - v0.13.4実装計画（完了）
- `release_notes/v0.13.4.md` - このリリースノート

### サンプルコード

**文字列配列の基本操作**:
```cb
void main() {
    // 宣言と初期化
    string[3] arr;
    arr[0] = "Hello";
    arr[1] = "World";
    arr[2] = "!";
    
    // リテラルからの初期化
    string[3] arr2 = ["Apple", "Banana", "Cherry"];
    
    // アクセス
    println("arr[0]: '{arr[0]}'");  // arr[0]: 'Hello'
    println("arr2[1]: '{arr2[1]}'");  // arr2[1]: 'Banana'
}
```

**Vector<string>の基本操作**:
```cb
import stdlib.std.vector;

void main() {
    Vector<string> vec;
    
    // 要素の追加
    vec.push_back("Apple");
    vec.push_back("Banana");
    vec.push_front("Apricot");
    
    // アクセス
    string first = vec.at(0);
    println("First: '{first}'");  // First: 'Apricot'
    
    // 長さ
    long len = vec.get_length();
    println("Length: {len}");  // Length: 3
    
    // 削除
    vec.pop_back();
}
```

---

## 🎯 開発方針

v0.13.4は、v0.13.3で特定された最も重要な問題（文字列配列とVector<string>）を修正することに焦点を当てました。

これにより：
- ✅ 文字列操作の実用性が大幅に向上
- ✅ Vector<T>がすべての基本型（int, long, string, struct）をサポート
- ✅ ユーザーが回避策なしで文字列配列を使用可能

次のv0.13.5では、残りの問題（ジェネリック構造体配列、ネストmatch）の修正を予定しています。

---

## 🚀 次のステップ（v0.13.5計画）

### 優先度: 高
- [ ] ジェネリック構造体配列の完全サポート
- [ ] ネストしたmatch式の型情報保持

### 優先度: 中
- [ ] パフォーマンス最適化（文字列コピーの削減）
- [ ] エラーメッセージの改善

### 優先度: 低
- [ ] 追加のビルトイン関数
- [ ] 標準ライブラリの拡張

---

## 謝辞

Cb言語の開発にご協力いただいている全ての方々に感謝します。問題報告、フィードバック、コントリビューションをお待ちしています。

---

**リリース担当**: Cb Language Team  
**最終更新**: 2025年11月16日  
**Git Tag**: v0.13.4
