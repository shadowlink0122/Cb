# Cb Language v0.10.1 Release Notes

**Release Date**: 2025年10月25日  
**Branch**: fix/v0.10.1

---

## 📋 Overview

v0.10.1は、構造体配列のメンバーアクセスと`print`関数のフォーマット指定子に関する重要なバグ修正を含むメンテナンスリリースです。

---

## 🐛 Bug Fixes

### 1. 構造体配列のメンバーアクセス修正

**問題**:
- 構造体配列の要素（例: `Item[10] items`）へのメンバーアクセス（`items[0].id`）がエラーになる
- 関数内から構造体配列要素に代入しても値が保持されない

**原因**:
1. 構造体配列の宣言時に`is_struct`フラグが正しく設定されていなかった
2. 配列要素変数の自動作成時にローカルスコープに作成されていたため、グローバル配列への変更が反映されなかった

**修正内容**:

#### `src/backend/interpreter/managers/variables/initialization.cpp`
- `handle_array_type_info_declaration`関数で、構造体配列の場合に`is_struct`フラグを設定
```cpp
// 構造体配列の場合、is_structフラグも設定
if (node->array_type_info.base_type == TYPE_STRUCT &&
    interpreter_->find_struct_definition(stored_type_name) != nullptr) {
    var.is_struct = true;
}
```

#### `src/backend/interpreter/managers/structs/member_variables.cpp`
- `create_struct_variable`関数で、配列要素変数を親配列のスコープ（グローバル/ローカル）に正しく登録
```cpp
// 配列要素の場合、親配列のスコープに登録する
bool is_array_element = (var_name.find('[') != std::string::npos);
if (is_array_element) {
    // 親配列がグローバルなら、要素もグローバルに登録
    if (is_global) {
        interpreter_->get_global_scope().variables[var_name] = struct_var;
    } else {
        interpreter_->current_scope().variables[var_name] = struct_var;
    }
}
```

**影響**:
- 構造体配列を使用するプログラムが正しく動作するようになった
- `sample/knapsack_dp.cb`などの複雑なデータ構造を扱うサンプルが実行可能に

---

### 2. print関数のフォーマット指定子（幅指定）サポート

**問題**:
- `print("%3d", value)`のような幅指定付きフォーマット指定子が認識されず、そのまま出力されていた
- `%2d`, `%3d`, `%10s`などの幅指定が機能しない

**原因**:
- フォーマット指定子の検出処理が、`%d`, `%s`などの単純な形式のみに対応しており、間の数字（幅指定子）を考慮していなかった

**修正内容**:

#### `src/backend/interpreter/output/output_manager.cpp`

**`has_unescaped_format_specifiers`関数**:
```cpp
// 幅指定子（数字）をスキップ
size_t pos = i + 1;
while (pos < str.length() && std::isdigit(str[pos])) {
    pos++;
}

// 幅指定後の文字を確認
if (pos < str.length()) {
    char format_char = str[pos];
    if (format_char == 'd' || format_char == 's' || 
        format_char == 'c' || format_char == 'p' ||
        format_char == 'f' || format_char == '%') {
        return true;
    }
}
```

**`count_format_specifiers`関数**:
- 同様に幅指定子をスキップしてフォーマット文字を検出するように修正

**影響**:
- テーブル形式の出力など、整形された出力が可能に
- printfスタイルのフォーマット指定がより包括的にサポート

---

## ✅ Verification

### テスト結果
- **統合テスト**: 30/30 PASSED
- **ユニットテスト**: 50/50 PASSED
- **総テスト**: 80/80 PASSED ✅

### サンプルプログラム動作確認
- `sample/knapsack_dp.cb`: 正常動作（Maximum value: 143）
- 構造体配列の代入・参照が全て正しく機能

---

## 📝 Sample Code

### 構造体配列の使用例

```cb
struct Item {
    int id;
    int weight;
    int value;
};

Item[10] items;

void init_item(int idx, int weight, int value) {
    items[idx].id = idx;          // ✅ 動作
    items[idx].weight = weight;   // ✅ 動作
    items[idx].value = value;     // ✅ 動作
}

void main() {
    init_item(0, 2, 13);
    println("Item 0: weight=%d, value=%d", 
            items[0].weight, items[0].value);
}
```

### フォーマット指定子の使用例

```cb
void main() {
    print("Value: %3d", 42);    // ✅ "Value:  42"
    println("");
    
    print("  %2d", 5);          // ✅ "   5"
    println("");
    
    // テーブル形式の出力
    for (int i = 0; i < 5; i++) {
        print(" %3d", i * 10);
    }
    println("");
    // ✅ "   0  10  20  30  40"
}
```

---

## 🔄 Compatibility

### Breaking Changes
なし

### Deprecated Features
なし

### Migration Guide
既存のコードは変更なしで動作します。

---

## 📦 Files Changed

### Modified Files
- `src/backend/interpreter/managers/variables/initialization.cpp`
- `src/backend/interpreter/managers/variables/declaration.cpp`
- `src/backend/interpreter/managers/structs/member_variables.cpp`
- `src/backend/interpreter/output/output_manager.cpp`
- `sample/knapsack_dp.cb`

### New Files
なし

### Test Files
- `test_struct_array_assign.cb` (検証用)
- `test_print_format.cb` (検証用)

---

## 🎯 Known Issues

### Limitations

1. **フォーマット指定子の幅指定**
   - 検出は可能だが、実際の幅調整は`snprintf`の動作に依存
   - 一部の環境で意図した通りの幅が適用されない場合がある

2. **構造体配列の最適化**
   - 配列要素の一時変数生成により、メモリ効率が最適化されていない
   - 将来的にはより効率的な実装を検討

---

## 🚀 Next Steps (v0.10.2)

### 予定されている改善
- フォーマット指定子の完全な幅調整サポート
- 構造体配列のメモリ最適化
- 追加のフォーマット指定子（`%f`, `%lf`, `%Lf`など）のサポート強化

---

## 👥 Contributors

- @shadowlink0122

---

## 📚 Related Documentation

- [構造体配列の実装](../docs/features/struct_array_implementation.md)
- [フォーマット指定子ガイド](../docs/tutorial/printf_format_guide.md)
- [v0.10.0 Release Notes](./v0.10.0.md)

---

## 🔗 Links

- **Repository**: https://github.com/shadowlink0122/Cb
- **Branch**: fix/v0.10.1
- **Issues Fixed**: 
  - Struct array member access error
  - Print format specifier width support

---

**Full Changelog**: v0.10.0...v0.10.1
