# Cb言語 v0.13.1 リリースノート

**リリース日**: 2025年11月16日  
**ステータス**: ✅ Released

---

## 🎯 ハイライト

- **Async implメソッドの正式サポート** — Interface/Implで宣言したメソッドを`async`として定義できるようになり、`await`と`yield`を含む複雑なロジックでも`self`の状態が確実に同期されます。
- **イベントループのself同期** — 非同期タスクが完了したタイミングで、ランタイムが自動的に`self`と元のレシーバー構造体を一致させる仕組みを追加。Futureを`await`するだけで状態が反映されます。
- **Asyncテストの拡充** — `test_impl_async_method*.cb`や`test_struct_async_method_basic.cb`など、構造体メソッドを含む新しいAsyncテストを追加・通過させ、v0.13.xロードマップの要件を満たしました。
- **try/checked式の正式実装** — v0.12.1で予告されていた`try expr`と`checked expr`がResultベースで動作するようになり、実行時エラーを`RuntimeError`として安全に扱えます。

---

## 🆕 新機能 & 改善

### Async Implメソッド
- Interface定義で`async`キーワードを使用でき、`impl Interface for Struct`ブロック内で非同期メソッドを実装可能に。
- `self`を通じた読み書きがサポートされ、Futureを`await`すると元の構造体へ自動反映されます。
- asyncジェネリックimpl、Result/Option連携など従来のAsync機能ともシームレスに統合されました。

### イベントループ/ランタイム
- `AsyncTask`にレシーバー名を保持するメタデータを追加し、タスク専用スコープへ`__self_receiver__`を注入。
- タスク完了時に`self`と`self.*`変数を一括で元の構造体へ同期する`sync_async_self_receiver()`を実装。
- `yield`や複数回の`await`を含むタスクでも、`self`の最終状態が保証されます。

### インタープリタAPI
- Asyncタスクスコープ作成時に`self`とレシーバー情報を確実に伝播。`StatementExecutor`のself代入処理でレシーバーを再解決できるようになりました。
- FFIマネージャー参照をInterpreterの公開インターフェースに追加し、将来の拡張に備えています。

### エラーハンドリング
- 新しい`AST_TRY_EXPR`/`AST_CHECKED_EXPR`ノードを追加し、`try expression`と`checked expression`をパーサーから評価器まで一貫して処理。
- `try expr`は評価中に発生した`ReturnException`/`RuntimeException`を捕捉して`Result<T, RuntimeError>`へ変換。成功時は`Ok(value)`、失敗時はエラー種別に応じた`Err(RuntimeError::Variant)`を返すようになりました。
- `checked expr`は配列境界・ポインタ参照・算術演算などを強制的に安全モードで実行し、失敗時は`Result`として報告。既存コードへの影響を避けつつ、必要な箇所だけ安全性を高められます。

---

## 🐞 バグ修正

| ID | 内容 | 詳細 |
|----|------|------|
| `ASYNC-172` | async implメソッドで`self`を書き換えても`await`後に値が戻らない | イベントループが`self`の書き戻しを行っていなかった問題を修正し、`SimpleEventLoop`でタスク完了時に同期するよう変更しました。 |
| `ASYNC-173` | `yield`を含むasync implメソッドで`self`メンバーが破棄される | タスクスコープに`self`と`self.*`を丸ごと保持し、`yield`後も安全にアクセスできるようにしました。 |
| `ASYNC-174` | `self`メンバー代入時に元のレシーバーを特定できないケース | `__self_receiver__`メタ変数を導入してレシーバー名を追跡し、`StatementExecutor`が適切に同期できるようにしました。 |
| `ASYNC-176` | `tests/cases/async/test_yield_state.cb` のTest 7でASanビルドのみ累積値が0に戻る | `StatementListExecutor`と`SimpleEventLoop`がステートメント単位の再開位置を共有するようにし、forループが`yield`後に誤って同じ代入をやり直さないよう修正しました。標準/ASan両バイナリで同じ結果を返します。 |

---

## ✅ テスト

| カテゴリ | テスト | 結果 |
|----------|--------|------|
| Async Impl | `tests/cases/async/test_impl_async_method.cb` | PASS |
| Async Impl + yield | `tests/cases/async/test_impl_async_yield.cb` | PASS |
| Struct Async Method | `tests/cases/async/test_struct_async_method_basic.cb` | PASS |
| Error Handling | `tests/cases/error_handling/test_try_checked.cb` | PASS |
| Regression | `make main` / `./main tests/cases/async/test_impl_async_method.cb` | PASS |
| Regression | `./main tests/cases/async/test_yield_state.cb` / `./main-asan tests/cases/async/test_yield_state.cb` | PASS |

---

## 📚 ドキュメント

- `docs/spec.md` を **v0.13.1** に更新し、Async implメソッドとself同期の仕組みに加えて`try`/`checked`/`?`演算子と`RuntimeError`列挙型の正式仕様を追記。
- リリースノートにasync impl改善のハイライトとテスト状況、そして`try/checked`式の正式実装をまとめました。

---

## 次のステップ

- Asyncラムダ式とAsync関数型のサポートをv0.13.2以降で予定。
- `make test`ベースのフル統合テストを自動化し、さらなるリグレッション防止を行います。
