# Cb言語 v0.9.2 リリース計画

## リリース予定日
2025年2月（予定）

## 概要
v0.9.2では、v0.9.1で構築したアーキテクチャ基盤を活用し、Phase 5（メソッド実装の実際の移行）を実施します。RecursiveParserの5606行を3000行以下に削減し、各パーサーファイルへ実装を移行します。

---

## 🎯 Phase 5: メソッド実装の移行

### 目標

| 指標 | 現状（v0.9.1） | 目標（v0.9.2） | 削減率 |
|-----|---------------|---------------|--------|
| **recursive_parser.cpp** | 5606行 | 3000行以下 | **-46%** |
| **expression_parser.cpp** | 312行 | ~1000行 | +220% |
| **statement_parser.cpp** | 171行 | ~700行 | +309% |
| **declaration_parser.cpp** | 122行 | ~800行 | +555% |
| **type_parser.cpp** | 176行 | ~400行 | +127% |
| **struct_parser.cpp** | 200行 | ~600行 | +200% |
| **合計** | 6587行 | **~6500行** | **-1.3%** |

### 期待される成果

1. **保守性の向上**
   - 各ファイルが1000行以下
   - 責任の明確な分離
   - 新機能追加の容易化

2. **パフォーマンス維持**
   - 現状: 820ms
   - 目標: 800ms以下（維持または改善）

3. **テスト100%合格維持**
   - 全2380テスト合格
   - 各移行ステップでテスト実行

---

## 📋 Phase 5の詳細計画

### Phase 5-1: ExpressionParser実装移行（優先度: 最高）

**対象メソッド**: 19個

**移行順序**:

#### ステップ1: プライマリ式（最優先）
1. `parsePrimary()` - プライマリ式（リテラル、識別子等）
   - 行数: 約200行
   - 依存: なし
   - 難易度: 中

#### ステップ2: 単項・後置演算子
2. `parseUnary()` - 単項演算子
   - 行数: 約80行
   - 依存: parsePrimary, parsePostfix
   - 難易度: 中

3. `parsePostfix()` - 後置演算子
   - 行数: 約150行
   - 依存: parsePrimary
   - 難易度: 高（配列、関数呼び出し、メンバーアクセス）

#### ステップ3: 二項演算子（優先度順）
4. `parseMultiplicative()` - 乗除算（約40行）
5. `parseAdditive()` - 加減算（約40行）
6. `parseShift()` - シフト演算子（約40行）
7. `parseComparison()` - 比較演算子（約60行）
8. `parseBitwiseAnd()` - ビットAND（約30行）
9. `parseBitwiseXor()` - ビットXOR（約30行）
10. `parseBitwiseOr()` - ビットOR（約30行）
11. `parseLogicalAnd()` - 論理AND（約40行）
12. `parseLogicalOr()` - 論理OR（約40行）

#### ステップ4: 三項演算子
13. `parseTernary()` - 三項演算子
   - 行数: 約50行
   - 依存: parseLogicalOr
   - 難易度: 中

#### ステップ5: 代入演算子
14. `parseAssignment()` - 代入演算子
   - 行数: 約100行
   - 依存: parseTernary
   - 難易度: 高（複合代入、配列要素への代入）

#### ステップ6: エントリーポイント
15. `parseExpression()` - エントリーポイント
   - 行数: 約20行
   - 依存: parseAssignment
   - 難易度: 低

#### ステップ7: リテラル
16. `parseArrayLiteral()` - 配列リテラル（約60行）
17. `parseStructLiteral()` - 構造体リテラル（約80行）

#### ステップ8: メンバーアクセス
18. `parseMemberAccess()` - ドット演算子（約40行）
19. `parseArrowAccess()` - アロー演算子（約40行）

**期待される削減**: recursive_parser.cppから約800-1000行削減

---

### Phase 5-2: StatementParser実装移行（優先度: 高）

**対象メソッド**: 11個

**移行順序**:

#### ステップ1: 基本メソッド
1. `parseStatement()` - 文解析エントリーポイント（約100行）
2. `parseCompoundStatement()` - ブロック文（約80行）

#### ステップ2: 制御構造
3. `parseIfStatement()` - if文（約60行）
4. `parseWhileStatement()` - while文（約50行）
5. `parseForStatement()` - for文（約120行）

#### ステップ3: ジャンプ文
6. `parseReturnStatement()` - return文（約40行）
7. `parseBreakStatement()` - break文（約20行）
8. `parseContinueStatement()` - continue文（約20行）

#### ステップ4: その他
9. `parseAssertStatement()` - assert文（約30行）
10. `parsePrintlnStatement()` - println文（約60行）
11. `parsePrintStatement()` - print文（約120行）

**期待される削減**: recursive_parser.cppから約500-700行削減

---

### Phase 5-3: DeclarationParser実装移行（優先度: 中）

**対象メソッド**: 6個

**移行順序**:

1. `parseVariableDeclaration()` - 変数宣言（約200行）
2. `parseTypedefVariableDeclaration()` - typedef変数（約100行）
3. `parseFunctionDeclaration()` - 関数宣言（約150行）
4. `parseFunctionDeclarationAfterName()` - 関数宣言（後半）（約100行）
5. `parseTypedefDeclaration()` - typedef宣言（約100行）
6. `parseFunctionPointerTypedefDeclaration()` - 関数ポインタtypedef（約150行）

**期待される削減**: recursive_parser.cppから約600-800行削減

---

### Phase 5-4: TypeParser実装移行（優先度: 中）

**対象メソッド**: 7個

**移行順序**:

1. `parseType()` - 型解析（約150行）
2. `resolveParsedTypeInfo()` - 型解決（約50行）
3. `resolveArrayType()` - 配列型解決（約40行）
4. `getPointerLevel()` - ポインタレベル取得（約20行）
5. `isValidType()` - 型検証（約30行）
6. `isStructType()` - 構造体型チェック（約20行）
7. `isEnumType()` - enum型チェック（約20行）

**期待される削減**: recursive_parser.cppから約300-400行削減

---

### Phase 5-5: StructParser実装移行（優先度: 低）

**対象メソッド**: 10個

**移行順序**:

1. `parseStructDeclaration()` - 構造体宣言（約150行）
2. `parseStructTypedefDeclaration()` - typedef struct（約80行）
3. `parseForwardDeclaration()` - 前方宣言（約30行）
4. `parseUnionDeclaration()` - Union宣言（約100行）
5. `parseUnionTypedefDeclaration()` - typedef union（約60行）
6. `parseEnumDeclaration()` - enum宣言（約80行）
7. `parseEnumTypedefDeclaration()` - typedef enum（約60行）
8. `parseStructMembers()` - 構造体メンバー解析（約80行）
9. `parseUnionMembers()` - Unionメンバー解析（約60行）
10. `detectCircularReference()` - 循環参照検出（約100行）

**期待される削減**: recursive_parser.cppから約500-600行削減

---

## 🔧 実装戦略

### 基本プロセス（各メソッドで繰り返し）

1. **準備**
   ```bash
   # 現在の状態を確認
   git status
   make integration-test  # 全テスト合格を確認
   ```

2. **メソッドの移行**
   - recursive_parser.cppから実装をコピー
   - expression_parser.cpp（等）にペースト
   - 内部状態アクセスを変換（`xxx` → `parser_->xxx`）
   - 他のパーサーへのアクセスを変換

3. **RecursiveParserの更新**
   ```cpp
   // recursive_parser.cpp
   ASTNode* RecursiveParser::parseXXX() {
       return xxx_parser_->parseXXX();  // 委譲に変更
   }
   ```

4. **ビルドとテスト**
   ```bash
   make clean
   make -j4
   make integration-test
   ```

5. **コミット**
   ```bash
   git add -A
   git commit -m "Phase 5-1-1: parseXXX実装移行

   - recursive_parser.cppから約XX行削減
   - 全2380テスト合格維持
   - パフォーマンス: XXXms"
   ```

### 変換ルール

| 元のコード | 変換後のコード |
|-----------|---------------|
| `current_token_` | `parser_->current_token_` |
| `advance()` | `parser_->advance()` |
| `check(type)` | `parser_->check(type)` |
| `match(type)` | `parser_->match(type)` |
| `consume(...)` | `parser_->consume(...)` |
| `error(msg)` | `parser_->error(msg)` |
| `peek()` | `parser_->peek()` |
| `isAtEnd()` | `parser_->isAtEnd()` |
| `setLocation(...)` | `parser_->setLocation(...)` |
| `parseOtherMethod()` | 同じパーサー内: `parseOtherMethod()`<br>他のパーサー: `parser_->other_parser_->parseOtherMethod()` |

---

## 📊 マイルストーン

### マイルストーン1: Phase 5-1完了（ExpressionParser）
- **目標日**: 2025年2月初旬
- **成果**:
  - ExpressionParser: 約1000行
  - recursive_parser.cpp: 約4600行（-1000行）
  - 全2380テスト合格

### マイルストーン2: Phase 5-2完了（StatementParser）
- **目標日**: 2025年2月中旬
- **成果**:
  - StatementParser: 約700行
  - recursive_parser.cpp: 約3900行（-700行）
  - 全2380テスト合格

### マイルストーン3: Phase 5-3完了（DeclarationParser）
- **目標日**: 2025年2月下旬
- **成果**:
  - DeclarationParser: 約800行
  - recursive_parser.cpp: 約3100行（-800行）
  - 全2380テスト合格

### マイルストーン4: Phase 5-4,5完了（TypeParser, StructParser）
- **目標日**: 2025年3月初旬
- **成果**:
  - TypeParser: 約400行
  - StructParser: 約600行
  - recursive_parser.cpp: 約3000行以下（目標達成！）
  - 全2380テスト合格

---

## ✅ 成功基準

### 必須条件
- [ ] recursive_parser.cppが3000行以下
- [ ] 各パーサーファイルが1000行以下
- [ ] 全2380テスト合格（100%）
- [ ] パフォーマンス800ms以下

### 推奨条件
- [ ] コンパイル警告ゼロ
- [ ] friend宣言の削減（可能な範囲で）
- [ ] ドキュメントの更新
- [ ] リリースノートの作成

---

## 🚨 リスク管理

### 潜在的なリスク

1. **テスト失敗**
   - 確率: 中
   - 影響: 高
   - 対策: 各ステップでテスト実行、問題の早期発見

2. **パフォーマンス低下**
   - 確率: 低
   - 影響: 中
   - 対策: 各マイルストーンでパフォーマンス計測

3. **コンパイルエラー**
   - 確率: 高
   - 影響: 低
   - 対策: 変換ルールの厳密な適用、段階的な移行

4. **スケジュール遅延**
   - 確率: 中
   - 影響: 低
   - 対策: マイルストーンの柔軟な調整

---

## 📝 ドキュメント更新計画

### 更新対象

1. **release_notes/v0.9.2.md**
   - Phase 5の詳細な記録
   - 各マイルストーンの成果
   - パフォーマンス比較

2. **docs/refactoring_progress.md**
   - Phase 5の進捗記録
   - 技術的な課題と解決策
   - 学んだ教訓

3. **README.md**
   - v0.9.2の成果を反映
   - 最新のメトリクス更新

4. **docs/architecture.md**
   - Phase 5完了後のアーキテクチャ図
   - 最終的なメトリクス

---

## 🔗 関連ドキュメント

- `docs/phase5_guide.md` - Phase 5実装ガイド（詳細手順）
- `docs/refactoring_progress.md` - Phase 1-4の進捗
- `docs/architecture.md` - アーキテクチャ図
- `docs/best_practices.md` - ベストプラクティス
- `release_notes/v0.9.1.md` - v0.9.1リリースノート

---

**作成日**: 2025年1月  
**バージョン**: v0.9.2（計画）  
**ステータス**: 計画段階
