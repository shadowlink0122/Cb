// v0.12.1 Phase 2.0: ネストした関数呼び出しでの協調マルチタスク
// 関数呼び出しの各ステートメントでバックグラウンドタスクと交互実行される

async void background_task() {
    for (int i = 0; i < 8; i = i + 1) {
        println("[BG] Step {i}");
    }
    return;
}

int inner_function(int x) {
    println("  [Inner] x={x}");
    return x * 2;
}

int middle_function(int n) {
    println(" [Middle] n={n}");
    int result = inner_function(n);
    println(" [Middle] Got result={result}");
    return result + 1;
}

int outer_function(int value) {
    println("[Outer] value={value}");
    int temp = middle_function(value);
    println("[Outer] Got temp={temp}");
    return temp * 3;
}

void main() {
    println("=== Nested Function Call Fairness Test ===\n");
    
    Future<void> f = background_task();
    
    println("[Main] Calling outer_function");
    int final_result = outer_function(5);
    println("[Main] Final result: {final_result}\n");
    
    await f;
    println("[Main] Done");
}
