// test_memory_errors.cb
// メモリ管理のエラーケーステスト

struct Node {
    int value;
    Node* next;
};

// 二重削除テスト（コメントアウト - 実行時エラー）
void test_double_delete() {
    println("=== Test double delete (unsafe behavior) ===");
    
    int* ptr = new int;
    println("Allocated int* at {hex(ptr)}");
    
    delete ptr;
    println("First delete successful");
    
    // 二重削除は未定義動作
    // 実際のアプリケーションでは避けるべき
    // delete ptr; // ← これを実行するとクラッシュの可能性
    
    println("⚠️  Note: Double delete would cause undefined behavior");
    println("double delete test complete\n");
}

// ダングリングポインタアクセステスト（コメントアウト - 実行時エラー）
void test_dangling_pointer() {
    println("=== Test dangling pointer (unsafe behavior) ===");
    
    int* ptr = new int;
    println("Allocated int* at {hex(ptr)}");
    
    delete ptr;
    println("Deleted pointer");
    
    // deleteした後のポインタアクセスは未定義動作
    // 実際のアプリケーションでは避けるべき
    // int value = *ptr; // ← これを実行するとクラッシュの可能性
    
    println("⚠️  Note: Accessing dangling pointer would cause undefined behavior");
    println("dangling pointer test complete\n");
}

// メモリリーク検出テスト（ドキュメント目的）
void test_memory_leak_documentation() {
    println("=== Test memory leak (documentation) ===");
    
    // メモリリーク例（割り当てたが解放しない）
    int* leaked_ptr = new int;
    println("Allocated int* at {hex(leaked_ptr)} (intentionally not freed)");
    
    // deleteを忘れた場合、メモリリークが発生
    // 実際のアプリケーションでは必ずdeleteすべき
    
    println("⚠️  Note: Memory leak - pointer not freed");
    println("memory leak documentation test complete\n");
}

// nullポインタ削除テスト（安全な操作）
void test_null_delete() {
    println("=== Test null pointer delete (safe) ===");
    
    int* null_ptr = 0;
    println("Created null pointer: {hex(null_ptr)}");
    
    // nullポインタのdeleteは安全（何もしない）
    delete null_ptr;
    println("✅ Delete null pointer is safe (no-op)");
    
    println("null delete test complete\n");
}

// ゼロサイズ配列テスト
void test_zero_size_array() {
    println("=== Test zero size array ===");
    
    // 0サイズの配列割り当て
    int* arr = new int[0];
    println("Allocated int[0] at {hex(arr)}");
    
    // 0サイズでもポインタは有効
    if (arr != 0) {
        println("✅ Zero size array returns valid pointer");
    }
    
    delete arr;
    println("Freed zero size array");
    
    println("zero size array test complete\n");
}

// 適切なメモリ管理パターン
void test_proper_memory_management() {
    println("=== Test proper memory management pattern ===");
    
    // パターン1: 割り当て後、必ず解放
    int* ptr1 = new int;
    println("Step 1: Allocated {hex(ptr1)}");
    delete ptr1;
    println("Step 2: Freed {hex(ptr1)}");
    
    // パターン2: スコープ内で完結
    Node* node = new Node;
    println("Step 3: Allocated node at {hex(node)}");
    delete node;
    println("Step 4: Cleaned up node");
    
    // パターン3: 配列の管理
    int* arr = new int[10];
    println("Step 5: Allocated array at {hex(arr)}");
    delete arr;
    println("Step 6: Freed array");
    
    println("✅ All memory properly managed");
    println("proper memory management test complete\n");
}

// 大量割り当て・解放テスト
void test_mass_allocation() {
    println("=== Test mass allocation/deallocation ===");
    
    // 複数の割り当てを順次実行
    int* p1 = new int;
    int* p2 = new int;
    int* p3 = new int;
    int* p4 = new int;
    int* p5 = new int;
    
    println("Allocated 5 pointers:");
    println("  p1: {hex(p1)}");
    println("  p2: {hex(p2)}");
    println("  p3: {hex(p3)}");
    println("  p4: {hex(p4)}");
    println("  p5: {hex(p5)}");
    
    // 逆順で解放
    delete p5;
    delete p4;
    delete p3;
    delete p2;
    delete p1;
    
    println("✅ All 5 pointers freed successfully");
    println("mass allocation test complete\n");
}

// 異なる型の混合割り当て
void test_mixed_type_allocation() {
    println("=== Test mixed type allocation ===");
    
    int* i_ptr = new int;
    long* l_ptr = new long;
    double* d_ptr = new double;
    Node* n_ptr = new Node;
    
    println("Allocated different types:");
    println("  int*:    {hex(i_ptr)} (size: 4)");
    println("  long*:   {hex(l_ptr)} (size: 8)");
    println("  double*: {hex(d_ptr)} (size: 8)");
    println("  Node*:   {hex(n_ptr)} (size: 12)");
    
    delete i_ptr;
    delete l_ptr;
    delete d_ptr;
    delete n_ptr;
    
    println("✅ All different types freed successfully");
    println("mixed type allocation test complete\n");
}

int main() {
    println("╔════════════════════════════════════════════╗");
    println("║  Memory Management Error Cases Test      ║");
    println("╚════════════════════════════════════════════╝\n");
    
    // 安全なテスト
    test_null_delete();
    test_zero_size_array();
    test_proper_memory_management();
    test_mass_allocation();
    test_mixed_type_allocation();
    
    // ドキュメント目的のテスト（実際には実行しない）
    test_double_delete();
    test_dangling_pointer();
    test_memory_leak_documentation();
    
    println("╔════════════════════════════════════════════╗");
    println("║  All safe tests passed!                   ║");
    println("║  Unsafe patterns documented for reference ║");
    println("╚════════════════════════════════════════════╝");
    
    return 0;
}
