<section class="left-align">
  <h2>v0.13.0の実装: Result型とasync/awaitの統合</h2>
  <div style="width: 88%; margin: 0.25em auto 0">
    <h3 style="font-size: 0.75em; margin-bottom: 0.25em">技術的課題と解決策</h3>
    <div style="display: flex; gap: 0.5em; margin-bottom: 0.25em">
      <div style="flex: 1">
        <h4 style="font-size: 0.62em; margin-bottom: 0.25em">課題</h4>
        <ul style="font-size: 0.6em; line-height: 1.2; margin: 0; padding-left: 1.3em">
          <li>async関数がResult&lt;T,E&gt;を返す際、Futureでラップするとenum情報（Ok/Err）が失われる</li>
          <li>awaitした後にmatchできない</li>
          <li>型パラメータの保持が困難</li>
        </ul>
      </div>
      <div style="flex: 1">
        <h4 style="font-size: 0.62em; margin-bottom: 0.25em">解決策</h4>
        <ul style="font-size: 0.6em; line-height: 1.2; margin: 0; padding-left: 1.3em">
          <li>
            <strong>TypedValue拡張</strong>
            : variant名と型パラメータを保持
          </li>
          <li>
            <strong>evaluate_await()改善</strong>
            : enum情報を完全に保持して返却
          </li>
          <li>
            <strong>暗黙的Future化</strong>
            : async関数は自動的にFutureになるが、await時にアンラップ
          </li>
        </ul>
      </div>
    </div>
    <h3 style="font-size: 0.75em; margin-bottom: 0.25em">実装コード（C++）</h3>
    <pre
      style="font-size: 0.48em; margin: 0.3em 0; max-height: 260px; overflow-y: auto"
    ><code class="language-cpp" data-trim>
// TypedValueにenum情報を保持
struct TypedValue {
    Type type;
    std::any value;
    
    // v0.13.0で追加: enum型の情報
    bool is_enum = false;
    std::string enum_variant;        // "Ok", "Err", "Some", "None"
    std::vector&lt;Type&gt; type_params;    // &lt;int, string&gt; など
};

// evaluate_await()の実装
TypedValue Interpreter::evaluate_await(ASTNode* await_node, Scope& scope) {
    // 1. async関数を評価（暗黙的にFuture&lt;Result&lt;T,E&gt;&gt;になる）
    TypedValue future_val = evaluate(await_node->awaited_expr, scope);
    
    // 2. Futureが完了するまで待機
    while (future_val.state() == FutureState::PENDING) {
        event_loop.process_tasks();
        future_val = check_future(future_val.id());
    }
    
    // 3. ✅ Futureから値を取り出す際、enum情報を保持
    TypedValue result = future_val.get_value();
    
    // ✅ Result&lt;T,E&gt;のenum情報（Ok/Err）を保持したまま返却
    result.is_enum = true;
    result.enum_variant = future_val.inner_variant();
    result.type_params = future_val.inner_type_params();
    
    return result;
}
</code></pre>
    <p class="fragment" style="font-size: 0.58em; margin-top: 0.25em">
      <strong class="success">成果</strong>
      : async関数がResult&lt;T,E&gt;を返しても、await後にmatchでOk/Errを正しく判定できる
    </p>
  </div>
</section>
