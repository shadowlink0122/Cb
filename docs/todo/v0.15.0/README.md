# v0.17.0 標準ライブラリのライブラリ化

**バージョン**: v0.17.0
**目標**: OS依存機能の標準ライブラリ化
**期間**: 2-3ヶ月
**作成日**: 2025-11-14

---

## 概要

v0.17.0では、現在コンパイラに組み込まれているOS依存機能（`println`、`malloc`など）を標準ライブラリとして分離・パッケージ化します。これにより、以下のメリットが得られます：

1. **ポータビリティの向上**: 各OS向けの実装を独立して提供
2. **カスタマイズ性**: ユーザーが独自の実装を提供可能
3. **ベアメタル対応**: OSなし環境でも動作可能
4. **モジュール性**: 必要な機能のみをリンク可能

---

## v0.17.0の主要な変更点

### 1. OS抽象化レイヤ

OS依存機能を抽象インターフェースとして定義し、各プラットフォーム向けの実装を提供：

```
std/
├── io/           # 入出力機能
│   ├── stdio.cb  # 標準入出力（println, print等）
│   └── file.cb   # ファイルIO
├── mem/          # メモリ管理
│   ├── alloc.cb  # メモリアロケーター（malloc, free等）
│   └── ptr.cb    # ポインタ操作
├── sys/          # システムコール
│   ├── linux.cb  # Linux実装
│   ├── macos.cb  # macOS実装
│   ├── windows.cb # Windows実装
│   └── none.cb   # ベアメタル実装
└── runtime/      # ランタイムサポート
    ├── panic.cb  # パニックハンドラ
    └── start.cb  # エントリーポイント
```

### 2. FFI（Foreign Function Interface）

C言語の標準ライブラリやシステムコールを呼び出すためのFFI機能：

```cb
// C関数の宣言
extern "C" {
    void* malloc(size: usize);
    fn free(ptr: void*);
    long write(fd: int, buf: char*, count: usize);
}
```

### 3. 条件付きコンパイル

プラットフォーム固有のコードを条件分岐で記述：

```cb
#[cfg(target_os = "linux")]
long  syscall_write(fd: int, buf: char*, len: usize) {
    // Linux syscall実装
}

#[cfg(target_os = "macos")]
long  syscall_write(fd: int, buf: char*, len: usize) {
    // macOS syscall実装
}
```

### 4. モジュールシステム

標準ライブラリを階層的なモジュールとして整理：

```cb
// モジュールのインポート
use std::io::println;
use std::mem::alloc;

fn main() {
    println("Hello, World!");
}
```

---

## v0.16.0から追加が必要な機能

v0.17.0を実現するために、v0.16.0に以下の機能を追加する必要があります：

### 必須機能

1. **FFI (Foreign Function Interface)**
   - `extern "C"` 宣言
   - 呼び出し規約の指定
   - C言語との型マッピング

2. **条件付きコンパイル**
   - `#[cfg(...)]` 属性
   - プラットフォーム検出
   - 条件分岐によるコード選択

3. **モジュールシステム**
   - `mod` キーワード
   - `use` によるインポート
   - モジュールパスの解決

4. **属性システムの拡張**
   - `#[link_name = "..."]` - リンク名の指定
   - `#[link(name = "c")]` - リンクライブラリの指定
   - `#[weak]` - 弱いシンボル

### オプション機能（v0.18.0で実装可能）

5. **静的/動的リンク制御**
6. **プラグイン可能なアロケーター**
7. **カスタムパニックハンドラ**

---

## 実装スケジュール

### Month 1: v0.16.0への機能追加

- Week 1-2: FFI実装
- Week 3: 条件付きコンパイル
- Week 4: モジュールシステム基礎

### Month 2: 標準ライブラリの実装

- Week 1: 入出力ライブラリ（stdio）
- Week 2: メモリ管理ライブラリ（alloc）
- Week 3: システムコールラッパー
- Week 4: ランタイムサポート

### Month 3: プラットフォーム対応とテスト

- Week 1: Linux実装
- Week 2: macOS/Windows実装
- Week 3: ベアメタル実装
- Week 4: テストとドキュメント

---

## 関連ドキュメント

1. **[標準ライブラリ設計](./stdlib_design.md)** - 標準ライブラリの全体設計
2. **[FFI実装計画](./ffi_implementation.md)** - FFIの詳細設計
3. **[条件付きコンパイル](./conditional_compilation.md)** - 条件付きコンパイルの仕様
4. **[モジュールシステム](./module_system.md)** - モジュールシステムの設計

---

## 完了条件

v0.17.0は以下の条件を満たしたときに完了とします：

1. **機能完全性**
   - [ ] FFIが動作し、C関数を呼び出せる
   - [ ] 条件付きコンパイルが動作する
   - [ ] モジュールシステムが動作する
   - [ ] 標準ライブラリが各プラットフォームで動作する

2. **ポータビリティ**
   - [ ] Linux/macOS/Windowsで動作
   - [ ] ベアメタル環境で動作（OSなし）
   - [ ] 各プラットフォーム固有の実装が分離されている

3. **互換性**
   - [ ] 既存のv0.16.0コードが動作する（後方互換性）
   - [ ] 新しい標準ライブラリAPIが使用可能

4. **品質**
   - [ ] 全てのテストがパス
   - [ ] ドキュメントが完成
   - [ ] サンプルコードが動作

---

## 次のバージョン（v0.18.0）

v0.18.0では、エコシステムとしてのパッケージ管理機能を実装します：

- パッケージマネージャー（`cbpkg`）
- 依存関係の解決
- バージョン管理
- パッケージレジストリ
