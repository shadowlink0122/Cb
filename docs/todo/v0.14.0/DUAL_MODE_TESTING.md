# Cb Language - Dual Mode Testing Implementation

## å®Ÿè£…æ—¥
2024-11-16

## æ¦‚è¦
ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ†é›¢ã—ãŸãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## å®Ÿè£…ã•ã‚ŒãŸMakeã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

### ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

#### 1. `make integration-test-interpreter`
ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- ãƒ†ã‚¹ãƒˆå¯¾è±¡: å…¨ã¦ã®.cbãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆ1000+ãƒ†ã‚¹ãƒˆï¼‰
- å®Ÿè¡Œæ–¹æ³•: `./cb run <file>`
- æ—¢å­˜ã®test_mainãƒã‚¤ãƒŠãƒªã‚’ä½¿ç”¨

#### 2. `make integration-test-compiler`
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- ãƒ†ã‚¹ãƒˆå¯¾è±¡: åŸºæœ¬çš„ãªè¨€èªæ©Ÿèƒ½ï¼ˆç¾åœ¨4ãƒ†ã‚¹ãƒˆï¼‰
- å®Ÿè¡Œæ–¹æ³•: `./cb compile <file> -o <binary> && ./<binary>`
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: `tests/integration/run_compiler_tests.sh`

#### 3. `make integration-test`
ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã§çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- `integration-test-interpreter` ã¨ `integration-test-compiler` ã‚’é †æ¬¡å®Ÿè¡Œ

### æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ã‚¹ãƒˆ

#### 1. `make stdlib-cb-test-interpreter`
ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ã§æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/cases/stdlib/test_stdlib_all.cb`
- å®Ÿè¡Œæ–¹æ³•: `./cb run tests/cases/stdlib/test_stdlib_all.cb`

#### 2. `make stdlib-cb-test-compiler`
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/cases/stdlib/test_stdlib_all.cb`
- å®Ÿè¡Œæ–¹æ³•: `./cb compile ... && ./binary`

#### 3. `make stdlib-cb-test`
ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã§æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

### ç·åˆãƒ†ã‚¹ãƒˆ

#### 1. `make test-interpreter` (æ–°è¦)
ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ã§å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
[1/4] Integration tests (Interpreter)
[2/4] Unit tests
[3/4] Stdlib C++ tests  
[4/4] Stdlib Cb tests (Interpreter)
```

#### 2. `make test-compiler` (æ–°è¦)
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
[1/2] Integration tests (Compiler)
[2/2] Stdlib Cb tests (Compiler)
```

#### 3. `make test-all` (æ–°è¦)
**ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰**ã§å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
PHASE 1: INTERPRETER MODE
PHASE 2: COMPILER MODE
```

#### 4. `make test` (å¤‰æ›´)
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `test-all` ã‚’å®Ÿè¡Œã—ã€ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•
```bash
# ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ã®ã¿ãƒ†ã‚¹ãƒˆ
make test-interpreter

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã®ã¿ãƒ†ã‚¹ãƒˆ
make test-compiler

# ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
make test-all
# ã¾ãŸã¯
make test

# å€‹åˆ¥ã®ãƒ†ã‚¹ãƒˆ
make integration-test-interpreter
make integration-test-compiler
make stdlib-cb-test-interpreter
make stdlib-cb-test-compiler
```

## ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã®ä¾‹

### ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰
```
=============================================================
=== Final Test Summary (INTERPRETER MODE) ===
=============================================================
âœ… [1/4] Integration tests (Interpreter): PASSED
âœ… [2/4] Unit tests: PASSED
âœ… [3/4] Stdlib C++ tests: PASSED
âœ… [4/4] Stdlib Cb tests (Interpreter): PASSED
=============================================================
Test suites: 4/4 passed, 0/4 failed
Total time: 25s
=============================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ‰ All Test Suites Passed (INTERPRETER MODE)! ğŸ‰       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰
```
=============================================================
=== Final Test Summary (COMPILER MODE) ===
=============================================================
âœ… [1/2] Integration tests (Compiler): PASSED
âœ… [2/2] Stdlib Cb tests (Compiler): PASSED
=============================================================
Test suites: 2/2 passed, 0/2 failed
Total time: 35s
=============================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ‰ All Test Suites Passed (COMPILER MODE)! ğŸ‰          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰
```
=============================================================
=== COMPLETE Test Summary ===
=============================================================
âœ… Interpreter Mode: ALL PASSED
âœ… Compiler Mode: ALL PASSED
=============================================================
Total time: 60s
=============================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ‰ğŸ‰ ALL TESTS PASSED (BOTH MODES)! ğŸ‰ğŸ‰              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆçŠ¶æ³

### ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãƒ¢ãƒ¼ãƒ‰ âœ…
- **å…¨æ©Ÿèƒ½å¯¾å¿œ**: 1000+ ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
- å¯¾å¿œæ©Ÿèƒ½:
  - âœ… åŸºæœ¬æ§‹æ–‡
  - âœ… åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ï¼ˆif, loop, for, whileï¼‰
  - âœ… é–¢æ•°å®šç¾©ã¨å‘¼ã³å‡ºã—
  - âœ… æ§‹é€ ä½“ã¨ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹
  - âœ… é…åˆ—æ“ä½œ
  - âœ… éåŒæœŸå‡¦ç†ï¼ˆasync/awaitï¼‰
  - âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
  - âœ… ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆResult, Optionï¼‰
  - âœ… FFIå‘¼ã³å‡ºã—
  - âœ… æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ âš ï¸
- **åŸºæœ¬æ©Ÿèƒ½ã®ã¿å¯¾å¿œ**: 4ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
- å¯¾å¿œæ©Ÿèƒ½:
  - âœ… åŸºæœ¬æ§‹æ–‡ï¼ˆmainé–¢æ•°ï¼‰
  - âœ… ç®—è¡“æ¼”ç®—
  - âœ… printlnå‡ºåŠ›
  - âœ… ifæ–‡ï¼ˆåŸºæœ¬ï¼‰
  - â¬œ ãƒ«ãƒ¼ãƒ—ï¼ˆfor, whileï¼‰ - HIRæœªå®Ÿè£…
  - â¬œ æ§‹é€ ä½“ãƒ¡ãƒ³ãƒã‚¢ã‚¯ã‚»ã‚¹ - HIRæœªå®Ÿè£…
  - â¬œ é…åˆ—å®£è¨€ã¨ã‚¢ã‚¯ã‚»ã‚¹ - HIRæœªå®Ÿè£…
  - â¬œ é–¢æ•°é…åˆ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ - HIRæœªå®Ÿè£…
  - â¬œ éåŒæœŸå‡¦ç† - HIRæœªå®Ÿè£…
  - â¬œ ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ - HIRæœªå®Ÿè£…
  - â¬œ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚° - HIRæœªå®Ÿè£…

## HIRå®Ÿè£…ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆå¤±æ•—ã‹ã‚‰ã€ä»¥ä¸‹ã®HIRæ©Ÿèƒ½ãŒæœªå®Ÿè£…ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸï¼š

### å„ªå…ˆåº¦: é«˜
1. **For/Whileãƒ«ãƒ¼ãƒ—** - incrementå¼ã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼
2. **æ§‹é€ ä½“ãƒ¡ãƒ³ãƒã‚¢ã‚¯ã‚»ã‚¹** - ãƒ¡ãƒ³ãƒå¤‰æ•°ãŒç”Ÿæˆã•ã‚Œã¦ã„ãªã„
3. **é…åˆ—å¤‰æ•°å®£è¨€** - ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—å¤‰æ•°ãŒèªè­˜ã•ã‚Œã¦ã„ãªã„

### å„ªå…ˆåº¦: ä¸­
4. **é…åˆ—ãƒªãƒ†ãƒ©ãƒ«** - é–¢æ•°å¼•æ•°ã§ã®é…åˆ—ãƒªãƒ†ãƒ©ãƒ«
5. **å¤‰æ•°ã®æ­£ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—** - ãƒ«ãƒ¼ãƒ—å¤‰æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—å‡¦ç†

### å„ªå…ˆåº¦: ä½
6. ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å¯¾å¿œ
7. éåŒæœŸå‡¦ç†ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å¯¾å¿œ
8. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å¯¾å¿œ

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### æ–°è¦ä½œæˆ
- `tests/integration/run_compiler_tests.sh` - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `tests/integration/framework/dual_mode_test_framework.hpp` - ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- `tests/integration/dual_mode_test.cpp` - ãƒ‡ãƒ¢ç”¨ãƒ†ã‚¹ãƒˆ

### å¤‰æ›´
- `Makefile`
  - æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ : `integration-test-interpreter`, `integration-test-compiler`
  - æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ : `stdlib-cb-test-interpreter`, `stdlib-cb-test-compiler`
  - æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ : `test-interpreter`, `test-compiler`, `test-all`
  - `.PHONY` æ›´æ–°
- `tests/integration/framework/integration_test_framework.hpp`
  - `../../main` â†’ `../../cb run`
- `tests/integration/framework/integration_test_framework_v2.hpp`
  - `cb_executable_path` æ›´æ–°
  - `build_command()` ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å¯¾å¿œ

## ä½¿ç”¨ä¾‹

### é–‹ç™ºæ™‚ã®æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### 1. æ–°æ©Ÿèƒ½å®Ÿè£…æ™‚
```bash
# ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã§å‹•ä½œç¢ºèªï¼ˆé«˜é€Ÿï¼‰
make test-interpreter

# å‹•ä½œã—ãŸã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã§ã‚‚ç¢ºèª
make test-compiler
```

#### 2. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰
```bash
# ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã§å…¨ãƒ†ã‚¹ãƒˆ
make test-all
```

#### 3. ç‰¹å®šæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
```bash
# ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã®ã¿
make integration-test-interpreter

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ã¿  
make integration-test-compiler
```

## ã¾ã¨ã‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€Cbè¨€èªã¯ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

âœ… **ãƒ¢ãƒ¼ãƒ‰åˆ†é›¢**: ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãƒ†ã‚¹ãƒˆã‚’å®Œå…¨ã«åˆ†é›¢
âœ… **ä¸¦è¡Œé–‹ç™º**: ä¸¡ãƒ¢ãƒ¼ãƒ‰ã‚’ç‹¬ç«‹ã—ã¦é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆå¯èƒ½
âœ… **æ˜ç¢ºãªçŠ¶æ³æŠŠæ¡**: å„ãƒ¢ãƒ¼ãƒ‰ã®å¯¾å¿œçŠ¶æ³ãŒä¸€ç›®ã§åˆ†ã‹ã‚‹
âœ… **åŠ¹ç‡çš„ãªãƒ†ã‚¹ãƒˆ**: å¿…è¦ãªãƒ¢ãƒ¼ãƒ‰ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¢ãƒ¼ãƒ‰ã®HIRå®Ÿè£…ã‚’å®Œæˆã•ã›ã€å…¨ãƒ†ã‚¹ãƒˆãŒä¸¡ãƒ¢ãƒ¼ãƒ‰ã§æˆåŠŸã™ã‚‹ã“ã¨ã§ã™ã€‚
