# v0.16.0 改訂版ロードマップ - 複数バックエンド対応＋v0.17.0準備機能

**バージョン**: v0.16.0
**目標**: 複数バックエンド実装とv0.17.0標準ライブラリ化のための基盤構築
**期間**: 3-4ヶ月
**ステータス**: 計画中
**作成日**: 2025年11月14日

---

## 🎯 概要

v0.16.0は、Cb言語のマルチプラットフォーム対応を実現する重要なバージョンです。複数のバックエンド（Native/WASM/TypeScript）を実装し、加えて**v0.17.0での標準ライブラリ完全ライブラリ化のための必須機能**を実装します。

### 重要な変更点

**旧ロードマップからの変更**:
- 旧v0.16.0のIR部分 → **v0.15.0に移動**（前倒し実装）
- 旧v0.16.0のバックエンド部分 → **v0.16.0として残る**
- 旧v0.17.0の一部機能 → **v0.16.0に前倒し**（v0.17.0の準備）

### 主要目標

1. **ネイティブコード生成**（x86-64/ARM64）
2. **WebAssembly対応**
3. **TypeScript変換**
4. **低レイヤアプリケーション開発機能**（OS開発/組み込み）
5. **Webフロントエンド開発機能**
6. **v0.17.0準備機能**（インラインアセンブラ、条件付きコンパイル、モジュールシステム強化）

---

## 📊 v0.15.0からの変更点

### v0.15.0で達成されること

- ✅ 3層IR構造（HIR/MIR/LIR）の完全実装
- ✅ SSA形式とデータフロー解析
- ✅ IRビューワーと可視化ツール
- ✅ 基本的な最適化パス

### v0.16.0で新たに実装する機能

#### バックエンド実装
- 🆕 **ネイティブバックエンド**: x86-64/ARM64コード生成
- 🆕 **WASMバックエンド**: WebAssembly生成
- 🆕 **TypeScriptバックエンド**: TypeScript変換

#### v0.17.0準備機能（重要！）
- 🆕 **インラインアセンブラ**: システムコール直接呼び出し（v0.17.0で必須）
- 🆕 **条件付きコンパイル**: プラットフォーム別コード切り替え（v0.17.0で必須）
- 🆕 **モジュールシステム強化**: Re-export、`mod`キーワード
- 🆕 **ベアメタル実行サポート**: freestanding環境
- 🆕 **メモリマップドIO**: 組み込みシステム開発

#### Webフロントエンド機能
- 🆕 **HTML/CSS生成**: テンプレート構文
- 🆕 **コンポーネントシステム**: JSX/TSX風
- 🆕 **リアクティブ状態管理**: Redux風

---

## 📋 実装計画

### Month 1: ネイティブバックエンド＋低レイヤ機能

#### Week 1-2: ネイティブコード生成基盤

**ターゲットアーキテクチャ**:
- x86-64（Linux/macOS/Windows）
- ARM64（Apple Silicon、ARM Linux）
- ARM Cortex-M（組み込み）
- RISC-V（OS開発）

**実装タスク**:
- [ ] **LIRからネイティブコードへの変換**
  - 命令選択（Instruction Selection）
  - レジスタ割り当て（Register Allocation）
  - コード発行（Code Emission）

- [ ] **バイナリフォーマット対応**
  - ELF（Linux）
  - Mach-O（macOS）
  - PE（Windows）

- [ ] **実行ファイル生成**
  - リンカー統合
  - シンボルテーブル生成
  - 再配置情報

**テスト**:
- ユニットテスト（20個）: 命令生成、レジスタ割り当て
- 統合テスト（10個）: 実行ファイル生成と実行

---

#### Week 3: インラインアセンブラ実装（v0.17.0で必須）

**構文**:
```cb
// x86-64: システムコール（write）
export void println_linux(string s) {
    long len = strlen(s);
    asm volatile (
        "mov $1, %rax\n"       // SYS_WRITE
        "mov $1, %rdi\n"       // stdout
        "mov %0, %rsi\n"       // buffer
        "mov %1, %rdx\n"       // count
        "syscall"
        :
        : "r"(s), "r"(len)
        : "rax", "rdi", "rsi", "rdx", "r11", "rcx", "memory"
    );
}

// ARM: 割り込み制御
#[interrupt]
fn timer_handler() {
    asm volatile ("cpsie i");  // 割り込み有効化
    // 処理...
}
```

**実装タスク**:
- [ ] **パーサー拡張**
  - `asm` キーワード認識
  - `volatile` 修飾子
  - 入出力オペランド（`:` 区切り）
  - クロバーリスト（破壊レジスタ）

- [ ] **アセンブラ統合**
  - インラインアセンブリコードの挿入
  - レジスタ制約の解釈
  - アーキテクチャ別構文対応

- [ ] **安全性チェック**
  - レジスタ使用の検証
  - メモリアクセスの検証

**テスト**:
- ユニットテスト（15個）: 構文解析、コード生成
- 統合テスト（10個）: システムコール、UART出力

**v0.17.0での使用例**:
```cb
// std/sys/linux.cb でシステムコールを直接呼び出し
export long syscall_write(int fd, char* buf, long len) {
    long result;
    asm volatile (
        "mov $1, %rax\n"
        "mov %0, %rdi\n"
        "mov %1, %rsi\n"
        "mov %2, %rdx\n"
        "syscall"
        : "=r"(result)
        : "r"(fd), "r"(buf), "r"(len)
        : "rax", "rdi", "rsi", "rdx", "r11", "rcx", "memory"
    );
    return result;
}
```

---

#### Week 4: ベアメタル実行サポート

**機能**:
- カスタムエントリーポイント（`_start`等）
- カスタムメモリレイアウト
- リンカースクリプト生成
- 起動コード自動生成

**実装例**:
```cb
// ベアメタルエントリーポイント
#[no_mangle]
#[entry_point]
fn _start() -> ! {
    init_bss();
    init_data();
    main();
    loop {}  // 無限ループ
}

// カスタムメモリレイアウト
#[link_section = ".text.boot"]
fn boot_code() {
    // ブート時に最初に実行されるコード
}
```

**リンカースクリプト生成**:
```bash
./main firmware.cb \
    --target=arm-none-eabi \
    --ram-start=0x20000000 \
    --ram-size=128K \
    --flash-start=0x08000000 \
    --flash-size=512K \
    --emit-linker-script=firmware.ld
```

**テスト**:
- ユニットテスト（10個）: リンカースクリプト生成
- 統合テスト（5個）: QEMUでの実行テスト

---

### Month 2: 条件付きコンパイル実装（v0.17.0で必須）

#### Week 1-2: 条件付きコンパイル基盤

**構文**:
```cb
#[cfg(target_os = "linux")]
export void platform_specific() {
    // Linux固有の実装
}

#[cfg(target_os = "windows")]
export void platform_specific() {
    // Windows固有の実装
}

#[cfg(target_os = "none")]
export void platform_specific() {
    // ベアメタル実装
}

#[cfg(target_arch = "x86_64")]
const WORD_SIZE: int = 8;

#[cfg(target_arch = "arm")]
const WORD_SIZE: int = 4;
```

**条件式**:
- `target_os`: `"linux"`, `"windows"`, `"macos"`, `"none"`
- `target_arch`: `"x86_64"`, `"arm"`, `"arm64"`, `"riscv"`
- `feature`: カスタム機能フラグ

**実装タスク**:
- [ ] **プリプロセッサ拡張**
  - `#[cfg(...)]` 属性の解析
  - 条件式の評価
  - コード選択/除外

- [ ] **ビルド設定**
  - ターゲット指定（`--target=...`）
  - 機能フラグ（`--features=...`）

- [ ] **型チェック**
  - 条件付きで除外されたコードは型チェックしない

**テスト**:
- ユニットテスト（15個）: 条件式評価、コード選択
- 統合テスト（10個）: プラットフォーム別ビルド

**v0.17.0での使用例**:
```cb
// std/mem/alloc.cb
#[cfg(target_os = "linux")]
export void* alloc(long size) {
    // Linux: mmap システムコール
    void* result;
    asm volatile (...);  // インラインアセンブラ
    return result;
}

#[cfg(target_os = "windows")]
export void* alloc(long size) {
    // Windows: HeapAlloc FFI
    extern "C" {
        void* HeapAlloc(void* heap, int flags, long size);
    }
    return HeapAlloc(GetProcessHeap(), 0, size);
}

#[cfg(target_os = "none")]
export void* alloc(long size) {
    // ベアメタル: バンプアロケーター
    static long HEAP_CURRENT = 0x20000000;
    void* ptr = HEAP_CURRENT as void*;
    HEAP_CURRENT += size;
    return ptr;
}
```

---

#### Week 3: メモリマップドIO

**構文**:
```cb
// UART (ARM Cortex-M)
struct UART {
    volatile int data;
    volatile int status;
    volatile int control;
};

void uart_send(char c) {
    UART* uart = 0x40000000 as UART*;
    volatile {
        uart->data = c as int;
    }
}

void uart_puts(string s) {
    UART* uart = 0x40000000 as UART*;
    for (long i = 0; i < strlen(s); i++) {
        volatile {
            uart->data = s[i] as int;
        }
    }
}
```

**実装タスク**:
- [ ] `volatile` ブロック構文
- [ ] `volatile` ポインタデリファレンス
- [ ] アドレスキャスト（整数 → ポインタ）

**テスト**:
- ユニットテスト（10個）: volatile構文、アドレスキャスト
- 統合テスト（5個）: QEMUでのUART出力

---

#### Week 4: 割り込みハンドラ

**構文**:
```cb
#[interrupt(irq = 16)]
fn timer_handler() {
    // タイマー割り込み処理
    clear_timer_flag();
}

#[interrupt(irq = 27)]
fn uart_handler() {
    // UART割り込み処理
}
```

**実装タスク**:
- [ ] `#[interrupt(...)]` 属性
- [ ] 割り込みベクタテーブル生成
- [ ] コンテキスト保存/復元コード

**テスト**:
- ユニットテスト（10個）: 属性解析、ベクタテーブル生成
- 統合テスト（3個）: QEMUでの割り込み動作

---

### Month 3: Webバックエンド＋モジュールシステム強化

#### Week 1-2: WASMバックエンド

**実装タスク**:
- [ ] **LIRからWASMへの変換**
  - WASMモジュール生成
  - 関数エクスポート/インポート
  - メモリ管理

- [ ] **JavaScript/TypeScript統合**
  - JSラッパー生成
  - TypeScript型定義生成

**例**:
```bash
# WASMバイナリ生成
./main app.cb \
    --backend=wasm \
    --output=dist/app.wasm

# JavaScript glue code生成
./main app.cb \
    --backend=wasm \
    --emit-js=dist/app.js
```

**テスト**:
- ユニットテスト（15個）: WASM命令生成
- 統合テスト（10個）: Node.js/ブラウザでの実行

---

#### Week 3: TypeScriptバックエンド＋HTML/CSS生成

**TypeScript変換**:
```cb
// Cb
int add(int a, int b) {
    return a + b;
}

// TypeScript生成
export function add(a: number, b: number): number {
    return a + b;
}
```

**HTML/CSS生成**:
```cb
// Cb
Html render() {
    return div(class="app") {
        h1 { "Todo App" }
        button(onclick=handle_click) { "Add" }
        ul {
            for item in items {
                li(key=item.id) { item.text }
            }
        }
    };
}

StyleSheet styles() {
    return css {
        ".app" {
            max_width: px(600);
            margin: "0 auto";
        }
        ".app h1" {
            color: rgb(0, 122, 255);
        }
    };
}
```

**実装タスク**:
- [ ] TypeScript AST生成
- [ ] HTML DSL実装
- [ ] CSS DSL実装
- [ ] コンポーネントシステム

**テスト**:
- ユニットテスト（15個）: TypeScript生成、HTML/CSS生成
- 統合テスト（10個）: ブラウザでのレンダリング

---

#### Week 4: モジュールシステム強化

**新機能**:

1. **`mod` キーワード**:
```cb
mod math {
    export int add(int a, int b) {
        return a + b;
    }

    // プライベート関数
    int helper(int x) {
        return x * 2;
    }
}

use math::add;
```

2. **Re-export**:
```cb
// lib.cb
export use math::add;
export use io::println;
```

3. **選択的インポート**:
```cb
use std::io::{println, print, readln};
use std::collections::{Vec, Map};
```

**実装タスク**:
- [ ] `mod` キーワード実装
- [ ] `use` 構文拡張
- [ ] Re-export機能
- [ ] モジュールパス解決の改善

**テスト**:
- ユニットテスト（15個）: モジュール解析
- 統合テスト（10個）: 複数モジュールプロジェクト

---

### Month 4: 統合とテスト

#### Week 1-2: クロスプラットフォームテスト

**テスト環境**:
- Linux（x86-64、ARM64）
- macOS（Apple Silicon）
- Windows（x86-64）
- QEMU（ARM Cortex-M、RISC-V）
- ブラウザ（Chrome、Firefox、Safari）

**テストケース**:
- [ ] ネイティブ実行テスト（各プラットフォーム）
- [ ] WASM実行テスト（Node.js/ブラウザ）
- [ ] ベアメタル実行テスト（QEMU）
- [ ] TypeScript生成テスト

---

#### Week 3: パフォーマンスベンチマーク

**測定項目**:
- コンパイル時間
- 生成コードサイズ
- 実行時パフォーマンス
- メモリ使用量

---

#### Week 4: v0.17.0準備完了確認

**チェックリスト**:
- [ ] インラインアセンブラが完全に動作
- [ ] 条件付きコンパイルが完全に動作
- [ ] システムコールが直接呼び出せる
- [ ] プラットフォーム別コード切り替えができる
- [ ] モジュールシステムが強化されている

**v0.17.0で実装できる状態**:
- ✅ Linux実装（インラインアセンブラ + システムコール）
- ✅ Windows実装（FFI + Windows API）
- ✅ macOS実装（インラインアセンブラ + システムコール）
- ✅ ベアメタル実装（バンプアロケーター + UART）

---

## 🧪 テスト

### ユニットテスト（合計200+個）

**ネイティブバックエンド（50個）**:
- 命令選択（15個）
- レジスタ割り当て（15個）
- コード発行（10個）
- バイナリフォーマット（10個）

**インラインアセンブラ（25個）**:
- 構文解析（10個）
- コード生成（10個）
- 安全性チェック（5個）

**条件付きコンパイル（25個）**:
- 条件式評価（10個）
- コード選択（10個）
- プラットフォーム検出（5個）

**WASMバックエンド（30個）**:
- WASM命令生成（15個）
- モジュール生成（10個）
- JS統合（5個）

**TypeScriptバックエンド（30個）**:
- TypeScript生成（10個）
- HTML/CSS生成（15個）
- コンポーネントシステム（5個）

**モジュールシステム（15個）**:
- `mod`キーワード（5個）
- Re-export（5個）
- 選択的インポート（5個）

**低レイヤ機能（25個）**:
- ベアメタル実行（10個）
- メモリマップドIO（10個）
- 割り込みハンドラ（5個）

---

### 統合テスト（合計80+個）

**クロスプラットフォーム（40個）**:
- Linux実行（10個）
- macOS実行（10個）
- Windows実行（10個）
- ベアメタル実行（10個）

**Web実行（25個）**:
- WASM（Node.js）（10個）
- WASM（ブラウザ）（10個）
- TypeScript変換（5個）

**総合テスト（15個）**:
- マルチプラットフォームビルド（5個）
- 複雑なアプリケーション（10個）

---

## ✅ 完了条件

### 必須条件（Must Have）

- [ ] **全バックエンド動作確認**
  - ネイティブ（Linux/macOS/Windows）
  - WASM（Node.js/ブラウザ）
  - TypeScript

- [ ] **v0.17.0準備機能完全実装**
  - インラインアセンブラ ✅
  - 条件付きコンパイル ✅
  - モジュールシステム強化 ✅

- [ ] **低レイヤ対応完了**
  - ベアメタル実行 ✅
  - メモリマップドIO ✅
  - 割り込みハンドラ ✅

- [ ] **全テスト成功**（280+個）
- [ ] **メモリリークゼロ**

### 推奨条件（Should Have）

- [ ] Webフロントエンド対応完了
- [ ] HTML/CSS生成機能
- [ ] コンポーネントシステム

### 任意条件（Nice to Have）

- [ ] パフォーマンス最適化
- [ ] ビルドキャッシュ

---

## 🔗 関連ドキュメント

- **v0.15.0実装計画**: [`../v0.15.0/README.md`](../v0.15.0/README.md) - IR基盤実装
- **v0.17.0実装計画**: [`../v0.17.0/README.md`](../v0.17.0/README.md) - 標準ライブラリ化
- **総合ロードマップ**: [`../ROADMAP_v0.14-v0.18_SUMMARY.md`](../ROADMAP_v0.14-v0.18_SUMMARY.md)

---

## 📝 重要な注意事項

### v0.17.0への影響

v0.16.0の以下の機能は、**v0.17.0での標準ライブラリ完全ライブラリ化に必須**です：

1. **インラインアセンブラ**: Linux/macOSでシステムコール直接呼び出し
2. **条件付きコンパイル**: プラットフォーム別実装の切り替え
3. **モジュールシステム強化**: 標準ライブラリの階層構造

これらが実装されていないと、v0.17.0で組み込み関数（`println`, `malloc`等）をライブラリ化できません。

### 実装の優先順位

1. **最優先**: インラインアセンブラ、条件付きコンパイル（v0.17.0に必須）
2. **高優先**: ネイティブバックエンド、ベアメタル対応
3. **中優先**: WASMバックエンド、モジュールシステム強化
4. **低優先**: TypeScriptバックエンド、HTML/CSS生成

---

**作成者**: Cb Language Team
**最終更新**: 2025年11月14日
**ステータス**: Planning (v0.17.0準備機能を含む改訂版)
