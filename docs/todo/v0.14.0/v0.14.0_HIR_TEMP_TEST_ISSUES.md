# v0.14.0: HIR一時テスト - 既知の問題と修正計画

**日付**: 2025-11-16  
**バージョン**: v0.14.0  
**ステータス**: 一時運用中（新アーキテクチャ実装後に廃止予定）

---

## 1. 現在の一時HIRテストについて

### 1.1 概要
`make hir-integration-test`は、テストアーキテクチャ再設計の完了までの**一時的なソリューション**です。

- **実装**: `tests/integration/run_hir_tests.sh`
- **実行**: `make hir-integration-test`
- **テスト数**: 89テスト
- **成功率**: 97.8% (87/89)

### 1.2 一時テストの制限
1. **Bashスクリプトベース**
   - C++テストフレームワークと統合されていない
   - テストケースの管理が分離

2. **簡易的な実装**
   - エラー詳細が限定的
   - テストカウンターが簡易的

3. **長期保守非推奨**
   - 新アーキテクチャ実装後に廃止予定

---

## 2. 既知の問題

### 2.1 失敗テスト1: test_nested_option_result.cb

**ファイル**: `tests/cases/generics/test_nested_option_result.cb`

**エラー内容**:
```
[ASSERT_ERROR] Assertion failed at line 41: Assertion failed
=== Test 1: Result<Option<int>, string> ===
Got Ok, checking option...
```

**原因分析**:
- ネストされたジェネリック型 `Result<Option<int>, string>` の処理
- アサーションが失敗（期待値と実際の値が不一致）
- 41行目でのアサーションエラー

**影響範囲**:
- 限定的（他の複雑なネストジェネリクスは動作）
- 62個のジェネリクステスト中、1つのみ失敗

**修正優先度**: 低（エッジケース）

**修正計画**:
1. テストケースの期待値を確認
2. ジェネリック型のネスト処理を検証
3. 必要に応じてジェネリクスシステムを修正

**修正予定**: v0.14.1以降

---

### 2.2 失敗テスト2: ifdef_with_operators.cb

**ファイル**: `tests/integration/cases/preprocessor/ifdef_with_operators.cb`

**エラー内容**:
```
warning: Function-like macros are not fully supported yet
[INTERPRETER_ERROR] Variable processing exception: Undefined function: ADD
Error: Undefined function: ADD
```

**原因分析**:
- 関数型マクロ未サポート
- プリプロセッサの制限事項

**テストケース内容（推測）**:
```c
#define ADD(a, b) ((a) + (b))
int result = ADD(1, 2);  // <- エラー
```

**影響範囲**:
- 限定的（単純な`#define`マクロは動作）
- 21個のプリプロセッサテスト中、1つのみ失敗

**修正優先度**: 中（将来的な機能拡張）

**修正計画**:
1. プリプロセッサに関数型マクロ機能を追加
2. マクロ展開処理を実装
3. テストケースを再実行

**修正予定**: v0.15.0以降（機能拡張）

---

## 3. テスト実行時の注意点

### 3.1 一時ファイルの扱い

**問題**:
現在のスクリプトは一時ファイルを `/tmp/cb_hir_integration_$$` に作成します。

**対応**:
- スクリプト終了時に自動削除
- 手動削除が必要な場合: `rm -rf /tmp/cb_hir_integration_*`

### 3.2 相対パスの依存

**問題**:
スクリプトは `tests/integration/` ディレクトリからの実行を前提としています。

**対応**:
- `make hir-integration-test` から実行すること
- 直接実行する場合: `cd tests/integration && bash run_hir_tests.sh`

### 3.3 エラー出力の制限

**問題**:
エラー詳細が最初の3行のみ表示されます。

**対応**:
- 詳細確認が必要な場合: `/tmp/cb_hir_integration_*/output_*.txt` を確認
- より詳細なログが必要な場合は手動実行

---

## 4. 成功しているテストカテゴリ

### 4.1 完全動作確認済み（87/89テスト）

#### HIR基本機能（9/9）✅
- 制御フロー
- 構造体
- 関数
- 演算子
- 型システム
- 配列・ポインタ
- 統合テスト

#### println機能（4/4）✅
- 空出力
- 単一引数
- printf形式
- 混合出力

#### ジェネリクス（61/62）✅
- 基本構造体
- ネストされたジェネリクス
- 複雑な型パラメータ
- 関数ジェネリクス
- 配列とジェネリクス
- ポインタとジェネリクス
- 再帰的構造体

**唯一の失敗**: test_nested_option_result.cb

#### FFI（10/10）✅
- 基本パース
- 関数呼び出し
- 型変換
- モジュール管理

#### プリプロセッサ（20/21）✅
- #define
- #ifdef / #ifndef
- #else / #elseif
- ネスト
- 変数保護
- 文字列保護

**唯一の失敗**: ifdef_with_operators.cb

---

## 5. 新アーキテクチャへの移行計画

### 5.1 移行ステップ

1. **Phase 1: 新フレームワーク実装**（v0.14.0）
   - 実行戦略パターンの実装
   - サンプルテストで動作確認
   - ドキュメント: `v0.14.0_TEST_ARCHITECTURE_REDESIGN.md`

2. **Phase 2: テストケース移行**（v0.14.1）
   - 段階的に既存テストを新アーキテクチャに移行
   - 各カテゴリで動作確認

3. **Phase 3: 一時スクリプト廃止**（v0.15.0）
   - 新アーキテクチャで全テスト動作確認
   - `run_hir_tests.sh` を廃止
   - C++ベースのテストフレームワークに統合

### 5.2 一時テストの保守方針

**v0.14.0期間中**:
- ✅ 動作確認に使用
- ✅ 既知の問題は記録のみ（修正は後回し）
- ✅ 新機能テストの追加は最小限

**v0.14.1以降**:
- ⏳ 新アーキテクチャに移行開始
- ⏳ 一時スクリプトは並行運用
- ⏳ 問題修正は新アーキテクチャで実施

**v0.15.0以降**:
- ⏳ 一時スクリプト完全廃止
- ⏳ 新アーキテクチャのみ使用

---

## 6. 修正が必要な項目リスト

### 6.1 即時対応不要（v0.14.0）
- ❌ test_nested_option_result.cb の修正
- ❌ ifdef_with_operators.cb の修正
- ❌ run_hir_tests.sh の機能拡張

**理由**: 新アーキテクチャ実装を優先

### 6.2 v0.14.1で対応
- ⏳ test_nested_option_result.cb のアサーション修正
  - 期待値の確認
  - ジェネリック型処理の検証

### 6.3 v0.15.0で対応（機能拡張）
- ⏳ 関数型マクロのサポート
  - プリプロセッサ拡張
  - ifdef_with_operators.cb のテスト有効化

---

## 7. 現在のワークフロー

### 7.1 開発時
```bash
# 通常のインタプリタテスト
make integration-test

# HIR動作確認（一時）
make hir-integration-test
```

### 7.2 CI/CD
```yaml
# 現在（v0.14.0）
- name: Integration Test
  run: make integration-test

# 将来（v0.15.0+）
- name: Integration Test (Interpreter)
  run: make integration-test
  
- name: Integration Test (HIR Compiler)
  run: make hir-integration-test
```

---

## 8. まとめ

### 8.1 現状
- ✅ 一時HIRテストは**97.8%の成功率**で動作中
- ✅ 主要機能は全て正常動作
- ✅ 2つの失敗は既知の制限事項

### 8.2 方針
1. **v0.14.0**: 一時テストを維持・運用
2. **v0.14.0**: 新アーキテクチャ設計・実装
3. **v0.14.1**: 段階的移行開始
4. **v0.15.0**: 新アーキテクチャへ完全移行

### 8.3 利点
- ✅ リスクを最小化
- ✅ 段階的な進化
- ✅ 後方互換性の維持

**一時HIRテストは、新アーキテクチャへの橋渡しとして重要な役割を果たしています。**

---

**作成者**: Cb言語開発チーム  
**作成日**: 2025-11-16  
**次回レビュー**: v0.14.1リリース時
