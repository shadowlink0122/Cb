# Cb言語 v0.10.1 実装計画

## リリース予定日
2025年11月上旬

## 概要
v0.10.1では、v0.10.0で実装したムーブセマンティクスをさらに改善し、より自然で使いやすいものにします。return文での自動ムーブ、ムーブ代入演算子、右辺値の自動検出など、C++との互換性をさらに高めます。

---

## 🎯 実装予定の機能

### 1. return文での自動ムーブ (NRVO)

**優先度**: 🔴 最優先  
**見積もり**: 1週間  
**難易度**: ⭐⭐⭐

#### 概要
ローカル変数をreturnする際、明示的な`move()`なしで自動的にムーブを行う。

#### 実装例
```cb
// 現在（v0.10.0）
Point create_point() {
    Point p(10, 20);
    return move(p);  // 明示的なmove()が必要
}

// v0.10.1での目標
Point create_point() {
    Point p(10, 20);
    return p;  // 自動的にムーブされる
}
```

#### 実装方針
1. **return文の解析強化**
   - 返される変数がローカル変数か判定
   - ムーブコンストラクタの有無を確認

2. **Named Return Value Optimization (NRVO)**
   - 一時オブジェクトの生成を回避
   - 直接戻り先にムーブ

3. **フォールバック**
   - ムーブコンストラクタがない場合はコピー
   - 参照渡しの場合はムーブしない

#### 影響範囲
- `src/backend/interpreter/handlers/control/return.cpp`
- `src/backend/interpreter/core/interpreter.cpp`

---

### 2. ムーブ代入演算子

**優先度**: 🔴 最優先  
**見積もり**: 1週間  
**難易度**: ⭐⭐⭐⭐

#### 概要
既存のオブジェクトに対してムーブ代入を行う機能。

#### 実装例
```cb
struct Resource {
    int* data;
    int size;
};

impl Resource {
    self(int s) {
        self.size = s;
        self.data = malloc(s);
    }
    
    // コピー代入演算子
    self& operator=(const Resource& other) {
        if (self.data != nullptr) {
            free(self.data);
        }
        self.size = other.size;
        self.data = malloc(other.size);
        copy_data(other.data, self.data, self.size);
        return self;
    }
    
    // ムーブ代入演算子（新機能）
    self& operator=(Resource&& other) {
        if (self.data != nullptr) {
            free(self.data);
        }
        
        self.size = other.size;
        self.data = other.data;
        
        other.data = nullptr;
        other.size = 0;
        
        return self;
    }
    
    ~self() {
        if (self.data != nullptr) {
            free(self.data);
        }
    }
}

void main() {
    Resource r1(100);
    Resource r2(200);
    
    r1 = move(r2);  // ムーブ代入演算子が呼ばれる
}
```

#### 実装方針
1. **演算子オーバーロードの拡張**
   - `operator=(T&&)` の構文サポート
   - 右辺値参照パラメータの認識

2. **代入処理の分岐**
   - 右辺値の場合はムーブ代入演算子
   - 左辺値の場合はコピー代入演算子

3. **自己代入チェック**
   - `self = move(self)` のような誤用を防止

#### 影響範囲
- `src/frontend/recursive_parser/parsers/interface_parser.cpp`
- `src/backend/interpreter/executors/assignments/*.cpp`
- `src/backend/interpreter/managers/variables/assignment.cpp`

---

### 3. 右辺値の自動検出

**優先度**: 🟡 高  
**見積もり**: 1週間  
**難易度**: ⭐⭐⭐⭐⭐

#### 概要
式の値カテゴリ（lvalue/rvalue）を自動的に判定し、適切にムーブを行う。

#### 実装例
```cb
Point create_point() {
    return Point(10, 20);
}

void main() {
    // 一時オブジェクトは自動的にrvalueとして扱われる
    Point p1 = create_point();  // 自動的にムーブ
    
    Point p2(30, 40);
    Point p3 = p2;              // lvalue → コピー
    Point p4 = move(p2);        // 明示的なムーブ
}
```

#### 実装方針
1. **値カテゴリの追跡**
   - lvalue: 名前のあるオブジェクト
   - xvalue: `move()` された lvalue
   - prvalue: 一時オブジェクト（関数の戻り値など）
   - rvalue: xvalue + prvalue

2. **ASTノードへの情報付加**
   - 各式ノードに値カテゴリを記録
   - コンストラクタ選択時に参照

3. **最適化**
   - 不要なコピーの削減
   - コピー省略（Copy Elision）

#### 影響範囲
- `src/common/ast.h` (値カテゴリの追加)
- `src/backend/interpreter/evaluator/core/*.cpp`
- `src/backend/interpreter/managers/variables/*.cpp`

---

## 🔨 バグ修正と改善

### 1. 関数オーバーロード
**優先度**: 🟡 高  
**見積もり**: 3日

現在、関数オーバーロードが未実装のため、以下の問題がある:
```cb
// ❌ 現在は未対応
void println(string message);
void println(int value);
```

#### 実装方針
- 関数シグネチャに基づく選択
- 型推論の改善

---

### 2. まとめてexport構文
**優先度**: 🟢 中  
**見積もり**: 2日

```cb
// 目標構文
export {
    struct Rectangle;
    impl Rectangle;
    impl Shape for Rectangle;
}
```

---

### 3. 前方宣言のサポート
**優先度**: 🟢 中  
**見積もり**: 2日

```cb
// 目標構文
void func();  // 前方宣言

void main() {
    func();
}

void func() {
    println("Called");
}
```

---

## 📋 実装タスクリスト

### Week 1: return文での自動ムーブ
- [ ] return文の解析強化
- [ ] ローカル変数の検出
- [ ] 自動ムーブの実装
- [ ] テストケース作成
- [ ] ドキュメント作成

### Week 2: ムーブ代入演算子
- [ ] 構文解析の実装
- [ ] 代入処理の分岐
- [ ] 自己代入チェック
- [ ] テストケース作成
- [ ] ドキュメント作成

### Week 3: 右辺値の自動検出
- [ ] 値カテゴリの設計
- [ ] ASTノードへの情報付加
- [ ] 評価器の修正
- [ ] テストケース作成
- [ ] ドキュメント作成

### Week 4: バグ修正と統合テスト
- [ ] 関数オーバーロード
- [ ] まとめてexport構文
- [ ] 前方宣言
- [ ] 統合テスト
- [ ] ドキュメント整備

---

## 🎓 学習リソース

### C++ Reference
- [Value categories (cppreference.com)](https://en.cppreference.com/w/cpp/language/value_category)
- [Copy elision (cppreference.com)](https://en.cppreference.com/w/cpp/language/copy_elision)
- [Move assignment operator (cppreference.com)](https://en.cppreference.com/w/cpp/language/move_assignment)

### Design Goals
1. C++との互換性を最大化
2. パフォーマンスの最適化
3. 使いやすさと安全性のバランス

---

## 🧪 テスト計画

### 新規テストケース
1. **return_auto_move_test.cb**
   - 自動ムーブの動作確認
   - コピー省略の検証

2. **move_assignment_test.cb**
   - ムーブ代入演算子のテスト
   - 自己代入のテスト

3. **value_category_test.cb**
   - lvalue/rvalue の自動判定
   - 一時オブジェクトのムーブ

### 統合テスト
- 既存のムーブセマンティクステストとの互換性確認
- パフォーマンステスト

---

## 📝 ドキュメント

### 更新予定
1. **spec.md**
   - 値カテゴリの説明
   - ムーブ代入演算子の構文

2. **BNF.md**
   - 構文定義の更新

3. **tutorial/**
   - ムーブセマンティクスの使い方
   - ベストプラクティス

---

## 🚀 リリース基準

### 必須条件
- ✅ すべてのテストが通過
- ✅ ドキュメントの更新完了
- ✅ バグ修正完了

### 望ましい条件
- 🎯 パフォーマンステストで改善を確認
- 🎯 C++との互換性テスト
- 🎯 ユーザードキュメントの充実

---

**作成日**: 2025年10月12日  
**作成者**: shadowlink0122
