# Cb言語 v0.9.2 実装計画（改訂版）

**作成日**: 2025年10月10日  
**対象バージョン**: v0.9.2  
**ブランチ**: feature/v0.9.2

---

## 🎯 v0.9.2の目標

v0.9.2では、**const * const型安全性の完全実装**に集中します。これにより、Rust Pin<&T>と完全に同等のメモリ安全性保証を実現します。

### 完了済み機能（v0.9.2前半）

- ✅ 配列参照型（`int[N]&`）の実装
- ✅ ポインタテストの大規模リファクタリング
- ✅ const * const型のローカル変数での実装
- ✅ 構造体メンバーの再帰的代入修正
- ✅ 包括的テストスイート（2,556テスト）

### v0.9.2後半の実装（本修正）

🔴 **最優先: const * const型安全性の完全実装**

---

## 🔴 修正対象: const * const型安全性

### 現状の問題

初期のv0.9.2実装では、`const * const`型が**ローカル変数でのみ**動作し、**関数パラメータと戻り値で型情報が失われる**重大な欠陥がありました。

```cb
// ❌ 問題例
void modify(int* ptr) { *ptr = 100; }
void main() {
    const int* const ptr = &x;  // 不変のはず
    modify(ptr);  // エラーになるべきだが通る
    println(x);  // 100 - 値が変更された！
}
```

### 実装内容

#### Phase 1: 型情報の保持・伝播

**目標**: 関数パラメータでconst情報を正しく保持

**実装箇所**: `src/backend/interpreter/evaluator/functions/call_impl.cpp`

**修正内容**:
1. パラメータ設定時に`is_pointee_const`と`is_pointer_const`を伝播
2. ポインタパラメータ専用の処理ロジック追加

**コード例**:
```cpp
// ポインタパラメータの型情報を保持
if (arg_var->is_pointer && param->is_pointer) {
    param_var.is_pointee_const = arg_var->is_pointee_const;
    param_var.is_pointer_const = arg_var->is_pointer_const;
    param_var.pointer_depth = arg_var->pointer_depth;
}
```

#### Phase 2: 関数パラメータでの型チェック

**目標**: const型からnon-const型への暗黙変換を禁止

**実装箇所**: `src/backend/interpreter/evaluator/functions/call_impl.cpp`

**チェックロジック**:
```cpp
// const T* → T* は禁止
if (arg_var->is_pointee_const && !param->is_pointee_const) {
    throw std::runtime_error(
        "Type mismatch: cannot pass 'const T*' to parameter of type 'T*'\n"
        "Cannot discard const qualifier");
}

// T* const → T* は禁止
if (arg_var->is_pointer_const && !param->is_pointer_const) {
    throw std::runtime_error(
        "Type mismatch: cannot pass 'T* const' to parameter of type 'T*'\n"
        "Cannot discard pointer const qualifier");
}
```

#### Phase 3: 関数戻り値での型チェック

**目標**: 戻り値のconst情報を保持し、代入時にチェック

**実装箇所**: 
- `src/backend/interpreter/evaluator/functions/call_impl.cpp` (return文)
- `src/backend/interpreter/executors/assignments/pointer.cpp` (代入時)

**修正内容**:
1. ReturnExceptionでconst情報を保持
2. 関数呼び出し結果の代入時に型チェック
3. const型からnon-const型への代入を禁止

#### Phase 4: テストケースの作成

**正常系テスト**:
```cb
// test_const_pointer_parameter_compatibility.cb
void read_const(const int* ptr) { println(*ptr); }
void read_const_const(const int* const ptr) { println(*ptr); }

void main() {
    int x = 42;
    const int* const ptr = &x;
    
    // ✅ OK: const * const → const *
    read_const(ptr);
    
    // ✅ OK: const * const → const * const
    read_const_const(ptr);
    
    println("All tests passed!");
}
```

**エラー系テスト**:
```cb
// error_const_to_nonconst_parameter.cb
void modify(int* ptr) { *ptr = 100; }

void main() {
    int x = 42;
    const int* const ptr = &x;
    
    // ❌ Error: const * const → int* は禁止
    modify(ptr);
}
```

期待エラー:
```
Error: Type mismatch in function call to 'modify'
  Cannot pass 'const int* const' to parameter of type 'int*'
  Cannot discard const qualifier
```

---

## 📊 実装スケジュール

### Week 1: Phase 1-2（関数パラメータ）

**Day 1-2**: 型情報の保持・伝播
- [ ] call_impl.cppでポインタパラメータ処理を修正
- [ ] is_pointee_constとis_pointer_constの伝播実装
- [ ] 単体テストで動作確認

**Day 3-4**: パラメータでの型チェック実装
- [ ] 型互換性チェック関数の実装
- [ ] エラーメッセージの追加
- [ ] テストケース作成・実行

**Day 5**: 統合テスト
- [ ] 既存テストが全てパスすることを確認
- [ ] 新規テストケースの追加

### Week 2: Phase 3-4（戻り値とテスト）

**Day 6-7**: 関数戻り値での型チェック
- [ ] ReturnExceptionでconst情報保持
- [ ] 代入時の型チェック実装
- [ ] テストケース作成

**Day 8-9**: 包括的テストスイート
- [ ] 多重ポインタでのconst型チェック
- [ ] エッジケースのテスト
- [ ] ドキュメント更新

**Day 10**: リリース準備
- [ ] 全テスト実行（2,556+新規テスト）
- [ ] リリースノート更新
- [ ] v0.9.2タグ作成

**合計工数**: 約10日（2週間）

---

## 🧪 テスト戦略

### 新規テストケース

#### 正常系（6ケース）

1. `test_const_pointer_parameter_ok.cb` - パラメータの互換性テスト
2. `test_const_pointer_return_ok.cb` - 戻り値の互換性テスト
3. `test_const_pointer_assignment_ok.cb` - 代入の互換性テスト
4. `test_const_to_const_parameter.cb` - const → constは許可
5. `test_nonconst_to_const_parameter.cb` - non-const → constは許可
6. `test_multilevel_const_pointer.cb` - 多重ポインタのconst型

#### エラー系（6ケース）

1. `error_const_to_nonconst_parameter.cb` - const* → T*は禁止
2. `error_const_const_to_nonconst_parameter.cb` - const* const → T*は禁止
3. `error_pointee_const_to_nonconst.cb` - const T* → T*は禁止
4. `error_pointer_const_to_nonconst.cb` - T* const → T*は禁止
5. `error_const_return_to_nonconst.cb` - 戻り値のconst違反
6. `error_const_assignment_mismatch.cb` - 代入時のconst違反

### テスト実行方法

```bash
# 個別テスト
./main tests/cases/const_pointer_safety/test_const_pointer_parameter_ok.cb

# エラーケース（エラーが出ることを期待）
./main tests/cases/const_pointer_safety/error_const_to_nonconst_parameter.cb
# Expected: Error: Type mismatch ... Cannot discard const qualifier

# 全テスト実行
make test
```

---

## 📝 実装チェックリスト

### Phase 1: 型情報の保持・伝播

- [ ] call_impl.cppのポインタパラメータ処理を特定
- [ ] is_pointee_constフラグの伝播実装
- [ ] is_pointer_constフラグの伝播実装
- [ ] pointer_depthの保持確認
- [ ] デバッグ出力で型情報を確認

### Phase 2: パラメータでの型チェック

- [ ] check_pointer_parameter_compatibility関数の実装
- [ ] const T* → T*のチェック
- [ ] T* const → T*のチェック
- [ ] const T* const → T*のチェック
- [ ] エラーメッセージの実装
- [ ] 型情報をエラーメッセージに含める

### Phase 3: 戻り値での型チェック

- [ ] ReturnException構造体を確認
- [ ] return文でconst情報を保持
- [ ] 関数呼び出し後の代入処理を特定
- [ ] 代入時の型チェック実装
- [ ] エラーメッセージの実装

### Phase 4: テスト

- [ ] 正常系テスト6件の作成
- [ ] エラー系テスト6件の作成
- [ ] 全テストの実行・確認
- [ ] 既存テスト2,556件が全てパス
- [ ] カバレッジの確認

### ドキュメント

- [ ] リリースノートの更新
- [ ] const_pointer_type_safety_plan.mdの更新（完了マーク）
- [ ] README.mdの更新
- [ ] docs/spec.mdの更新

---

## 🎯 成功基準

### 機能要件

1. ✅ **const T*からT*へのパラメータ渡しがエラーになる**
2. ✅ **T* constからT*へのパラメータ渡しがエラーになる**
3. ✅ **const T* constからT*へのパラメータ渡しがエラーになる**
4. ✅ **戻り値のconst情報が保持される**
5. ✅ **const型戻り値をnon-const変数に代入するとエラーになる**
6. ✅ **non-const → constの変換は許可される（安全なので）**

### 品質要件

1. ✅ **全2,556件の既存テストがパス**
2. ✅ **新規テスト12件が全てパス**
3. ✅ **エラーメッセージが明確でわかりやすい**
4. ✅ **パフォーマンスへの影響が最小限**
5. ✅ **ドキュメントが最新状態**

---

## 🔗 関連ドキュメント

- `docs/todo/const_pointer_type_safety_plan.md` - 詳細実装計画
- `docs/todo/v0.9.2_implementation_status_detailed.md` - 実装状況レポート
- `release_notes/v0.9.2.md` - リリースノート
- `tests/cases/const_pointer_safety/` - テストケース

---

## 📈 進捗管理

### 現在の状態: Phase 0（計画完了）

- ✅ 問題の特定と文書化
- ✅ 実装計画の作成
- ✅ テスト戦略の策定
- ⏳ **次**: Phase 1の実装開始

### 次回のマイルストーン

**目標**: Phase 1-2完了（関数パラメータでの型チェック）  
**期日**: 5日後  
**成果物**: パラメータでconst型安全性が保証される

---

**作成者**: Cb開発チーム  
**最終更新**: 2025年10月10日  
**ステータス**: 実装準備完了 → 実装開始待ち
