# v0.10.1 実装ガイド

このディレクトリには、v0.10.0で実装しきれなかった機能と、v0.10.1での実装計画が含まれています。

---

## 📚 ドキュメント構成

### v0.10.0 完了記録
1. **v0.10.0_completion_summary.md** ⭐ **必読**
   - v0.10.0で実装した内容の完全なサマリー
   - 修正したバグの詳細
   - テスト結果
   - v0.10.1への引き継ぎ事項

2. **v0.10.0_rvalue_reference_status.md**
   - T&& 機能の実装状態
   - 構文レベルの実装詳細

3. **v0.10.0_test_integration_summary.md**
   - 12個の統合テストの説明
   - テストの期待値と現在の状態

### v0.10.1 実装計画
4. **v0.10.1_implementation_gaps.md** ⭐ **最優先**
   - 未実装機能の詳細な説明
   - 具体的なコードレベルでの修正箇所
   - 実装優先度の明示
   - テスト状況

5. **v0.10.1_rvalue_reference_roadmap.md** ⭐ **実装ロードマップ**
   - Phase 1-6 の段階的実装計画
   - 各Phaseの推定時間
   - チェックリスト
   - リスク管理

### v0.11.0 以降
6. **v0.11.0_move_semantics_implementation.md**
   - ムーブセマンティクスの完全実装
   - コピーコンストラクタ
   - ムーブコンストラクタ

---

## 🚀 v0.10.1 実装を開始する前に

### Step 1: 現状を理解する
```bash
# 必読ドキュメント（この順番で読む）
1. v0.10.0_completion_summary.md         # 何が完了したか
2. v0.10.1_implementation_gaps.md        # 何が未実装か（詳細）
3. v0.10.1_rvalue_reference_roadmap.md   # どう実装するか（計画）
```

### Step 2: 環境をセットアップする
```bash
# プロジェクトルートから
git checkout feature/v0.10.0
make clean
make
make test  # 全2858テストが成功することを確認
```

### Step 3: テストを実行する
```bash
# 統合テストを実行
./tests/integration/test_main

# T&& テストの状態を確認
# 以下のテストが EXPECTED_FAIL になっていることを確認
# - test_member_access
# - test_member_assignment  
# - test_aliasing
```

---

## 📋 v0.10.1 実装チェックリスト

### Phase 1: 参照マップの実装（最優先）
- [ ] `src/backend/interpreter/core/interpreter.h` に `reference_maps_` を追加
- [ ] `Interpreter::resolve_reference()` を実装
- [ ] `Interpreter::register_reference()` を実装
- [ ] `push_scope()` / `pop_scope()` で参照マップを管理

**期待結果**: 参照変数の名前解決が可能になる

### Phase 2: メンバーアクセスの修正
- [ ] `src/backend/interpreter/evaluator/access/member.cpp` を修正
  - `evaluate_member_access_impl()` で `resolve_reference()` を呼び出す
- [ ] `test_member_access` が PASS になることを確認

**期待結果**: `ref.x` で元の変数 `p.x` が更新される

### Phase 3: メンバー代入の修正
- [ ] `src/backend/interpreter/executors/assignments/member_assignment.cpp` を修正
  - メンバー代入時に `resolve_reference()` を呼び出す
- [ ] `test_member_assignment` が PASS になることを確認

**期待結果**: `ref.x = 10` で元の変数 `p.x` が更新される

### Phase 4: エイリアシングのサポート
- [ ] `src/backend/interpreter/managers/variables/declaration.cpp` を修正
  - 参照の参照を正しく解決する
- [ ] `test_aliasing` が PASS になることを確認

**期待結果**: `Point&& ref2 = ref1` で `ref2` が `p1` を参照する

### Phase 5: デストラクタの自動呼び出し
- [ ] `Interpreter::call_destructors_for_scope()` を実装
- [ ] `pop_scope()` でデストラクタを呼び出す
- [ ] return/break/continue でもデストラクタを呼び出す

**期待結果**: スコープ終了時にデストラクタが自動的に呼ばれる

---

## 🎯 成功基準

v0.10.1の実装が成功したと判断する基準：

1. ✅ 全2582テストが引き続き PASS
2. ✅ 以下の3つのテストが PASS になる：
   - `test_member_access`
   - `test_member_assignment`
   - `test_aliasing`
3. ✅ デストラクタが自動的に呼ばれる（新規テストで確認）
4. ✅ パフォーマンス劣化が10%以内
5. ✅ メモリリークがない（valgrindで確認）

---

## ⚠️ 重要な注意点

### 後方互換性を保つ
- 既存の2582テストが壊れないようにする
- T& (左辺値参照) の動作に影響を与えない
- 通常の変数宣言・代入に影響を与えない

### パフォーマンスに注意
- `resolve_reference()` は頻繁に呼ばれる可能性がある
- できるだけ効率的な実装を心がける
- 参照でない場合は早期リターンする

### デバッグのヒント
```cpp
// デバッグ出力を使う
debug_print("[REF_DEBUG] Resolving reference: %s\n", name.c_str());

// 条件付きコンパイル
#ifdef DEBUG_REFERENCES
    std::cerr << "Reference map: " << /* ... */ << std::endl;
#endif
```

---

## 📊 実装の進捗管理

### タイムライン（推定）
| Phase | 内容 | 推定時間 |
|-------|------|----------|
| 1 | 参照マップ実装 | 3時間 |
| 2 | メンバーアクセス修正 | 2時間 |
| 3 | メンバー代入修正 | 1時間 |
| 4 | エイリアシング | 1時間 |
| 5 | デストラクタ自動呼び出し | 3時間 |
| **合計** | | **10時間** |

### 進捗を記録する
実装を進める際は、以下のドキュメントを更新してください：

1. このREADMEのチェックリスト
2. `v0.10.1_implementation_progress.md`（新規作成を推奨）
3. `v0.10.1_rvalue_reference_roadmap.md`のチェックリスト

---

## 🆘 困ったときは

### よくある問題

**Q1: テストが PASS から FAIL に変わった**
```bash
# 差分を確認
git diff

# 特定のテストだけ実行
./main tests/cases/xxx/yyy.cb

# デバッグモードで実行
./main --debug tests/cases/xxx/yyy.cb
```

**Q2: メモリリークが発生した**
```bash
# valgrindで確認
valgrind --leak-check=full ./main tests/cases/xxx/yyy.cb
```

**Q3: パフォーマンスが低下した**
```bash
# プロファイリング
time make test

# 特定の処理の時間を計測
# （time(NULL)を使う、または<chrono>を使う）
```

---

## 📖 参考資料

### C++の参照セマンティクス
- [cppreference - References](https://en.cppreference.com/w/cpp/language/reference)
- [cppreference - Rvalue references](https://en.cppreference.com/w/cpp/language/reference#Rvalue_references)

### 実装のヒント
- 参照の参照は再帰的に解決する
- スコープと参照の有効期限を連動させる
- デストラクタは構築の逆順で呼び出す

---

## 🎉 完了したら

v0.10.1の実装が完了したら：

1. ✅ 全テストが PASS していることを確認
2. ✅ `v0.10.1_completion_summary.md` を作成
3. ✅ リリースノート `release_notes/v0.10.1.md` を作成
4. ✅ コミットとプッシュ
```bash
git add .
git commit -m "feat(v0.10.1): Complete T&& reference semantics"
git push origin feature/v0.10.0
```

---

**最終更新**: 2025年10月12日  
**v0.10.0 完了時点**  
**次の実装者へ**: この資料があなたの実装をスムーズに進める助けになることを願っています！
