# v0.10.0 実装順序

**作成日**: 2025年10月11日  
**実装方針**: 基本機能から段階的に実装

---

## 📅 実装スケジュール

### Phase 1: 制御構文の拡張（Week 1-4）

#### 1. defer文 ✅ 開始
- **期間**: Week 1-2 (2週間)
- **優先度**: 高
- **理由**: スコープベースのリソース管理、シンプルな機能
- **依存**: なし
- **実装タスク**:
  - [ ] Lexer: `defer` キーワード追加
  - [ ] Parser: defer文の解析
  - [ ] AST: DeferNode追加
  - [ ] インタープリタ: スコープ終了時の実行スタック
  - [ ] テストケース作成

#### 2. switch文
- **期間**: Week 3-4 (2週間)
- **優先度**: 高
- **理由**: 制御フローの拡張、OR/range演算子の実装
- **依存**: なし
- **実装タスク**:
  - [ ] Lexer: `switch`, `case`, `else` キーワード追加
  - [ ] Parser: switch文、case式（OR/range）の解析
  - [ ] AST: SwitchNode, CaseNode追加
  - [ ] インタープリタ: パターンマッチング実行
  - [ ] テストケース作成

### Phase 2: 構造体機能の拡張（Week 5-12）

#### 3. デフォルトメンバ（default修飾子）
- **期間**: Week 5-6 (2週間)
- **優先度**: 高
- **理由**: 構造体の基礎機能、コンストラクタの前提
- **依存**: なし
- **実装タスク**:
  - [ ] Lexer: `default` キーワード追加
  - [ ] Parser: default修飾子の解析
  - [ ] 型システム: default修飾子の管理
  - [ ] 暗黙的変換の実装
  - [ ] テストケース作成

#### 4. コンストラクタ
- **期間**: Week 7-9 (3週間)
- **優先度**: 高
- **理由**: オブジェクト初期化の自動化
- **依存**: default修飾子（推奨）
- **実装タスク**:
  - [ ] Parser: コンストラクタ構文の解析
  - [ ] AST: ConstructorNode追加
  - [ ] `self`ポインタの管理（既存機能を活用）
  - [ ] 自動呼び出しの実装
  - [ ] オーバーロードの実装
  - [ ] テストケース作成

#### 5. デストラクタ
- **期間**: Week 10-11 (2週間)
- **優先度**: 高
- **理由**: リソース解放の自動化
- **依存**: コンストラクタ
- **実装タスク**:
  - [ ] Parser: デストラクタ構文の解析
  - [ ] AST: DestructorNode追加
  - [ ] スコープ終了時の自動呼び出し
  - [ ] 呼び出し順序の管理（LIFO）
  - [ ] テストケース作成

#### 6. デフォルト引数
- **期間**: Week 12 (1週間)
- **優先度**: 高
- **理由**: 関数呼び出しの柔軟性、コンストラクタとの相性
- **依存**: コンストラクタ（推奨）
- **実装タスク**:
  - [ ] Parser: デフォルト値の解析
  - [ ] 関数シグネチャの拡張
  - [ ] 引数補完の実装
  - [ ] テストケース作成

### Phase 3: 高階関数とモジュールシステム（Week 13-43）

#### 7. 無名関数（ラムダ式）
- **期間**: Week 13-16 (4週間)
- **優先度**: 高
- **理由**: 高階関数のサポート
- **依存**: 関数ポインタ（実装済み）
- **実装タスク**:
  - [ ] Parser: `func`式の解析
  - [ ] AST: LambdaNode追加
  - [ ] クロージャの実装（スコープキャプチャ）
  - [ ] 内部関数名の生成
  - [ ] テストケース作成

#### 8. 無名変数（_ 識別子）
- **期間**: Week 17-18 (2週間)
- **優先度**: 中
- **理由**: 戻り値の明示的な無視
- **依存**: なし
- **実装タスク**:
  - [ ] Lexer: `_` 識別子の特殊処理
  - [ ] Parser: 複数の`_`を許可
  - [ ] セマンティクス: 参照禁止の検証
  - [ ] テストケース作成

#### 9. import/export（モジュールシステム）
- **期間**: Week 19-43 (25週間)
- **優先度**: 中
- **理由**: 大規模プロジェクトの構造化
- **依存**: namespace, `as`キーワード
- **実装タスク**:
  - [ ] Lexer: `export`, `import`, `default`, `namespace`, `as`, `::` の追加
  - [ ] Parser: export/import文の解析
  - [ ] Parser: namespace宣言の解析
  - [ ] Parser: `as`の文脈判定（import vs キャスト）
  - [ ] モジュールシステムの構築
  - [ ] 依存関係グラフの構築
  - [ ] 構造体キャストの実装（`as`）
  - [ ] Tree-shakingの実装
  - [ ] テストケース作成

---

## 📊 実装進捗管理

### 完了した機能
- なし（これから開始）

### 現在実装中
- **defer文** (Week 1-2)

### 次の予定
- switch文 (Week 3-4)
- デフォルトメンバ (Week 5-6)

---

## 🎯 マイルストーン

- **M1 (Week 4)**: 制御構文完成（defer, switch）
- **M2 (Week 12)**: 構造体機能完成（default, constructor, destructor, default args）
- **M3 (Week 18)**: 基本機能完成（lambda, discard variable）
- **M4 (Week 43)**: v0.10.0完成（import/export, 型キャスト）

---

## 📝 実装メモ

### defer文の実装について
- Goのdefer文と同じ動作
- スコープ終了時に実行（LIFO順）
- 実装方法: スコープごとにdeferスタックを管理
- defer文が実行されるタイミング:
  1. 関数のreturn時
  2. ブロックスコープの終了時
  3. エラー時の早期return時

### switch文の実装について
- 自動breakあり（fallthroughなし）
- OR演算子: `case(1 || 2 || 3)`
- range演算子: `case(1...10)`
- else節: デフォルトケース
- 実装方法: if-else chainへの変換または直接評価

### 構造体機能の実装順序の理由
1. **default修飾子**: 暗黙的変換の基礎、単純な機能
2. **コンストラクタ**: defaultメンバを活用できる
3. **デストラクタ**: コンストラクタと対になる機能
4. **デフォルト引数**: コンストラクタのオーバーロードを簡潔に

---

## 🔄 次のアクション

1. defer文の詳細設計ドキュメント作成
2. Lexerへ`defer`キーワード追加
3. Parserでdefer文を解析
4. ASTにDeferNode追加
5. インタープリタにdeferスタック実装
6. テストケース作成と検証
