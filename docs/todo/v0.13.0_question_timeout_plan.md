# v0.13.0 実装計画: ?オペレーターとタイムアウト

**ステータス**: 計画中  
**予定バージョン**: v0.13.0  
**最終更新**: 2025年11月11日

---

## 概要

v0.13.0では、Rustスタイルの`?`オペレーターとasync関数のタイムアウト機能を実装します。これにより、エラー処理がより簡潔になり、非同期処理の信頼性が向上します。

---

## 実装項目

### 1. ?オペレーター（エラー伝播）

**優先度**: 高  
**工数見積**: 中（3-5日）  
**設計ドキュメント**: [docs/features/question_operator_design.md](../features/question_operator_design.md)

#### 実装ステップ

##### Phase 1: パーサー拡張（1-2日）

- [ ] `?`トークンの認識
- [ ] 後置単項演算子としてのパース
- [ ] AST:追加 `QuestionOperator`ノード
- [ ] 優先順位の設定（関数呼び出しやメンバーアクセスの後）

**ファイル変更**:
- `src/frontend/lexer/tokenizer.cpp` - ?トークンの追加
- `src/common/ast.h` - QuestionOperatorノードの追加
- `src/frontend/recursive_parser/parsers/expression_parser.cpp` - パーサー拡張

##### Phase 2: 型チェック（1日）

- [ ] `?`が付いた式の型が`Result<T, E>`または`Option<T>`であることを確認
- [ ] 関数の戻り値の型が一致することを確認
- [ ] エラー型の互換性チェック

**ファイル変更**:
- `src/backend/type_checker/type_checker.cpp` - 型チェックロジック

##### Phase 3: コード生成/評価（1-2日）

- [ ] 一時変数の生成
- [ ] `is_err()`/`is_none()`チェックの挿入
- [ ] early returnの生成
- [ ] `unwrap()`呼び出しの生成

**ファイル変更**:
- `src/backend/interpreter/evaluator/operators/unary.cpp` - 評価ロジック
- `src/backend/interpreter/handlers/control/return.cpp` - early return処理

##### Phase 4: テスト（1日）

- [ ] 基本的な?オペレーターテスト
- [ ] Result<T, E>でのテスト
- [ ] Option<T>でのテスト
- [ ] async関数での使用テスト
- [ ] エラーケースのテスト

**テストファイル**:
- `tests/cases/error_propagation/test_question_operator_result.cb`
- `tests/cases/error_propagation/test_question_operator_option.cb`
- `tests/cases/error_propagation/test_question_async.cb`
- `tests/integration/error_propagation/test_question_operator.hpp`

---

### 2. タイムアウト機能

**優先度**: 中  
**工数見積**: 小（2-3日）  
**設計ドキュメント**: [docs/features/timeout_design.md](../features/timeout_design.md)

#### 実装ステップ

##### Phase 1: タイマー機能（1日）

- [ ] `create_timer(int ms)` builtin関数の実装
- [ ] Event Loopにタイマー登録機能を追加
- [ ] タイマーコールバックの実装

**ファイル変更**:
- `src/backend/interpreter/event_loop/simple_event_loop.cpp` - タイマー機能
- `src/backend/interpreter/event_loop/simple_event_loop.h` - ヘッダー

##### Phase 2: timeout関数（1日）

- [ ] `stdlib/async/timeout.cb`の実装
- [ ] `timeout<T>(Future<T>, int)` -> `Result<T, string>`の実装
- [ ] エラーメッセージの標準化

**ファイル変更**:
- `stdlib/async/timeout.cb` - 新規作成
- `stdlib/async/mod.cb` - エクスポート追加

##### Phase 3: テスト（1日）

- [ ] 基本的なタイムアウトテスト
- [ ] 速いタスクの成功テスト
- [ ] 遅いタスクのタイムアウトテスト
- [ ] ?オペレーターとの組み合わせテスト

**テストファイル**:
- `tests/cases/async/test_timeout_basic.cb`
- `tests/cases/async/test_timeout_question.cb`
- `tests/integration/async/test_timeout.hpp`

---

## 実装順序

1. **Week 1: ?オペレーター**
   - Day 1-2: パーサー拡張
   - Day 3: 型チェック
   - Day 4-5: コード生成/評価
   - Day 6: テスト

2. **Week 2: タイムアウト機能**
   - Day 1: タイマー機能
   - Day 2: timeout関数
   - Day 3: テスト + ドキュメント更新

---

## 成功基準

### ?オペレーター

- [ ] `Result<T, E>`型で`?`が使用できる
- [ ] `Option<T>`型で`?`が使用できる
- [ ] async関数内で`?`が使用できる
- [ ] 型エラーが適切に検出される
- [ ] 全テストが通過する

### タイムアウト機能

- [ ] `timeout()`関数が正しく動作する
- [ ] タイムアウト時に`Result::Err`が返される
- [ ] タイムアウトしない場合は`Result::Ok`が返される
- [ ] ?オペレーターと組み合わせて使用できる
- [ ] 全テストが通過する

---

## リスク

### 高リスク

- **パーサーの複雑化**: `?`の優先順位と結合性の扱い
  - 軽減策: 既存の後置演算子の実装を参考にする

### 中リスク

- **型推論の複雑化**: `?`を使った式の型推論
  - 軽減策: シンプルなケースから実装し、段階的に拡張

### 低リスク

- **Event Loopの改修**: タイマー機能の追加
  - 軽減策: 既存のsleep実装を参考にする

---

## 依存関係

### ?オペレーター

- **前提条件**:
  - `Result<T, E>`と`Option<T>`の完全実装 ✅
  - async/awaitの安定版 ✅

- **ブロッカー**: なし

### タイムアウト機能

- **前提条件**:
  - `sleep()`関数の実装 ✅
  - Event Loopの基本機能 ✅

- **ブロッカー**: なし

---

## ドキュメント更新

### 更新が必要なドキュメント

- [ ] `docs/spec.md` - ?オペレーターの構文追加
- [ ] `docs/BNF.md` - BNF記法の更新
- [ ] `docs/architecture.md` - 評価器の拡張説明
- [ ] `stdlib/README.md` - timeout関数の追加
- [ ] `release_notes/v0.13.0.md` - リリースノート作成

---

## 参考実装

### ?オペレーター

- **Rust**: `std::ops::Try` trait
- **Swift**: `try?` operator
- **Kotlin**: `?.let` + Elvis operator

### タイムアウト

- **Rust**: `tokio::time::timeout`
- **JavaScript**: `Promise.race`
- **Go**: `context.WithTimeout`

---

## メモ

### 実装の注意点

1. **?オペレーター**:
   - まずは`Result`と`Option`のみサポート
   - カスタム型のサポートは将来版で

2. **タイムアウト**:
   - キャンセル機能は将来版で
   - エラー型は`string`で統一

### 将来の拡張（v0.14.0以降）

- `FromError` trait（エラー型の自動変換）
- `Try` trait（カスタム型サポート）
- `race()` builtin関数
- タイムアウト時のタスクキャンセル

