# Timeoutæ©Ÿèƒ½å®Ÿè£…å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ (v0.12.1)

**å®Ÿè£…æ—¥**: 2025å¹´11æœˆ11æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.12.1  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âš ï¸ åŸºæœ¬å®Ÿè£…å®Œäº†ï¼ˆResultçµ±åˆã¯éƒ¨åˆ†å®Ÿè£…ï¼‰

---

## âœ… å®Ÿè£…å®Œäº†å†…å®¹

### 1. timeout() builtiné–¢æ•°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/interpreter/evaluator/functions/call_impl.cpp`

**å®Ÿè£…å†…å®¹**:
- timeouté–¢æ•°ã‚’ãƒ“ãƒ«ãƒˆã‚¤ãƒ³é–¢æ•°ãƒªã‚¹ãƒˆã«è¿½åŠ  (Line 3112)
- timeouté–¢æ•°ã®å®Ÿè£… (Lines 3329-3434)
  - Future<T>ã‚’ç¬¬1å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’ç¬¬2å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
  - ã‚¿ã‚¹ã‚¯ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’è¨­å®š
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãFutureã‚’è¿”ã™

**ã‚³ãƒ¼ãƒ‰**:
```cpp
if (node->name == "timeout") {
    // å¼•æ•°ãƒã‚§ãƒƒã‚¯
    // Future<T>ã®å–å¾—
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚åˆ»ã®è¨ˆç®—
    // AsyncTaskã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    // Result<T, string>ã‚’è¿”ã™Futureã‚’ä½œæˆ
}
```

### 2. AsyncTaskæ§‹é€ ä½“ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/interpreter/core/interpreter.h`

**è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰** (Lines 456-458):
```cpp
// v0.12.1: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾å¿œ
bool has_timeout = false;   // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
int64_t timeout_ms = 0;     // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚åˆ»ï¼ˆã‚¨ãƒãƒƒã‚¯ã‹ã‚‰ã®ãƒŸãƒªç§’ï¼‰
```

**ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ›´æ–°** (Line 467):
```cpp
AsyncTask()
    : /* ... */, has_timeout(false), timeout_ms(0) {}
```

### 3. Event Loopã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/interpreter/event_loop/simple_event_loop.cpp`

**å®Ÿè£…å†…å®¹** (Lines 229-310):
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’`execute_one_step()`ã«è¿½åŠ 
- ç¾åœ¨æ™‚åˆ»ã®å–å¾—ï¼ˆWindows/POSIXå¯¾å¿œï¼‰
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã®å‡¦ç†:
  - ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†çŠ¶æ…‹ã«ãƒãƒ¼ã‚¯
  - `Result::Err("Timeout")`ã‚’ç”Ÿæˆ
  - Future.is_readyã‚’trueã«è¨­å®š
  - Future.valueã«Resultæ§‹é€ ä½“ã‚’è¨­å®š

**ã‚³ãƒ¼ãƒ‰æ¦‚è¦**:
```cpp
// v0.12.1: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
if (task.has_timeout && !task.is_executed) {
    int64_t current_time_ms = get_current_time();
    
    if (current_time_ms >= task.timeout_ms) {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ
        task.is_executed = true;
        task.return_is_struct = true;
        
        // Result::Err("Timeout")ã‚’ä½œæˆ
        Variable result_var;
        result_var.struct_type_name = "Result";
        result_var.struct_members["tag"] = 1; // Err
        result_var.struct_members["err"].str_value = "Timeout";
        
        // Futureã«è¨­å®š
        task.internal_future.struct_members["is_ready"].value = 1;
        task.internal_future.struct_members["value"] = result_var;
        
        return false; // ã‚¿ã‚¹ã‚¯å®Œäº†
    }
}
```

### 4. ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/cases/async/test_timeout_compile.cb`

**Integration Test**: `tests/integration/async/test_async.hpp` (Test 33)

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- timeouté–¢æ•°ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèª
- åŸºæœ¬çš„ãªFutureå‡¦ç†ã®å‹•ä½œç¢ºèª
- å…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹ç¢ºèª

---

## âš ï¸ åˆ¶é™äº‹é …ã¨æœªå®Œæˆéƒ¨åˆ†

### 1. Resultå‹çµ±åˆã®å•é¡Œ

**ç¾çŠ¶**:
- timeouté–¢æ•°ã¯Futureã‚’è¿”ã™ãŒã€awaitã§Resultå‹ã‚’æ­£ã—ãå–å¾—ã§ããªã„
- TypedValueã¨Variableé–“ã®å‹å¤‰æ›ãŒä¸å®Œå…¨

**ã‚¨ãƒ©ãƒ¼ä¾‹**:
```cb
Result<int, string> r = await timeout(slow_task(), 500);
// âŒ "await expression did not return struct" ã‚¨ãƒ©ãƒ¼
```

### 2. æœªå®Ÿè£…æ©Ÿèƒ½

- âœ… timeout() builtiné–¢æ•°
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯å‡¦ç†
- âš ï¸ Resultå‹ã¸ã®å¤‰æ›ï¼ˆéƒ¨åˆ†å®Ÿè£…ï¼‰
- âŒ ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ã®ã‚µãƒãƒ¼ãƒˆ
- âŒ ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
- âŒ åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### å…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹ âœ…

```
âœ… [1/4] Integration tests: PASSED
âœ… [2/4] Unit tests: PASSED
âœ… [3/4] Stdlib C++ tests: PASSED
âœ… [4/4] Stdlib Cb tests: PASSED

Test suites: 4/4 passed, 0/4 failed
Total Tests: 800+ tests
Success Rate: 100%
```

### Integration Testè¿½åŠ 

- Test 33: v0.12.1 timeout compilation test
- `test_timeout_compile.cb`: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨åŸºæœ¬å‹•ä½œç¢ºèª

---

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (v0.15.0)

### Phase 1: Resultå‹çµ±åˆã®å®Œæˆ ğŸ”´ High Priority

**å¿…è¦ãªä½œæ¥­**:
1. timeouté–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’`Future<Result<T, string>>`ã«ä¿®æ­£
2. awaitæ™‚ã®Resultå‹ã¸ã®å¤‰æ›å‡¦ç†ã‚’å®Ÿè£…
3. TypedValue/Variableå‹å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£
4. åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**:
```cb
async int main() {
    Result<int, string> r = await timeout(slow_task(), 500);
    if (r.is_ok()) {
        println("Success:", r.ok);
    } else {
        println("Error:", r.err);
    }
    return 0;
}
```

### Phase 2: ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ã‚µãƒãƒ¼ãƒˆ ğŸŸ¡ Medium Priority

**å¿…è¦ãªä½œæ¥­**:
1. Genericå‹ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†å®Ÿè£…
2. å‹æ¨è«–ã®æ”¹å–„
3. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¿½åŠ 

### Phase 3: ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ« ğŸŸ¢ Low Priority

**å¿…è¦ãªä½œæ¥­**:
1. ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«APIã®è¨­è¨ˆ
2. ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã®å®Ÿè£…
3. ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### è¨­è¨ˆæ–‡æ›¸
- [timeout_design.md](timeout_design.md) - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½è¨­è¨ˆä»•æ§˜
- [v0.12.1_timeout_status.md](v0.12.1_timeout_status.md) - å®Ÿè£…çŠ¶æ³è©³ç´°

### ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
- [v0.12.1.md](../../release_notes/v0.12.1.md) - v0.12.1ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ

### å®Ÿè£…è¨ˆç”»
- [v0.15.0_untested_behaviors.md](v0.15.0_untested_behaviors.md) - v0.15.0å®Ÿè£…äºˆå®š

---

## æŠ€è¡“ãƒ¡ãƒ¢

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[User Code]
timeout(slow_task(), 500)
    â†“
[call_impl.cpp]
Futureå–å¾— + timeoutè¨­å®š
    â†“
[AsyncTask]
has_timeout = true
timeout_ms = current_time + 500
    â†“
[Event Loop]
execute_one_step()
    â†“
[Timeout Check]
current_time >= timeout_ms?
    â†“ Yes
[Result Generation]
Result::Err("Timeout")
    â†“
[Future Update]
is_ready = true
value = Result
    â†“
âš ï¸ [awaitå‡¦ç†]
â† ã“ã“ã§Resultå‹ã¸ã®å¤‰æ›ãŒæœªå®Œæˆ
```

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

1. **call_impl.cpp** (3è¡Œè¿½åŠ , 106è¡Œè¿½åŠ )
   - timeouté–¢æ•°å®Ÿè£…
   - ãƒ“ãƒ«ãƒˆã‚¤ãƒ³é–¢æ•°ãƒªã‚¹ãƒˆæ›´æ–°

2. **interpreter.h** (4è¡Œè¿½åŠ )
   - AsyncTaskæ§‹é€ ä½“æ‹¡å¼µ
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 

3. **simple_event_loop.cpp** (82è¡Œè¿½åŠ )
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯å‡¦ç†
   - Resultç”Ÿæˆå‡¦ç†

**åˆè¨ˆ**: 195è¡Œè¿½åŠ 

---

## ã¾ã¨ã‚

### âœ… é”æˆäº‹é …

1. timeout() builtiné–¢æ•°ã®å®Ÿè£…
2. Event loopã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
3. åŸºæœ¬çš„ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å‹•ä½œç¢ºèª
4. å…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹ç¶­æŒ

### âš ï¸ æ¬¡å›å®Ÿè£…ãŒå¿…è¦ãªé …ç›®

1. Resultå‹ã¸ã®å®Œå…¨çµ±åˆ
2. ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ã®ã‚µãƒãƒ¼ãƒˆ
3. ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
4. åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ

### ğŸ¯ v0.12.1ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š

**åˆ¤å®š**: âœ… ãƒªãƒªãƒ¼ã‚¹å¯èƒ½ï¼ˆåˆ¶é™äº‹é …ã‚’æ˜è¨˜ï¼‰

**ç†ç”±**:
- åŸºæœ¬æ©Ÿèƒ½ã¯å®Ÿè£…å®Œäº†
- æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ãªã—ï¼ˆå…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹ï¼‰
- åˆ¶é™äº‹é …ã¯æ–‡æ›¸åŒ–æ¸ˆã¿
- æ¬¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®æ”¹å–„è¨ˆç”»ãŒæ˜ç¢º

---

**ä½œæˆè€…**: AI Assistant  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ11æ—¥  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: v0.15.0å®Ÿè£…æ™‚
