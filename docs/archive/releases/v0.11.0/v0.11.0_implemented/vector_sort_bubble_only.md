# Vector<T> ソート実装の修正 (v0.11.0)

## 日付
2025年11月6日

## 概要
Vector<T>のソート実装をハイブリッド方式（バブル/マージ）からバブルソート単一方式に変更しました。

## 変更内容

### 削除された機能
- **マージソートの実装**: `merge_sort_list()` および `merge_two_lists()` メソッドを削除
- **ハイブリッドソート**: `sort()`の条件分岐 (`length <= 20` でバブル、`> 20` でマージ) を削除

### 変更後の実装
- **sort()**: 全データサイズでバブルソートO(n²)を使用
- **smaller()**: 昇順バブルソート（変更なし）
- **greater()**: 降順バブルソート（変更なし）

### 計算量
| メソッド | 変更前 | 変更後 |
|---------|--------|--------|
| `sort()` | O(n log n) ハイブリッド | O(n²) バブルソート |
| `smaller()` | O(n²) | O(n²) (変更なし) |
| `greater()` | O(n²) | O(n²) (変更なし) |

## 技術的背景

### マージソート実装が不可能な理由

Cbインタプリタの現在の制約により、O(n log n)マージソートの実装が技術的に不可能でした:

1. **動的メモリとジェネリック型の組み合わせの制約**
   - `malloc()`で確保した配列から`array_get<T>()`でジェネリック型Tのデータにアクセスすると、セグメンテーションフォルトが発生
   - ASANによる解析結果:
     ```
     AddressSanitizer: SEGV on unknown address 0x211c1f3c1614
     #0 binary_unary.cpp:888 in evaluate_unary_op_typed
     #1 evaluator.cpp:222 in evaluate_typed_expression_internal
     #2 declaration.cpp:1744 in process_variable_declaration
     ```

2. **型付きポインタの制約**
   - `T*`型のポインタキャストが`evaluate_unary_op_typed`でクラッシュ
   - メモリアドレス計算時に不正なメモリアクセスが発生

3. **試行した実装アプローチ**
   - **ボトムアップマージソート（リンクリスト）**: ポインタ操作の複雑さにより無限ループが発生
   - **配列ベースマージソート**: `malloc`配列からのデータアクセスでSEGV
   - **型付きポインタアプローチ**: unary operator評価でSEGV
   - **array_get<T>()アプローチ**: 動的メモリとの組み合わせでSEGV

### バブルソートの利点

1. **安定性**: 全テストケースで安定動作、セグメンテーションフォルトなし
2. **シンプル性**: ポインタ操作のみで実装可能、動的メモリ確保不要
3. **実用性**: 小〜中規模データセット(n < 1000)では実用的なパフォーマンス
4. **機能性**: `call_function_pointer`によるカスタム比較関数を完全サポート

## テスト結果

### 基本テスト (test_all_sorts.cb)
- ✅ Test 1: `smaller()` - 昇順ソート
- ✅ Test 2: `greater()` - 降順ソート
- ✅ Test 3: `sort()` - デフォルト昇順

### 包括テスト (test_vector_sort_complete.cb)
- ✅ Test 1: `vec.smaller()` - 昇順
- ✅ Test 2: `vec.greater()` - 降順
- ✅ Test 3: `vec.sort(&compare_ascending)` - カスタム昇順
- ✅ Test 4: `vec.sort(&compare_descending)` - カスタム降順
- ✅ Test 5: `vec.sort()` - デフォルト昇順

### パフォーマンステスト (test_vector_bubble_performance.cb)
- ✅ 50要素の逆順データ（最悪ケース）- 正常動作
- ✅ 100要素のランダム風データ - 正常動作

## ドキュメント更新

### stdlib/collections/vector.cb ヘッダーコメント
- 計算量の記載を `O(n²)` に修正
- "技術的制約"セクションを追加し、マージソート不可の理由を明記
- ハイブリッドソートの記載を削除

### インターフェース VectorOps<T>
- `merge_sort_list()` および `merge_two_lists()` を削除
- `sort()` の説明を "O(n²) バブルソート" に更新

## 将来の改善案

Cbインタプリタのコア改善により、以下が可能になる可能性があります:

1. **型安全なポインタキャスト**: ジェネリック型Tと動的メモリの安全な組み合わせ
2. **array_get<T>()の最適化**: 動的メモリからの読み取りサポート
3. **メモリアクセスプリミティブ**: 低レベルメモリ操作の改善

これらが実装されれば、O(n log n)マージソートやクイックソートなど、より効率的なアルゴリズムの実装が可能になります。

## 影響範囲

### 破壊的変更
- **なし**: APIは変更されていません
- `sort()`, `smaller()`, `greater()` は全て互換性を保持

### パフォーマンス影響
- **小データ(n ≤ 20)**: 変更なし（元々バブルソート）
- **中データ(20 < n < 1000)**: 許容範囲内のパフォーマンス低下
- **大データ(n ≥ 1000)**: O(n log n)からO(n²)への変更により、理論上パフォーマンス低下

### 推奨事項
- 大規模データセット(n ≥ 1000)のソートは避けるか、事前に分割処理を検討
- 現在のVector<T>は小〜中規模データ向けに最適化されています

## まとめ

今回の修正により:
- ✅ **安定性**: 全テストケースでセグメンテーションフォルトなし
- ✅ **機能性**: `call_function_pointer`による柔軟な比較関数サポート
- ✅ **保守性**: シンプルで理解しやすいバブルソート実装
- ✅ **互換性**: APIの破壊的変更なし

Cbインタプリタの現在の制約を踏まえた、最も実用的で安定した実装となりました。
