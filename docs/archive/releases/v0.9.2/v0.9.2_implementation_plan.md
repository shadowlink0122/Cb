# Cb言語 v0.9.2 実装計画

## リリース予定日
2025年10月末（予定）

## 現状分析（2025年10月9日時点）

### ✅ 既に実装済みの機能
1. **Const Pointer Safety** - v0.9.1で完全実装
2. **多次元配列ポインタ** - v0.9.1で実装（`&matrix[i][j]`）
3. **多重ポインタ** - 既に実装済み（`int**`, `int***`等）
   - テスト確認: `tests/cases/pointer/test_multiple_pointer_params.cb`
   - ダブルポインタ、トリプルポインタの宣言・使用が可能
   - 関数パラメータとしても利用可能

### 📊 コードベース状況
- `recursive_parser.cpp`: **1,388行**（v0.9.1のリファクタリングで既に大幅削減済み）
- `interpreter.cpp`: **1,941行**（v0.9.1で分割済み）
- 統合テスト: **543ファイル**
- リファクタリング: **Phase 5-8完了**（v0.9.1）

### 🎯 v0.9.2の方向性

v0.9.1で大規模リファクタリング（Phase 5-8）が完了し、コードベースは既に良好な状態です。
v0.9.2では以下の3つの柱で進めます：

1. **残存する最適化の実施**
2. **未実装機能の追加**
3. **コード品質の向上**

---

## 🎯 v0.9.2実装計画

### 1. コード最適化・リファクタリング

#### 1.1 interpreter.cppのさらなる分割（優先度: 高）

**現状**: 1,941行のinterpreter.cppが残存

**目標**: 
- `interpreter.cpp`を1,000行以下に削減
- 機能別にファイル分割

**候補ファイル**:
```
src/backend/interpreter/core/
├── interpreter.cpp          (メインクラス、1,000行以下)
├── initialization.cpp       (初期化処理)
├── cleanup.cpp              (クリーンアップ処理)
└── utility.cpp              (ユーティリティ関数)
```

**期待される効果**:
- 保守性向上
- ビルド時間短縮（並列ビルド効率化）
- テストの容易性向上

#### 1.2 TypeHelpersの拡充（優先度: 中）

**現状**: 基本的な型チェック関数のみ

**追加候補**:
```cpp
// 型変換関連
bool canImplicitCast(const std::string& from, const std::string& to);
std::string getCommonType(const std::string& type1, const std::string& type2);

// 型サイズ関連
size_t getTypeSize(const std::string& type);
size_t getTypeAlignment(const std::string& type);

// 配列・ポインタ関連
int getArrayDimensions(const std::string& type);
std::string getBaseType(const std::string& type);
int getPointerLevel(const std::string& type);
```

**期待される効果**:
- コードの重複削減（DRY原則）
- 型システムの一貫性向上
- バグ混入リスク低減

#### 1.3 メモリ管理の最適化（優先度: 中）

**現状分析**:
- 変数スコープ管理が複数箇所に分散
- メモリアクセスパターンの最適化余地

**実施項目**:
1. スコープ管理の統一化
2. 不要な変数コピーの削減
3. メモリアクセスパターンの最適化

**期待される効果**:
- メモリ使用量削減
- 実行速度向上（5-10%目標）

#### 1.4 パーサーの最適化（優先度: 低）

**現状**: recursive_parser.cppは1,388行で許容範囲

**実施項目**:
1. 頻繁に呼ばれる関数のインライン化検討
2. トークン先読みの最適化
3. エラーメッセージ生成の遅延評価

---

### 2. 未実装機能の追加

#### 2.1 配列参照型（優先度: 高）

**概要**: 配列を参照型として扱う機能

**構文**:
```cb
int[5]& ref_arr = arr;  // 配列への参照
ref_arr[0] = 100;       // 元の配列が変更される
```

**実装範囲**:
1. パーサーでの構文サポート
2. 型システムへの統合
3. 参照の正しい伝播
4. エラーチェック（サイズ不一致等）

**テストケース**: 10-15個程度

**期待される効果**:
- 配列を関数に渡す際の利便性向上
- メモリコピーの削減

#### 2.2 構造体配列メンバーの関数戻り値代入（優先度: 中）

**概要**: 関数戻り値を構造体配列メンバーに直接代入

**構文**:
```cb
struct Data {
    int[5] values;
}

int[5] get_values() {
    return {1, 2, 3, 4, 5};
}

Data d;
d.values = get_values();  // 関数戻り値を配列メンバーに代入
```

**実装範囲**:
1. 代入処理の拡張
2. 配列のメモリコピー処理
3. 型チェックの強化

**テストケース**: 8-10個程度

#### 2.3 多次元配列の関数戻り値からメンバー代入（優先度: 中）

**概要**: 多次元配列関数の戻り値から要素を取得して代入

**構文**:
```cb
int[3][3] get_matrix() {
    return {{1,2,3},{4,5,6},{7,8,9}};
}

int x = get_matrix()[1][1];  // 戻り値から直接要素取得
```

**実装範囲**:
1. 一時オブジェクトの管理
2. チェーン処理の最適化
3. メモリ安全性の確保

**テストケース**: 10-12個程度

#### 2.4 動的メモリ管理（優先度: 低）

**概要**: new/delete演算子の実装

**構文**:
```cb
int* ptr = new int;         // 単一要素の動的確保
int* arr = new int[10];     // 配列の動的確保
delete ptr;                 // 解放
delete[] arr;               // 配列の解放
```

**実装範囲**:
1. new/delete演算子の構文解析
2. ヒープメモリ管理機構
3. メモリリーク検出（オプション）
4. ガベージコレクション検討（将来課題）

**注意事項**:
- 大規模な実装が必要
- v0.9.2では基本機能のみ
- v0.10.0で完成を目指す

**テストケース**: 15-20個程度

#### 2.5 キャスト演算子（優先度: 低）

**概要**: 明示的な型変換

**構文**:
```cb
int x = 10;
double y = (double)x;           // C-style cast
double z = static_cast<double>(x);  // C++-style cast（将来）
```

**実装範囲**:
1. C-styleキャストの実装
2. 安全性チェック
3. constキャストの禁止

**テストケース**: 8-10個程度

---

### 3. コード品質向上

#### 3.1 エラーメッセージの改善（優先度: 高）

**現状**: 基本的なエラーメッセージのみ

**改善項目**:
1. **位置情報の詳細化**
   - 行番号だけでなく、列番号も表示
   - エラー箇所のコード抜粋表示
   
2. **修正候補の提案**
   ```
   Error: Unknown variable 'valeu'
   Did you mean 'value'?
   ```

3. **エラーの分類**
   - 構文エラー
   - 型エラー
   - 実行時エラー
   - 警告

**実装工数**: 中程度

#### 3.2 警告システムの追加（優先度: 中）

**追加する警告**:
1. 未使用変数
2. 型の暗黙変換
3. 符号付き/符号なし比較
4. 到達不可能コード
5. 初期化されていない変数の使用

**構文**:
```bash
./main -Wall program.cb     # 全ての警告を有効化
./main -Werror program.cb   # 警告をエラーとして扱う
```

**実装工数**: 大

#### 3.3 デバッグ機能の強化（優先度: 中）

**追加機能**:
1. **変数ウォッチ機能**
   ```cb
   int x = 10;
   @watch(x);  // xの変更を監視
   x = 20;     // Debug: x changed: 10 -> 20
   ```

2. **スタックトレース表示**
   - エラー発生時の関数呼び出し履歴
   
3. **ステップ実行モード**
   ```bash
   ./main --debug program.cb  # ステップ実行モード
   ```

**実装工数**: 大（v0.10.0以降に延期も検討）

#### 3.4 テストカバレッジの向上（優先度: 高）

**現状**: 543個の統合テスト

**目標**:
- 統合テスト: 600個以上
- ユニットテスト: 100個以上
- コードカバレッジ: 80%以上

**追加テスト領域**:
1. エッジケース
2. エラーハンドリング
3. パフォーマンステスト
4. リグレッションテスト

#### 3.5 ドキュメントの充実（優先度: 高）

**追加ドキュメント**:
1. **チュートリアル**
   - 初心者向けガイド
   - サンプルコード集
   
2. **APIリファレンス**
   - 組み込み関数一覧
   - 標準ライブラリ
   
3. **内部実装ドキュメント**
   - アーキテクチャ詳細
   - 各モジュールの責務
   
4. **コントリビューションガイド**
   - コーディング規約
   - PR作成手順

---

## 📋 優先順位付き実装ロードマップ

### Phase 1: 基盤整備（1-2週間）
- [ ] interpreter.cppの分割（1,941行 → 1,000行以下）
- [ ] TypeHelpersの拡充
- [ ] エラーメッセージの改善
- [ ] テストカバレッジ向上

### Phase 2: 新機能実装（2-3週間）
- [ ] 配列参照型（`int[N]&`）
- [ ] 構造体配列メンバーの関数戻り値代入
- [ ] 多次元配列の関数戻り値からメンバー代入

### Phase 3: 品質向上（1-2週間）
- [ ] 警告システムの追加
- [ ] メモリ管理の最適化
- [ ] パーサーの最適化
- [ ] ドキュメントの充実

### Phase 4: 高度な機能（オプション、v0.10.0延期検討）
- [ ] 動的メモリ管理（new/delete）
- [ ] キャスト演算子
- [ ] デバッグ機能強化

---

## 📊 成功指標

### 必須条件
- [ ] 全テスト合格（統合+ユニット）
- [ ] interpreter.cpp 1,000行以下
- [ ] 配列参照型の実装完了
- [ ] エラーメッセージの改善完了
- [ ] リリースノート作成

### 推奨条件
- [ ] 実行速度5-10%向上
- [ ] コードカバレッジ80%以上
- [ ] 警告システム実装
- [ ] ドキュメント更新完了

### 拡張目標（v0.10.0に延期可）
- [ ] 動的メモリ管理実装
- [ ] デバッグ機能強化
- [ ] IDE連携機能

---

## 🔧 実装ガイドライン

### コーディング規約
1. **ファイルサイズ制限**
   - .cpp: 1,500行以下（推奨: 1,000行以下）
   - .h: 500行以下（推奨: 300行以下）

2. **関数サイズ制限**
   - 50行以下（推奨: 30行以下）
   - 複雑度: 10以下

3. **命名規則**
   - 関数: camelCase
   - クラス: PascalCase
   - 定数: UPPER_SNAKE_CASE
   - 変数: snake_case

4. **コメント**
   - 全public関数にDoxygenコメント
   - 複雑なロジックには説明コメント
   - TODOには期限を記載

### テスト戦略
1. **単体テスト優先**
   - 新機能は必ず単体テスト作成
   - TDD（Test-Driven Development）推奨

2. **統合テスト**
   - 各機能に3-5個の統合テスト
   - エッジケースもカバー

3. **リグレッションテスト**
   - 既存機能の動作確認
   - 各コミット前に実行

### コミット規約
```
<type>(<scope>): <subject>

<body>

<footer>
```

**type**:
- feat: 新機能
- fix: バグ修正
- refactor: リファクタリング
- test: テスト追加
- docs: ドキュメント更新
- perf: パフォーマンス改善

---

## 🚨 リスク管理

### 潜在的リスク

1. **実装スコープの肥大化**
   - 確率: 中
   - 影響: 高
   - 対策: Phase分割、v0.10.0への延期検討

2. **パフォーマンス劣化**
   - 確率: 低
   - 影響: 中
   - 対策: 各Phase後にベンチマーク実行

3. **既存機能の破壊**
   - 確率: 低
   - 影響: 高
   - 対策: 全テスト実行の徹底、リグレッションテスト

4. **スケジュール遅延**
   - 確率: 中
   - 影響: 低
   - 対策: 優先度の高い機能に集中、低優先度機能の延期

---

## 📝 ドキュメント更新計画

### 更新対象
1. `release_notes/v0.9.2.md` - リリースノート作成
2. `docs/spec.md` - 新機能の仕様追加
3. `docs/architecture.md` - アーキテクチャ更新
4. `README.md` - バージョン情報更新
5. `docs/tutorial.md` - チュートリアル作成（新規）

---

## 🔗 参考ドキュメント

- `docs/todo/v0.9.2_plan.md` - 旧計画（Phase 5中心）
- `release_notes/v0.9.1.md` - v0.9.1実装内容
- `docs/architecture.md` - 現在のアーキテクチャ
- `docs/spec.md` - 言語仕様書

---

**作成日**: 2025年10月9日  
**バージョン**: v0.9.2  
**ステータス**: 計画策定中  
**担当**: shadowlink0122
