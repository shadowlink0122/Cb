# DRYåŸå‰‡ã¨é«˜é€ŸåŒ–ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´10æœˆ9æ—¥  
**å¯¾è±¡**: Cbã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ v0.9.2ï¼ˆPhase 7å®Œäº†å¾Œï¼‰

## æ¦‚è¦

Phase 7ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†å¾Œã€ã•ã‚‰ãªã‚‹æ”¹å–„ã®æ©Ÿä¼šã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®åˆ†æã€‚
DRYï¼ˆDon't Repeat Yourselfï¼‰åŸå‰‡ã®é©ç”¨ã¨å®Ÿè¡Œé€Ÿåº¦ã®æœ€é©åŒ–ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚

## ç¾åœ¨ã®çŠ¶æ…‹

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºä¸Šä½15ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | å„ªå…ˆåº¦ | å‚™è€ƒ |
|---------|------|--------|------|
| evaluator/functions/call_impl.cpp | 2,128 | ğŸ”´ é«˜ | é–¢æ•°å‘¼ã³å‡ºã—å®Ÿè£… |
| managers/arrays/manager.cpp | 2,107 | ğŸ”´ é«˜ | é…åˆ—ãƒãƒãƒ¼ã‚¸ãƒ£ |
| core/interpreter.cpp | 1,960 | ğŸŸ¡ ä¸­ | ã‚³ã‚¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ |
| managers/variables/declaration.cpp | 1,705 | ğŸŸ¡ ä¸­ | å¤‰æ•°å®£è¨€ |
| managers/structs/assignment.cpp | 1,631 | ğŸŸ¡ ä¸­ | æ§‹é€ ä½“ä»£å…¥ |
| managers/variables/initialization.cpp | 1,506 | ğŸŸ¡ ä¸­ | å¤‰æ•°åˆæœŸåŒ– |
| output/output_manager.cpp | 1,415 | ğŸŸ¢ ä½ | å‡ºåŠ›ç®¡ç†ï¼ˆä¸»ã«switchæ–‡ï¼‰ |
| managers/variables/manager.cpp | 1,170 | ğŸŸ¢ ä½ | å¤‰æ•°ãƒãƒãƒ¼ã‚¸ãƒ£ |
| executors/statement_executor.cpp | 1,032 | âœ… OK | Phase 7ã§æœ€é©åŒ–æ¸ˆã¿ |

### é‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º

1. **å‹ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³**: `.type == TYPE_*` ãŒ242å›å‡ºç¾
2. **ç¯„å›²ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ—**: æœ€é©åŒ–ã®ä½™åœ°ã‚ã‚Š
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆErrorHandlerã‚’ä½¿ç”¨ï¼‰

## å„ªå…ˆé †ä½ä»˜ãã®æ”¹å–„ææ¡ˆ

### ğŸ”´ å„ªå…ˆåº¦ï¼šé«˜

#### 1. call_impl.cpp (2,128è¡Œ) ã®æœ€é©åŒ–

**å•é¡Œç‚¹**:
- å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡é›‘ãªé–¢æ•°å‘¼ã³å‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ãŒé›†ä¸­
- ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã€çµ„ã¿è¾¼ã¿é–¢æ•°ãŒæ··åœ¨

**ææ¡ˆ**:
```
evaluator/functions/
â”œâ”€â”€ call_impl.cpp (ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯) â†’ ~500è¡Œ
â”œâ”€â”€ method_call.cpp (ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—) â†’ ~600è¡Œ
â”œâ”€â”€ function_pointer_call.cpp (é–¢æ•°ãƒã‚¤ãƒ³ã‚¿) â†’ ~400è¡Œ
â””â”€â”€ builtin_functions.cpp (çµ„ã¿è¾¼ã¿é–¢æ•°) â†’ ~600è¡Œ
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- å¯èª­æ€§å‘ä¸Š
- ä¸¦è¡Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–
- ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

#### 2. arrays/manager.cpp (2,107è¡Œ) ã®æœ€é©åŒ–

**å•é¡Œç‚¹**:
- é…åˆ—ã®ã‚³ãƒ”ãƒ¼ã€åˆæœŸåŒ–ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒ1ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ä¸­
- å¤šæ¬¡å…ƒé…åˆ—å‡¦ç†ã®é‡è¤‡ã‚³ãƒ¼ãƒ‰

**ææ¡ˆ**:
```
managers/arrays/
â”œâ”€â”€ manager.cpp (ã‚³ã‚¢API) â†’ ~500è¡Œ
â”œâ”€â”€ copy.cpp (é…åˆ—ã‚³ãƒ”ãƒ¼) â†’ ~400è¡Œ
â”œâ”€â”€ initialization.cpp (åˆæœŸåŒ–) â†’ ~600è¡Œ
â””â”€â”€ multidim.cpp (å¤šæ¬¡å…ƒé…åˆ—å°‚ç”¨) â†’ ~600è¡Œ
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- é…åˆ—æ“ä½œã®æ˜ç¢ºãªåˆ†é›¢
- å¤šæ¬¡å…ƒé…åˆ—å‡¦ç†ã®æœ€é©åŒ–æ©Ÿä¼š

### ğŸŸ¡ å„ªå…ˆåº¦ï¼šä¸­

#### 3. å‹ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®å°å…¥

**å•é¡Œç‚¹**:
- `.type == TYPE_*` ãŒ242å›ç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ã‚‹
- å‹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†æ•£

**ææ¡ˆ**:
```cpp
// src/common/type_helpers.h
namespace TypeHelpers {
    inline bool isInteger(const TypedValue& val) {
        return val.type == TYPE_TINY || val.type == TYPE_SHORT || 
               val.type == TYPE_INT || val.type == TYPE_LONG;
    }
    
    inline bool isFloating(const TypedValue& val) {
        return val.type == TYPE_FLOAT || val.type == TYPE_DOUBLE;
    }
    
    inline bool isNumeric(const TypedValue& val) {
        return isInteger(val) || isFloating(val);
    }
    
    inline bool isPointer(const TypedValue& val) {
        return val.type == TYPE_POINTER;
    }
    
    inline bool isArray(const TypedValue& val) {
        return val.type == TYPE_ARRAY;
    }
    
    inline bool isStruct(const TypedValue& val) {
        return val.type == TYPE_STRUCT;
    }
}
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š
- å‹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€å…ƒç®¡ç†
- å°†æ¥çš„ãªå‹ã‚·ã‚¹ãƒ†ãƒ æ‹¡å¼µãŒå®¹æ˜“

#### 4. å¤‰æ•°ãƒãƒãƒ¼ã‚¸ãƒ£ã®ã•ã‚‰ãªã‚‹æ•´ç†

**managers/variables/** ã®æ§‹é€ ã¯è‰¯ã„ãŒã€ã•ã‚‰ã«æ”¹å–„ã®ä½™åœ°:

**ææ¡ˆ**:
- `declaration.cpp` (1,705è¡Œ) â†’ è¤‡é›‘ãªå®£è¨€å‡¦ç†ã‚’åˆ†å‰²
  - `array_declaration.cpp` (é…åˆ—å°‚ç”¨)
  - `struct_declaration.cpp` (æ§‹é€ ä½“å°‚ç”¨)
  - `simple_declaration.cpp` (åŸºæœ¬å‹)

### ğŸŸ¢ å„ªå…ˆåº¦ï¼šä½ï¼ˆå°†æ¥ã®æ”¹å–„ï¼‰

#### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**æ–‡å­—åˆ—æ“ä½œ**:
- `std::string` ã®ä¸è¦ãªã‚³ãƒ”ãƒ¼ã‚’å‰Šæ¸›
- `const std::string&` ã®æ´»ç”¨
- `std::string_view` ã®å°å…¥ï¼ˆC++17ï¼‰

**ãƒ«ãƒ¼ãƒ—æœ€é©åŒ–**:
```cpp
// Before (æ¯å›size()ã‚’å‘¼ã¶)
for (size_t i = 0; i < vec.size(); i++) { ... }

// After (size()ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
const size_t size = vec.size();
for (size_t i = 0; i < size; i++) { ... }

// Best (ç¯„å›²ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ—)
for (const auto& item : vec) { ... }
```

**ãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³**:
- `std::vector::reserve()` ã®æ´»ç”¨
- é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹å°ã•ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚¿ãƒƒã‚¯å‰²ã‚Šå½“ã¦

#### 6. ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚æœ€é©åŒ–

**ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–**:
```cpp
// é »ç¹ã«å‘¼ã°ã‚Œã‚‹å°ã•ãªé–¢æ•°
inline TypedValue get_variable_value(const std::string& name) { ... }
```

**constexpr ã®æ´»ç”¨**:
```cpp
constexpr int MAX_ARRAY_DIMENSIONS = 10;
constexpr size_t DEFAULT_STACK_SIZE = 1024;
```

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 8: DRYæ”¹å–„ï¼ˆæ¨å®š: 2-3æ—¥ï¼‰

**Step 1**: å‹ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®å°å…¥
- `src/common/type_helpers.h` ä½œæˆ
- å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ `.type == TYPE_*` ã‚’ç½®æ›
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§æ¤œè¨¼

**Step 2**: call_impl.cpp ã®åˆ†å‰²
- 4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²
- ãƒ“ãƒ«ãƒ‰ç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

**Step 3**: arrays/manager.cpp ã®åˆ†å‰²
- 4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²
- çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### Phase 9: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆæ¨å®š: 1-2æ—¥ï¼‰

**Step 1**: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
- `gprof` ã¾ãŸã¯ `perf` ã§ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆç‰¹å®š
- ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®ä½œæˆ

**Step 2**: æ–‡å­—åˆ—æ“ä½œã®æœ€é©åŒ–
- ä¸è¦ãªã‚³ãƒ”ãƒ¼ã®å‰Šæ¸›
- `std::string_view` ã®å°å…¥

**Step 3**: ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ¢ãƒªã®æœ€é©åŒ–
- ãƒ«ãƒ¼ãƒ—ã®æœ€é©åŒ–
- `reserve()` ã®è¿½åŠ 

## æ¸¬å®šæŒ‡æ¨™

### ãƒ“ãƒ«ãƒ‰æ™‚é–“
- **ç¾åœ¨**: æ¸¬å®šãŒå¿…è¦
- **ç›®æ¨™**: 20%å‰Šæ¸›

### å®Ÿè¡Œé€Ÿåº¦
- **ç¾åœ¨**: æ¸¬å®šãŒå¿…è¦
- **ç›®æ¨™**: 10-15%å‘ä¸Š

### ã‚³ãƒ¼ãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- **ç¾åœ¨**: æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º 2,128è¡Œ
- **ç›®æ¨™**: å…¨ãƒ•ã‚¡ã‚¤ãƒ« 1,500è¡Œä»¥ä¸‹

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ã“ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. â³ Phase 8 ã®è©³ç´°è¨ˆç”»ä½œæˆ
3. â³ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®å®Ÿè£…
4. â³ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã®å®Ÿè¡Œ
5. â³ å‹ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®å®Ÿè£…ã‹ã‚‰é–‹å§‹

## å‚è€ƒè³‡æ–™

- [C++ Core Guidelines](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines)
- [Effective Modern C++](https://www.oreilly.com/library/view/effective-modern-c/9781491908419/)
- Phase 7å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ: `docs/archive/refactoring/phases/phase7_refactoring_complete_report.md`

---

**ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**: ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å®Ÿè£…ã®é€²æ—ã«å¿œã˜ã¦æ›´æ–°
