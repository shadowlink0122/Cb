# v0.13.0 ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

## FFI (Foreign Function Interface)

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```cb
// C/C++ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢æ•°ã‚’å®£è¨€
use foreign.m {
    double sqrt(double x);
    double pow(double base, double exp);
}

void main() {
    double r = m.sqrt(25.0);
    println(r);  // 5.0
}
```

### C++ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½œæˆ

```cpp
// mylib.cpp
extern "C" {
    int add(int a, int b) {
        return a + b;
    }
}
```

```bash
# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« (macOS)
clang++ -shared -fPIC mylib.cpp -o libmylib.dylib

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é…ç½®
cp libmylib.dylib stdlib/foreign/
```

```cb
// Cbå´ã§ä½¿ç”¨
use foreign.mylib {
    int add(int a, int b);
}

void main() {
    int result = mylib.add(10, 20);
    println(result);  // 30
}
```

### å¯¾å¿œã—ã¦ã„ã‚‹å‹

| Cbå‹ | C/C++å‹ |
|------|---------|
| `int` | `int` |
| `long` | `long` |
| `double` | `double` |
| `float` | `float` |
| `void` | `void` |

### å¯¾å¿œã—ã¦ã„ã‚‹è¨€èª

- âœ… C
- âœ… C++ (extern "C" ãŒå¿…è¦)
- âœ… Rust (#[no_mangle] + extern "C")
- âœ… Zig (export fn)
- âœ… Go (//export)

## ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µ

### æ¡ä»¶ä»˜ãã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```cb
#define DEBUG

#ifdef DEBUG
    void log(string msg) {
        println("[DEBUG]", msg);
    }
#else
    void log(string msg) { }
#endif

void main() {
    log("Application started");
}
```

### çµ„ã¿è¾¼ã¿ãƒã‚¯ãƒ­

```cb
void main() {
    println("File:", __FILE__);       // ãƒ•ã‚¡ã‚¤ãƒ«å
    println("Line:", __LINE__);       // è¡Œç•ªå·
    println("Date:", __DATE__);       // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ—¥ä»˜
    println("Time:", __TIME__);       // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚åˆ»
    println("Version:", __VERSION__); // 0.13.0
}
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–

```cb
#define MAX_SIZE 1024        // å®šç¾©
#undef MAX_SIZE              // å‰Šé™¤

#ifdef FEATURE_X             // å®šç¾©æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
    // ã‚³ãƒ¼ãƒ‰
#endif

#ifndef FEATURE_Y            // æœªå®šç¾©ãƒã‚§ãƒƒã‚¯
    // ã‚³ãƒ¼ãƒ‰
#endif

#ifdef PLATFORM_A
    // ã‚³ãƒ¼ãƒ‰
#elseif PLATFORM_B
    // ã‚³ãƒ¼ãƒ‰
#else
    // ã‚³ãƒ¼ãƒ‰
#endif

#error "This is an error"    // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
#warning "This is a warning" // è­¦å‘Š
```

## Cé¢¨ãƒã‚¯ãƒ­

### å®šæ•°ãƒã‚¯ãƒ­

```cb
#define PI 3.14159265359
#define MAX_BUFFER 1024
#define APP_NAME "MyApp"

void main() {
    double area = PI * r * r;
    int buffer[MAX_BUFFER];
    println(APP_NAME);
}
```

### é–¢æ•°ãƒã‚¯ãƒ­

```cb
#define MAX(a, b) ((a) > (b) ? (a) : (b))
#define MIN(a, b) ((a) < (b) ? (a) : (b))
#define SQUARE(x) ((x) * (x))

void main() {
    int max_val = MAX(10, 20);  // 20
    int sq = SQUARE(5);         // 25
}
```

### è¤‡æ•°è¡Œãƒã‚¯ãƒ­

```cb
#define DEBUG_PRINT(msg) \
    do { \
        println("[DEBUG]", __FILE__, ":", __LINE__, ":", msg); \
    } while(0)

void main() {
    DEBUG_PRINT("Application started");
}
```

### å¯å¤‰é•·å¼•æ•°ãƒã‚¯ãƒ­

```cb
#define LOG(level, ...) \
    println("[" + level + "]", __VA_ARGS__)

void main() {
    LOG("INFO", "Server started");
    LOG("ERROR", "Connection failed:", "timeout");
}
```

## VSCodeæ‹¡å¼µæ©Ÿèƒ½

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
code --install-extension vscode-extension/cb-language-0.13.0.vsix
```

### æ©Ÿèƒ½

- âœ… ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆãƒˆã‚°ãƒ« (Ctrl+/ ã¾ãŸã¯ Cmd+/)
- âœ… ãƒ–ãƒ­ãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆ (Shift+Alt+A)
- âœ… è‡ªå‹•æ‹¬å¼§é–‰ã˜
- âœ… ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
- âœ… ã‚³ãƒ¼ãƒ‰æŠ˜ã‚ŠãŸãŸã¿

### å¯¾å¿œã—ã¦ã„ã‚‹æ§‹æ–‡

```cb
// æ–‡å­—åˆ—è£œé–“
string msg = "Hello, {name}!";

// ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹
Vec<int> numbers;
Option<Result<int, string>> result;

// Async/Await
async int compute() {
    yield;
    return 42;
}

// ã‚³ãƒ¡ãƒ³ãƒˆ
// å˜ä¸€è¡Œã‚³ãƒ¡ãƒ³ãƒˆ

/*
 * è¤‡æ•°è¡Œã‚³ãƒ¡ãƒ³ãƒˆ
 */
```

## ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ

### ãƒ“ãƒ«ãƒ‰

```bash
# ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
make clean && make -j4

# ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ (Address Sanitizer)
make asan
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
make test

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
./main tests/integration/cases/ffi/math_functions.cb
```

### ã‚µãƒ³ãƒ—ãƒ«ã®å®Ÿè¡Œ

```bash
# FFI C++ã‚µãƒ³ãƒ—ãƒ«
./main sample/ffi_cpp_example.cb
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### FFIã‚¨ãƒ©ãƒ¼: "Failed to load library"

**å•é¡Œ**: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚‰ãªã„

**è§£æ±ºç­–**:
```bash
# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
ls -la stdlib/foreign/libmylib.dylib

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç¢ºèª
file stdlib/foreign/libmylib.dylib

# æ­£ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
clang++ -shared -fPIC mylib.cpp -o libmylib.dylib
```

### FFIã‚¨ãƒ©ãƒ¼: "Unsupported function signature"

**å•é¡Œ**: é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ãŒå¯¾å¿œã—ã¦ã„ãªã„

**è§£æ±ºç­–**: å¯¾å¿œã—ã¦ã„ã‚‹ã‚·ã‚°ãƒãƒãƒ£ã‚’ä½¿ç”¨
- `int func()`
- `int func(int)`
- `int func(int, int)`
- `double func(double)`
- `double func(double, double)`
- `double func(double, double, double, double)`
- `long func(int)`
- `void func()`
- `void func(int)`

### VSCodeæ‹¡å¼µãŒå‹•ä½œã—ãªã„

**è§£æ±ºç­–**:
```bash
# æ‹¡å¼µæ©Ÿèƒ½ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
code --uninstall-extension cb-language
code --install-extension vscode-extension/cb-language-0.13.0.vsix

# VSCodeã‚’å†èµ·å‹•
```

## ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
cat .cbversion

# ãƒ“ãƒ«ãƒ‰æƒ…å ±
make --version

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
make clean

# çµ±åˆãƒ†ã‚¹ãƒˆ
make test

# ãƒ˜ãƒ«ãƒ—
./main --help
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
Cb/
â”œâ”€â”€ src/                    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ frontend/           # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â””â”€â”€ preprocessor/   # ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µ
â”‚   â””â”€â”€ backend/
â”‚       â””â”€â”€ interpreter/
â”‚           â””â”€â”€ ffi_manager.*  # FFIå®Ÿè£…
â”œâ”€â”€ stdlib/                 # æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â””â”€â”€ foreign/            # FFIãƒ©ã‚¤ãƒ–ãƒ©ãƒªé…ç½®å…ˆ
â”œâ”€â”€ sample/                 # ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ ffi_cpp_example.cpp
â”‚   â””â”€â”€ ffi_cpp_example.cb
â”œâ”€â”€ tests/                  # ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
â”œâ”€â”€ vscode-extension/       # VSCodeæ‹¡å¼µæ©Ÿèƒ½
â”œâ”€â”€ docs/                   # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ FFI_GUIDE.md
â”‚   â”œâ”€â”€ FFI_CPP_INTEGRATION.md
â”‚   â””â”€â”€ V0.13.0_COMPLETION_SUMMARY.md
â””â”€â”€ release_notes/          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
    â””â”€â”€ v0.13.0.md
```

## ã‚ˆãã‚ã‚‹è³ªå• (FAQ)

### Q: FFIã§è¤‡é›‘ãªC++ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ãˆã¾ã™ã‹ï¼Ÿ

**A**: ã¯ã„ï¼`extern "C"` ã§ãƒ©ãƒƒãƒ—ã™ã‚Œã°ä½¿ç”¨å¯èƒ½ã§ã™ã€‚è©³ç´°ã¯ `docs/FFI_CPP_INTEGRATION.md` ã‚’å‚ç…§ã€‚

### Q: ã©ã®è¨€èªã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ãˆã¾ã™ã‹ï¼Ÿ

**A**: C ABIã‚’å…¬é–‹ã§ãã‚‹ä»»æ„ã®è¨€èªï¼ˆC, C++, Rust, Zig, Go, Assembly ãªã©ï¼‰

### Q: ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã¯æ¨™æº–Cã¨åŒã˜ã§ã™ã‹ï¼Ÿ

**A**: åŸºæœ¬çš„ã«åŒã˜ã§ã™ãŒã€`#elif` ã®ä»£ã‚ã‚Šã« `#elseif` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### Q: VSCodeæ‹¡å¼µæ©Ÿèƒ½ã¯ã©ã“ã§å…¥æ‰‹ã§ãã¾ã™ã‹ï¼Ÿ

**A**: `vscode-extension/cb-language-0.13.0.vsix` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯å°†æ¥çš„ã«ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã§å…¬é–‹äºˆå®šã€‚

## ãƒªã‚½ãƒ¼ã‚¹

- ğŸ“– **FFI_GUIDE.md** - FFIã®è©³ç´°ã‚¬ã‚¤ãƒ‰
- ğŸ“– **FFI_CPP_INTEGRATION.md** - C++çµ±åˆã‚¬ã‚¤ãƒ‰
- ğŸ“– **V0.13.0_COMPLETION_SUMMARY.md** - å®Ÿè£…å®Œäº†ã‚µãƒãƒªãƒ¼
- ğŸ“‹ **release_notes/v0.13.0.md** - ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
- ğŸ’» **sample/** - ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
- ğŸ§ª **tests/** - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

---

**Cbè¨€èª v0.13.0 - å…¨æ©Ÿèƒ½å®Ÿè£…å®Œäº†ï¼** ğŸ‰
