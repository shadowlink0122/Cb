# 実装の問題点と改善計画

## 📋 現状の問題点

### 1. テスト構造の問題
- ❌ ポインタテストが integration/main.cpp に登録されていない
- ❌ expected_output.txt 形式ではなく、hpp形式のテストが必要
- ❌ テストケースが不完全（基本的な動作のみ）

### 2. 構造体メンバーへのインクリメント/デクリメント
```cb
struct Counter {
    int value;
}

Counter c;
c.value++;  // ❌ 現在エラー: "Expected '=' or '(' after member access"
```

**問題**: 構造体メンバーへの`++`/`--`演算子が未サポート

### 3. impl内での構造体メンバー操作
```cb
impl SomeInterface for SomeStruct {
    void increment() {
        self.value++;  // ❌ impl内でもサポートされるべき
    }
}
```

### 4. ポインタ・参照の再帰的サポート不足

#### 4.1 構造体メンバーとしてのポインタ
```cb
struct Node {
    int value;
    Node* next;  // ❌ 構造体のポインタメンバー未サポート
}
```

#### 4.2 関数引数としてのポインタ
```cb
void func(int* ptr) { }  // ✅ 基本的にはサポート済み
void func(int** ptr) { }  // ⚠️ テストが不足
void func(int* ptr, int** ptr2, int*** ptr3) { }  // ⚠️ 複数ポインタ引数のテスト不足
```

#### 4.3 関数戻り値としてのポインタ
```cb
int* getPointer() {
    int* ptr = &some_var;
    return ptr;  // ⚠️ ポインタの戻り値のテスト不足
}
```

#### 4.4 配列要素としてのポインタ
```cb
int*[10] ptr_array;  // ❌ ポインタ配列未サポート？
```

### 5. 浮動小数点数の再帰的サポート不足

#### 5.1 構造体メンバーとしての浮動小数点
```cb
struct Point {
    float x;
    float y;
    double z;
}

Point p;
p.x++;  // ⚠️ テスト不足
```

#### 5.2 関数引数・戻り値としての浮動小数点
```cb
float add(float a, float b) {
    return a + b;
}

double* getDoublePtr() { }  // ❌ double*のテスト不足
```

#### 5.3 配列での浮動小数点
```cb
float[10] float_array;
double[10] double_array;
```

### 6. 参照の実装状況
```cb
int& ref = value;  // ⚠️ パーサーはサポートしているが、実装・テスト不足
```

### 7. 複合型の組み合わせ
```cb
struct Data {
    int* ptr;
    float value;
    double* d_ptr;
}

Data* data_ptr;  // ❌ 構造体ポインタ
data_ptr->value;  // ❌ アロー演算子未実装
```

---

## 🎯 改善計画

### フェーズ1: テスト構造の修正（優先度: 最高）

#### 1.1 ポインタテスト用hppファイルの作成
- `tests/integration/pointer/pointer_tests.hpp` を作成
- 既存のテストケースを hpp 形式に変換
- main.cpp に登録

#### 1.2 テストケースの拡充
以下のテストケースを追加：

**基本ポインタ操作**
- [x] アドレス演算子 (&)
- [x] 間接参照 (*)
- [x] nullptr
- [ ] ポインタの比較 (==, !=)
- [ ] ポインタの NULL チェック

**関数とポインタ**
- [x] ポインタを引数に取る関数
- [ ] ポインタを返す関数
- [ ] 複数のポインタ引数
- [ ] ダブルポインタ引数
- [ ] トリプルポインタ引数

**構造体とポインタ**
- [ ] 構造体メンバーとしてのポインタ
- [ ] 構造体へのポインタ
- [ ] アロー演算子 (->)
- [ ] ネストされた構造体ポインタ

**配列とポインタ**
- [ ] ポインタ配列
- [ ] 配列へのポインタ
- [ ] 多次元配列とポインタ

**浮動小数点とポインタ**
- [ ] float*
- [ ] double*
- [ ] quad*

### フェーズ2: 構造体メンバーへのインクリメント/デクリメント（優先度: 高）

#### 2.1 問題の所在
- `recursive_parser.cpp` の `parseAssignment()` で構造体メンバーへの `++`/`--` を認識できない
- パーサーが `obj.member++` を正しく解析できない

#### 2.2 修正方針
1. `parsePostfix()` で `AST_MEMBER_ACCESS` の後に `++`/`--` をチェック
2. `AST_POST_INCDEC` ノードを生成
3. インタープリタで構造体メンバーへのインクリメント/デクリメントを実装

#### 2.3 必要なテストケース
```cb
// 基本的なインクリメント
struct Counter { int value; }
Counter c;
c.value++;
c.value--;
++c.value;
--c.value;

// 浮動小数点
struct FloatData { float x; double y; }
FloatData f;
f.x++;
f.y--;

// impl内
impl SomeInterface for Counter {
    void increment() {
        self.value++;
    }
}
```

### フェーズ3: impl内での構造体メンバー操作（優先度: 高）

#### 3.1 問題の所在
- impl内での `self.member++` が未サポート
- `self` の扱いが特殊なため、通常の構造体メンバーアクセスと異なる処理が必要

#### 3.2 修正方針
1. impl内のコンテキストを識別
2. `self.member++` を `AST_MEMBER_ACCESS` + `AST_POST_INCDEC` として解析
3. インタープリタでselfの実体を正しく更新

### フェーズ4: ポインタ・参照の完全サポート（優先度: 中）

#### 4.1 構造体メンバーとしてのポインタ
**修正箇所**:
- `recursive_parser.cpp`: 構造体定義内でのポインタメンバー宣言
- `interpreter.cpp`: 構造体メンバーへのポインタ代入・アクセス

#### 4.2 アロー演算子 (->)
**修正箇所**:
- `recursive_lexer.cpp`: `->` トークンは既に追加済み
- `recursive_parser.cpp`: `parsePostfix()` で `->` 演算子を処理
- `interpreter.cpp`: `ptr->member` を `(*ptr).member` として評価

#### 4.3 ポインタの戻り値
**修正箇所**:
- `recursive_parser.cpp`: 関数宣言で戻り値型としてのポインタをサポート
- `interpreter.cpp`: ポインタの戻り値を正しく返す

### フェーズ5: 浮動小数点の完全サポート（優先度: 中）

#### 5.1 構造体メンバーとしての浮動小数点
- 既に基本的にはサポート済み
- インクリメント/デクリメントのテストが必要

#### 5.2 ポインタと浮動小数点の組み合わせ
```cb
float* f_ptr;
double* d_ptr;
*f_ptr = 3.14f;
*d_ptr = 2.718;
```

### フェーズ6: 配列の高度なサポート（優先度: 低）

#### 6.1 ポインタ配列
```cb
int*[10] ptr_array;
ptr_array[0] = &some_int;
```

#### 6.2 配列へのポインタ
```cb
int (*arr_ptr)[10];
```

---

## 📝 実装の優先順位

### 最優先（今すぐ実施）
1. ✅ テスト構造の修正
   - pointer_tests.hpp の作成
   - main.cpp への登録
   - 既存テストの hpp 化

### 高優先度（次に実施）
2. ⚠️ 構造体メンバーへのインクリメント/デクリメント
   - パーサーの修正
   - インタープリタの修正
   - テストケースの追加

3. ⚠️ impl内での構造体メンバー操作
   - self の正しい処理
   - テストケースの追加

### 中優先度
4. ⚠️ ポインタの完全サポート
   - 構造体メンバーとしてのポインタ
   - アロー演算子
   - ポインタの戻り値

5. ⚠️ 浮動小数点の完全サポート
   - 構造体メンバーでのインクリメント/デクリメント
   - ポインタとの組み合わせ

### 低優先度
6. ⚠️ 配列の高度なサポート
   - ポインタ配列
   - 配列へのポインタ

---

## 🔧 実装アプローチ

### ステップ1: テスト構造の修正
1. `tests/integration/pointer/pointer_tests.hpp` を作成
2. 各カテゴリのテスト関数を実装
3. `main.cpp` に登録
4. すべてのテストが実行されることを確認

### ステップ2: パーサーの修正
1. `parsePostfix()` でメンバーアクセス後のインクリメント/デクリメントを処理
2. AST構築の確認
3. デバッグ出力での確認

### ステップ3: インタープリタの修正
1. 構造体メンバーへのインクリメント/デクリメント処理
2. impl内でのself.memberの正しい更新
3. ポインタ・浮動小数点での動作確認

### ステップ4: 追加機能の実装
1. 構造体メンバーとしてのポインタ
2. アロー演算子
3. ポインタの戻り値
4. その他の高度な機能

---

## 📊 テストカバレッジ目標

### 現在のカバレッジ（推定）
- ポインタ基本操作: 60%
- 構造体とポインタ: 10%
- 関数とポインタ: 40%
- 浮動小数点: 70%
- インクリメント/デクリメント: 40%

### 目標カバレッジ
- ポインタ基本操作: 95%
- 構造体とポインタ: 90%
- 関数とポインタ: 90%
- 浮動小数点: 95%
- インクリメント/デクリメント: 95%

---

## 🎯 まとめ

**即座に取り組むべきこと**:
1. テスト構造の修正（pointer_tests.hpp作成）
2. 構造体メンバーへのインクリメント/デクリメント
3. テストケースの大幅な拡充

**段階的に取り組むべきこと**:
1. impl内での正しい操作
2. ポインタの完全サポート
3. 浮動小数点の完全サポート

この計画に従って、まずテスト構造の修正から始めます。
