// éåŒæœŸå‡¦ç†ã®è¦–è¦šçš„ãƒ‡ãƒ¢ - async/awaitãŒå®Ÿéš›ã«å‹•ä½œã™ã‚‹æ§˜å­ã‚’ç¢ºèª

import stdlib.std.future;

// ========================================
// ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ - æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹
// ========================================
async int countdown_task(string name, int seconds) {
    println("[START] {name} - {seconds}ç§’ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹");
    
    int count = seconds;
    while (count > 0) {
        println("  [{name}] {count}...");
        await sleep(1000);  // éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°sleep
        count = count - 1;
    }
    
    println("[COMPLETE] {name} - ç™ºå°„!");
    return seconds;
}

void demo_countdown() {
    println("\n=== ãƒ‡ãƒ¢1a: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰ ===");
    println("3ã¤ã®ãƒ­ã‚±ãƒƒãƒˆãŒåŒæ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™\n");
    println("ğŸ’¡ ãƒ‘ã‚¿ãƒ¼ãƒ³: Futureã‚’å…ˆã«ä½œæˆã—ã¦ã‹ã‚‰çµæœã‚’å¾…ã¤");
    println("   â†’ å…¨ã‚¿ã‚¹ã‚¯ãŒä¸¦è¡Œå®Ÿè¡Œã•ã‚Œã€æœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ã®æ™‚é–“ã§å®Œäº†\n");
    
    long start = now();
    
    // å…¨ã‚¿ã‚¹ã‚¯ã‚’å…ˆã«ç™»éŒ²ï¼ˆã“ã®é–“ã«printlnã‚’æŒŸã¾ãªã„ï¼‰
    Future<int> rocket1 = countdown_task("ãƒ­ã‚±ãƒƒãƒˆA", 5);
    Future<int> rocket2 = countdown_task("ãƒ­ã‚±ãƒƒãƒˆB", 3);
    Future<int> rocket3 = countdown_task("ãƒ­ã‚±ãƒƒãƒˆC", 4);
    
    println("[REGISTERED] å…¨ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²å®Œäº†ï¼ˆä¸¦è¡Œå®Ÿè¡Œé–‹å§‹ï¼‰\n");
    
    int r1 = await rocket1;  // æœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ãªã®ã§ç´„5ç§’å¾…ã¤
    int r2 = await rocket2;  // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹ã®ã§å³åº§ã«è¿”ã‚‹
    int r3 = await rocket3;  // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹ã®ã§å³åº§ã«è¿”ã‚‹
    
    long end = now();
    
    println("\n--- çµæœ ---");
    println("ãƒ­ã‚±ãƒƒãƒˆA: {r1}ç§’");
    println("ãƒ­ã‚±ãƒƒãƒˆB: {r2}ç§’");
    println("ãƒ­ã‚±ãƒƒãƒˆC: {r3}ç§’");

    println("å®Ÿéš›ã®å®Ÿè¡Œæ™‚é–“: {end - start}msï¼ˆç´„5000ms = æœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ã®æ™‚é–“ï¼‰");
}

void demo_countdown_sequential() {
    println("\n=== ãƒ‡ãƒ¢1b: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆé †æ¬¡å®Ÿè¡Œï¼‰ ===");
    println("3ã¤ã®ãƒ­ã‚±ãƒƒãƒˆã‚’é †ç•ªã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™\n");
    println("ğŸ’¡ ãƒ‘ã‚¿ãƒ¼ãƒ³: ç›´æ¥awaitã§å‘¼ã³å‡ºã™");
    println("   â†’ å„ã‚¿ã‚¹ã‚¯ãŒé †ç•ªã«å®Ÿè¡Œã•ã‚Œã€å…¨ã‚¿ã‚¹ã‚¯ã®åˆè¨ˆæ™‚é–“ãŒã‹ã‹ã‚‹\n");
    
    long start = now();
    
    println("[AWAIT] ãƒ­ã‚±ãƒƒãƒˆAã‚’å®Ÿè¡Œã—ã¦å®Œäº†ã‚’å¾…ã¤");
    int r1 = await countdown_task("ãƒ­ã‚±ãƒƒãƒˆA", 5);  // 5ç§’å¾…ã¤
    println("ãƒ­ã‚±ãƒƒãƒˆAå®Œäº†: {r1}ç§’\n");
    
    println("[AWAIT] ãƒ­ã‚±ãƒƒãƒˆBã‚’å®Ÿè¡Œã—ã¦å®Œäº†ã‚’å¾…ã¤");
    int r2 = await countdown_task("ãƒ­ã‚±ãƒƒãƒˆB", 3);  // 3ç§’å¾…ã¤
    println("ãƒ­ã‚±ãƒƒãƒˆBå®Œäº†: {r2}ç§’\n");
    
    println("[AWAIT] ãƒ­ã‚±ãƒƒãƒˆCã‚’å®Ÿè¡Œã—ã¦å®Œäº†ã‚’å¾…ã¤");
    int r3 = await countdown_task("ãƒ­ã‚±ãƒƒãƒˆC", 4);  // 4ç§’å¾…ã¤
    println("ãƒ­ã‚±ãƒƒãƒˆCå®Œäº†: {r3}ç§’\n");
    
    long end = now();
    
    println("--- çµæœ ---");
    println("ãƒ­ã‚±ãƒƒãƒˆA: {r1}ç§’");
    println("ãƒ­ã‚±ãƒƒãƒˆB: {r2}ç§’");
    println("ãƒ­ã‚±ãƒƒãƒˆC: {r3}ç§’");
    println("åˆè¨ˆ: {r1 + r2 + r3}ç§’");
    println("å®Ÿéš›ã®å®Ÿè¡Œæ™‚é–“: {end - start}msï¼ˆç´„12000ms = å…¨ã‚¿ã‚¹ã‚¯ã®åˆè¨ˆæ™‚é–“ï¼‰");
}

// ========================================
// ãƒ‘ã‚¿ãƒ¼ãƒ³2: é€²è¡ŒçŠ¶æ³è¡¨ç¤º
// ========================================
async int progress_task(string name, int steps) {
    println("[START] {name} - {steps}ã‚¹ãƒ†ãƒƒãƒ—å‡¦ç†é–‹å§‹");
    
    int current = 1;
    while (current <= steps) {
        int percent = (current * 100) / steps;
        println("  [{name}] ã‚¹ãƒ†ãƒƒãƒ— {current}/{steps} ({percent}%)");
        await sleep(400);  // éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°sleep
        current = current + 1;
    }
    
    println("[COMPLETE] {name} - å…¨ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†");
    return steps * 10;
}

void demo_progress() {
    println("\n=== ãƒ‡ãƒ¢2: æ®µéšçš„ãªé€²è¡ŒçŠ¶æ³ ===");
    println("3ã¤ã®ã‚¿ã‚¹ã‚¯ãŒä¸¦è¡Œã—ã¦é€²ã¿ã¾ã™\n");
    
    // å…¨ã‚¿ã‚¹ã‚¯ã‚’å…ˆã«ç™»éŒ²
    Future<int> task1 = progress_task("ã‚¿ã‚¹ã‚¯A", 5);
    Future<int> task2 = progress_task("ã‚¿ã‚¹ã‚¯B", 3);
    Future<int> task3 = progress_task("ã‚¿ã‚¹ã‚¯C", 4);
    
    println("[REGISTERED] å…¨ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²å®Œäº†\n");
    
    int score1 = await task1;
    int score2 = await task2;
    int score3 = await task3;
    
    println("\n--- ã‚¹ã‚³ã‚¢ ---");
    println("ã‚¿ã‚¹ã‚¯A: {score1}ç‚¹");
    println("ã‚¿ã‚¹ã‚¯B: {score2}ç‚¹");
    println("ã‚¿ã‚¹ã‚¯C: {score3}ç‚¹");
    println("ç·åˆ: {score1 + score2 + score3}ç‚¹");
}

// ========================================
// ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒ“ã‚¸ãƒ¼ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
// ========================================
async string busy_task(string operation, int duration_ms) {
    println("[START] {operation} ã‚’å®Ÿè¡Œä¸­...");
    
    int steps = duration_ms / 200;
    int i = 0;
    while (i < steps) {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ã®è¡¨ç¤º
        if (i % 4 == 0) println("  {operation}  |");
        if (i % 4 == 1) println("  {operation}  /");
        if (i % 4 == 2) println("  {operation}  -");
        if (i % 4 == 3) println("  {operation}  \\");
        
        await sleep(200);
        i = i + 1;
    }
    
    println("[COMPLETE] {operation} - å®Œäº†!");
    return operation;
}

void demo_busy() {
    println("\n=== ãƒ‡ãƒ¢3: ãƒ“ã‚¸ãƒ¼ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ===");
    println("å‡¦ç†ãŒé€²è¡Œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’è¦–è¦šçš„ã«ç¢ºèª\n");
    
    Future<string> op1 = busy_task("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š", 1200);
    Future<string> op2 = busy_task("ãƒ‡ãƒ¼ã‚¿å–å¾—", 800);
    Future<string> op3 = busy_task("çµæœå‡¦ç†", 1000);
    
    println("\n[WAIT] å…¨æ“ä½œã®å®Œäº†ã‚’å¾…æ©Ÿä¸­...\n");
    
    string result1 = await op1;
    string result2 = await op2;
    string result3 = await op3;
    
    println("\n--- å®Œäº†ã—ãŸæ“ä½œ ---");
    println("1. {result1}");
    println("2. {result2}");
    println("3. {result3}");
}

// ========================================
// ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
// ========================================
async int monitor_service(string service_name, int checks) {
    println("[MONITOR] {service_name} ã®ç›£è¦–é–‹å§‹");
    
    int check_num = 1;
    int ok_count = 0;
    
    while (check_num <= checks) {
        // äº¤äº’ã«OKã¨BUSYã‚’è¡¨ç¤º
        if (check_num % 2 == 1) {
            println("  [{service_name}] ãƒã‚§ãƒƒã‚¯#{check_num}: OK");
            ok_count = ok_count + 1;
        } else {
            println("  [{service_name}] ãƒã‚§ãƒƒã‚¯#{check_num}: BUSY");
        }
        
        await sleep(500);
        check_num = check_num + 1;
    }
    
    println("[MONITOR] {service_name} ã®ç›£è¦–å®Œäº† ({checks}å›ãƒã‚§ãƒƒã‚¯)");
    return ok_count;
}

void demo_monitor() {
    println("\n=== ãƒ‡ãƒ¢4: ã‚µãƒ¼ãƒ“ã‚¹ç›£è¦– ===");
    println("è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–\n");
    
    Future<int> web = monitor_service("Webã‚µãƒ¼ãƒãƒ¼", 4);
    Future<int> db = monitor_service("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", 3);
    Future<int> cache = monitor_service("ã‚­ãƒ£ãƒƒã‚·ãƒ¥", 5);
    
    println("\n[WAIT] å…¨ç›£è¦–ã®å®Œäº†ã‚’å¾…æ©Ÿä¸­...\n");
    
    int web_ok = await web;
    int db_ok = await db;
    int cache_ok = await cache;
    
    println("\n--- ç›£è¦–çµæœ ---");
    println("Webã‚µãƒ¼ãƒãƒ¼: {web_ok}å›æ­£å¸¸");
    println("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: {db_ok}å›æ­£å¸¸");
    println("ã‚­ãƒ£ãƒƒã‚·ãƒ¥: {cache_ok}å›æ­£å¸¸");
    int total = web_ok + db_ok + cache_ok;
    println("åˆè¨ˆ: {total}å›æ­£å¸¸");
}

// ========================================
// ãƒ‘ã‚¿ãƒ¼ãƒ³5: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒãƒƒãƒ
// ========================================
async int process_batch(string data_type, int items) {
    println("[BATCH] {data_type} ã®å‡¦ç†é–‹å§‹ ({items}ä»¶)");
    
    int processed = 0;
    while (processed < items) {
        processed = processed + 1;
        
        // 10ä»¶ã”ã¨ã¾ãŸã¯æœ€å¾Œã«é€²æ—ã‚’è¡¨ç¤º
        if (processed % 10 == 0 || processed == items) {
            int percent = (processed * 100) / items;
            println("  [{data_type}] {processed}/{items}ä»¶å‡¦ç†æ¸ˆã¿ ({percent}%)");
        }
        
        await sleep(150);
    }
    
    println("[BATCH] {data_type} ã®å‡¦ç†å®Œäº†");
    return processed;
}

void demo_batch() {
    println("\n=== ãƒ‡ãƒ¢5: ãƒãƒƒãƒå‡¦ç† ===");
    println("å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦è¡Œå‡¦ç†\n");
    
    Future<int> users = process_batch("ãƒ¦ãƒ¼ã‚¶ãƒ¼", 30);
    Future<int> products = process_batch("å•†å“", 20);
    Future<int> orders = process_batch("æ³¨æ–‡", 25);
    
    println("\n[WAIT] å…¨ãƒãƒƒãƒã®å®Œäº†ã‚’å¾…æ©Ÿä¸­...\n");
    
    int user_count = await users;
    int product_count = await products;
    int order_count = await orders;
    
    println("\n--- å‡¦ç†ä»¶æ•° ---");
    println("ãƒ¦ãƒ¼ã‚¶ãƒ¼: {user_count}ä»¶");
    println("å•†å“: {product_count}ä»¶");
    println("æ³¨æ–‡: {order_count}ä»¶");
    println("ç·è¨ˆ: {user_count + product_count + order_count}ä»¶");
}

// ========================================
// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
// ========================================
void main() {
    println("\n");
    println("========================================");
    println("   éåŒæœŸå‡¦ç†ã®è¦–è¦šçš„ãƒ‡ãƒ¢");
    println("========================================");
    println("\n");
    println("async/awaitãŒå®Ÿéš›ã«å‹•ä½œã™ã‚‹æ§˜å­ã‚’");
    println("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™!");
    println("\n");
    println("ğŸ”‘ é‡è¦ãªæ¦‚å¿µ:");
    println("  - ä¸¦è¡Œå®Ÿè¡Œ: Futureã‚’å…ˆã«ä½œæˆ â†’ å…¨ã‚¿ã‚¹ã‚¯ãŒåŒæ™‚å®Ÿè¡Œ");
    println("  - é †æ¬¡å®Ÿè¡Œ: ç›´æ¥awaitã§å‘¼ã³å‡ºã— â†’ ã‚¿ã‚¹ã‚¯ãŒé †ç•ªã«å®Ÿè¡Œ");
    
    // ãƒ‡ãƒ¢1a: ä¸¦è¡Œå®Ÿè¡Œ
    demo_countdown();
    
    println("\n========================================");
    
    // ãƒ‡ãƒ¢1b: é †æ¬¡å®Ÿè¡Œ
    demo_countdown_sequential();
    
    println("\n========================================");
    
    // ãƒ‡ãƒ¢2: é€²è¡ŒçŠ¶æ³
    demo_progress();
    
    println("\n========================================");
    
    // ãƒ‡ãƒ¢3: ãƒ“ã‚¸ãƒ¼ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    demo_busy();
    
    println("\n========================================");
    
    // ãƒ‡ãƒ¢4: ã‚µãƒ¼ãƒ“ã‚¹ç›£è¦–
    demo_monitor();
    
    println("\n========================================");
    
    // ãƒ‡ãƒ¢5: ãƒãƒƒãƒå‡¦ç†
    demo_batch();
    
    println("\n");
    println("========================================");
    println("   å…¨ã¦ã®ãƒ‡ãƒ¢ãŒå®Œäº†ã—ã¾ã—ãŸ!");
    println("========================================");
    println("\n");
    println("========================================");
    println("   ã¾ã¨ã‚");
    println("========================================");
    println("\n");
    println("ğŸ“š å­¦ã‚“ã ã“ã¨:");
    println("\n");
    println("1ï¸âƒ£  ä¸¦è¡Œå®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆConcurrentï¼‰:");
    println("   Future<T> f = async_function();  // ã‚¿ã‚¹ã‚¯ç™»éŒ²");
    println("   T result = await f;               // çµæœå¾…ã¡");
    println("   â†’ è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹");
    println("   â†’ å®Ÿè¡Œæ™‚é–“ = æœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ã®æ™‚é–“");
    println("\n");
    println("2ï¸âƒ£  é †æ¬¡å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSequentialï¼‰:");
    println("   T result = await async_function();  // å³åº§ã«å®Ÿè¡Œ");
    println("   â†’ ã‚¿ã‚¹ã‚¯ãŒé †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹");
    println("   â†’ å®Ÿè¡Œæ™‚é–“ = å…¨ã‚¿ã‚¹ã‚¯ã®åˆè¨ˆæ™‚é–“");
    println("\n");
    println("3ï¸âƒ£  ä½¿ã„åˆ†ã‘:");
    println("   - ä¸¦è¡Œå®Ÿè¡Œ: ç‹¬ç«‹ã—ãŸã‚¿ã‚¹ã‚¯ã‚’åŠ¹ç‡çš„ã«å‡¦ç†");
    println("   - é †æ¬¡å®Ÿè¡Œ: å‰ã®ã‚¿ã‚¹ã‚¯ã®çµæœãŒå¿…è¦ãªå ´åˆ");
    println("\n");
    println("ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ:");
    println("  - sleep()ã¯éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼ˆä»–ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰");
    println("  - ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã§å…¬å¹³ã«å®Ÿè¡Œ");
    println("  - awaitã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ¶å¾¡");
    println("\n");
}
