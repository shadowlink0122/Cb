// Async/Await Execution Patterns
// ä¸¦è¡Œå®Ÿè¡Œã¨é †æ¬¡å®Ÿè¡Œã®é•ã„ã‚’æ˜ç¢ºã«ç¤ºã™ã‚µãƒ³ãƒ—ãƒ«

import stdlib.std.time;

// éåŒæœŸã‚¿ã‚¹ã‚¯: æŒ‡å®šæ™‚é–“å¾…æ©Ÿã—ã¦ã‹ã‚‰å®Œäº†
async int slow_task(string name, int duration_ms) {
    long task_start = now();
    println("  [{name}] é–‹å§‹ ({duration_ms}ms) at {task_start}");
    await sleep(duration_ms);
    long task_end = now();
    println("  [{name}] å®Œäº† (çµŒé: {task_end - task_start}ms)");
    return duration_ms;
}

void main() {
    println("========================================");
    println("  Async/Await å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¯”è¼ƒ");
    println("========================================\n");
    
    // ========================================
    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ä¸¦è¡Œå®Ÿè¡Œï¼ˆConcurrentï¼‰
    // ========================================
    println("ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1ã€‘ä¸¦è¡Œå®Ÿè¡Œï¼ˆConcurrentï¼‰");
    println("Futureã‚’å…ˆã«ä½œæˆã—ã¦ã‹ã‚‰çµæœã‚’å¾…ã¤\n");
    println("ã‚³ãƒ¼ãƒ‰:");
    println("  Future<int> f1 = async_task(500);  // ç™»éŒ²");
    println("  Future<int> f2 = async_task(300);  // ç™»éŒ²");
    println("  Future<int> f3 = async_task(400);  // ç™»éŒ²");
    println("  int r1 = await f1;  // çµæœå¾…ã¡");
    println("  int r2 = await f2;  // çµæœå¾…ã¡");
    println("  int r3 = await f3;  // çµæœå¾…ã¡\n");
    
    long start1 = now();
    
    // å…¨ã‚¿ã‚¹ã‚¯ã‚’å…ˆã«ç™»éŒ²ï¼ˆä¸¦è¡Œå®Ÿè¡Œé–‹å§‹ï¼‰
    Future<int> task1 = slow_task("ã‚¿ã‚¹ã‚¯1", 500);
    Future<int> task2 = slow_task("ã‚¿ã‚¹ã‚¯2", 300);
    Future<int> task3 = slow_task("ã‚¿ã‚¹ã‚¯3", 400);
    
    // ã™ãã«awaitã—ã¦ã€printlnã§æ™‚é–“ã‚’æ¶ˆè²»ã—ãªã„
    int r1 = await task1;  // ã‚¿ã‚¹ã‚¯1ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆä»–ã®ã‚¿ã‚¹ã‚¯ã¯ä¸¦è¡Œå®Ÿè¡Œä¸­ï¼‰
    int r2 = await task2;  // ã‚¿ã‚¹ã‚¯2ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆæ—¢ã«å®Œäº†æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰
    int r3 = await task3;  // ã‚¿ã‚¹ã‚¯3ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆæ—¢ã«å®Œäº†æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰
    
    long end1 = now();
    
    println("\nçµæœ:");
    println("  ã‚¿ã‚¹ã‚¯1: {r1}ms");
    println("  ã‚¿ã‚¹ã‚¯2: {r2}ms");
    println("  ã‚¿ã‚¹ã‚¯3: {r3}ms");
    println("  å®Ÿè¡Œæ™‚é–“: {end1 - start1}ms");
    println("  æœŸå¾…å€¤: ç´„500msï¼ˆæœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ã®æ™‚é–“ï¼‰\n");
    
    println("========================================\n");
    
    // ========================================
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: é †æ¬¡å®Ÿè¡Œï¼ˆSequentialï¼‰
    // ========================================
    println("ã€ãƒ‘ã‚¿ãƒ¼ãƒ³2ã€‘é †æ¬¡å®Ÿè¡Œï¼ˆSequentialï¼‰");
    println("ç›´æ¥awaitã§å‘¼ã³å‡ºã™\n");
    println("ã‚³ãƒ¼ãƒ‰:");
    println("  int r1 = await async_task(500);  // å®Ÿè¡Œ");
    println("  int r2 = await async_task(300);  // å®Ÿè¡Œ");
    println("  int r3 = await async_task(400);  // å®Ÿè¡Œ\n");
    
    long start2 = now();
    
    println("å®Ÿè¡Œ:");
    int s1 = await slow_task("ã‚¿ã‚¹ã‚¯1", 500);
    int s2 = await slow_task("ã‚¿ã‚¹ã‚¯2", 300);
    int s3 = await slow_task("ã‚¿ã‚¹ã‚¯3", 400);
    
    long end2 = now();
    
    println("\nçµæœ:");
    println("  ã‚¿ã‚¹ã‚¯1: {s1}ms");
    println("  ã‚¿ã‚¹ã‚¯2: {s2}ms");
    println("  ã‚¿ã‚¹ã‚¯3: {s3}ms");
    println("  å®Ÿè¡Œæ™‚é–“: {end2 - start2}ms");
    println("  æœŸå¾…å€¤: ç´„1200msï¼ˆå…¨ã‚¿ã‚¹ã‚¯ã®åˆè¨ˆæ™‚é–“ï¼‰\n");
    
    println("========================================\n");
    
    // ========================================
    // ã¾ã¨ã‚
    // ========================================
    println("ã€ã¾ã¨ã‚ã€‘\n");
    println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println("â”‚ é …ç›®            â”‚ ä¸¦è¡Œå®Ÿè¡Œ    â”‚ é †æ¬¡å®Ÿè¡Œ    â”‚");
    println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println("â”‚ ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³  â”‚ Futureä½œæˆ  â”‚ ç›´æ¥await   â”‚");
    println("â”‚                 â”‚ â†’ await     â”‚             â”‚");
    println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println("â”‚ å®Ÿè¡Œé †åº        â”‚ åŒæ™‚å®Ÿè¡Œ    â”‚ é †ç•ªã«å®Ÿè¡Œ  â”‚");
    println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println("â”‚ å®Ÿè¡Œæ™‚é–“        â”‚ æœ€å¤§ã‚¿ã‚¹ã‚¯  â”‚ å…¨ã‚¿ã‚¹ã‚¯åˆè¨ˆâ”‚");
    println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println("â”‚ ä½¿ç”¨å ´é¢        â”‚ ç‹¬ç«‹ã‚¿ã‚¹ã‚¯  â”‚ ä¾å­˜é–¢ä¿‚    â”‚");
    println("â”‚                 â”‚ åŠ¹ç‡é‡è¦–    â”‚ é †åºé‡è¦–    â”‚");
    println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
    
    println("ğŸ’¡ ä½¿ã„åˆ†ã‘ã®ãƒã‚¤ãƒ³ãƒˆ:");
    println("  â€¢ ä¸¦è¡Œå®Ÿè¡Œ: ã‚¿ã‚¹ã‚¯ãŒäº’ã„ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹å ´åˆ");
    println("    ä¾‹: è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€è¤‡æ•°ã®APIå‘¼ã³å‡ºã—");
    println("    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: æœ€ã‚‚é…ã„ã‚¿ã‚¹ã‚¯ã®æ™‚é–“ã§å®Œäº†");
    println("\n  â€¢ é †æ¬¡å®Ÿè¡Œ: å‰ã®ã‚¿ã‚¹ã‚¯ã®çµæœãŒå¿…è¦ãªå ´åˆ");
    println("    ä¾‹: ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ åŠ å·¥ â†’ ä¿å­˜");
    println("    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: å…¨ã‚¿ã‚¹ã‚¯ã®åˆè¨ˆæ™‚é–“\n");
    
    println("ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹:");
    println("  1. å…¨ã¦ã®Futureã‚’å…ˆã«ä½œæˆã—ã¦ã‹ã‚‰ã€ã¾ã¨ã‚ã¦await");
    println("  2. ä¾å­˜é–¢ä¿‚ã®ãªã„ã‚¿ã‚¹ã‚¯ã¯ä¸¦è¡Œå®Ÿè¡Œ");
    println("  3. ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã¯é †æ¬¡å®Ÿè¡Œ");
    println("  4. æ··åœ¨ã™ã‚‹å ´åˆã¯é©åˆ‡ã«çµ„ã¿åˆã‚ã›ã‚‹\n");
    
    println("========================================");
}
