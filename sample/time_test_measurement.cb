// 実用的なテスト計測の例 - ユニットテスト風

import stdlib.std.time;

// テストフレームワーク風の関数

void test_simple_calculation() {
    Stopwatch sw = create_stopwatch();
    sw.start();
    
    int result = 2 + 2;
    
    sw.stop();
    
    if (result == 4) {
        print("✅ test_simple_calculation: PASS - ");
        sw.print_elapsed();
    } else {
        println("❌ test_simple_calculation: FAIL");
    }
}

void test_loop_performance() {
    Stopwatch sw = create_stopwatch();
    sw.start();
    
    int sum = 0;
    int i = 0;
    while (i < 50000) {
        sum = sum + 1;
        i = i + 1;
    }
    
    sw.stop();
    
    if (sum == 50000) {
        print("✅ test_loop_performance: PASS - ");
        sw.print_elapsed();
    } else {
        println("❌ test_loop_performance: FAIL");
    }
}

void test_with_timeout() {
    println("\n=== タイムアウト付きテスト ===");
    
    Timer timeout = create_timer(1000);  // 1秒タイムアウト
    timeout.start();
    
    Stopwatch sw = create_stopwatch();
    sw.start();
    
    bool completed = false;
    int iterations = 0;
    
    while (!timeout.is_timeout()) {
        sleep(100);
        iterations = iterations + 1;
    }
    
    sw.stop();
    
    print("タイムアウトテスト: %d回実行 - ", iterations);
    sw.print_elapsed();
}

void benchmark_function_a() {
    int sum = 0;
    int i = 0;
    while (i < 20000) {
        sum = sum + 1;
        i = i + 1;
    }
}

void benchmark_function_b() {
    int sum = 0;
    int i = 0;
    while (i < 40000) {
        sum = sum + 1;
        i = i + 1;
    }
}

void performance_comparison() {
    println("\n=== パフォーマンス比較テスト ===");
    
    // 関数Aをベンチマーク
    Stopwatch swA = create_stopwatch();
    swA.start();
    benchmark_function_a();
    swA.stop();
    
    // 関数Bをベンチマーク
    Stopwatch swB = create_stopwatch();
    swB.start();
    benchmark_function_b();
    swB.stop();
    
    print("関数A (20K ループ): ");
    swA.print_elapsed();
    
    print("関数B (40K ループ): ");
    swB.print_elapsed();
    
    long diff = swB.elapsed_ms() - swA.elapsed_ms();
    
    if (swB.elapsed_ms() > swA.elapsed_ms()) {
        println("✅ 期待通り: Bの方が遅い (差分: %ld ms)", diff);
    } else {
        println("❌ 異常: Bの方が速い");
    }
}

void test_suite() {
    println("\n=== テストスイート実行 ===");
    
    Stopwatch total = create_stopwatch();
    total.start();
    
    int test_count = 0;
    int pass_count = 0;
    
    // テスト1
    println("\n[Test 1/5]");
    test_simple_calculation();
    test_count = test_count + 1;
    pass_count = pass_count + 1;
    
    // テスト2
    println("\n[Test 2/5]");
    test_loop_performance();
    test_count = test_count + 1;
    pass_count = pass_count + 1;
    
    // テスト3
    println("\n[Test 3/5]");
    Stopwatch sw3 = create_stopwatch();
    sw3.start();
    sleep(100);
    sw3.stop();
    long elapsed = sw3.elapsed_ms();
    if (elapsed >= 100 && elapsed <= 120) {
        print("✅ test_sleep_accuracy: PASS - ");
        sw3.print_elapsed();
    } else {
        println("❌ test_sleep_accuracy: FAIL");
    }
    test_count = test_count + 1;
    pass_count = pass_count + 1;
    
    // テスト4
    println("\n[Test 4/5]");
    Time t1 = get_current_time();
    sleep(50);
    Time t2 = get_current_time();
    long diff = t2.diff(t1);
    if (diff >= 50 && diff <= 70) {
        println("✅ test_time_diff: PASS (%ld ms)", diff);
    } else {
        println("❌ test_time_diff: FAIL");
    }
    test_count = test_count + 1;
    pass_count = pass_count + 1;
    
    // テスト5
    println("\n[Test 5/5]");
    Timer timer = create_timer(200);
    timer.start();
    while (!timer.is_timeout()) {
        sleep(10);
    }
    if (timer.is_timeout()) {
        println("✅ test_timer_timeout: PASS");
    } else {
        println("❌ test_timer_timeout: FAIL");
    }
    test_count = test_count + 1;
    pass_count = pass_count + 1;
    
    total.stop();
    
    println("\n========================================");
    println("テスト結果:");
    println("  全体: %d tests", test_count);
    println("  成功: %d tests", pass_count);
    println("  失敗: %d tests", test_count - pass_count);
    print("  実行時間: ");
    total.print_elapsed();
    println("========================================");
}

void real_world_example() {
    println("\n=== 実用例: データ処理シミュレーション ===");
    
    Stopwatch total = create_stopwatch();
    total.start();
    
    // フェーズ1: データ読み込み
    Stopwatch phase1 = create_stopwatch();
    phase1.start();
    println("フェーズ1: データ読み込み中...");
    sleep(300);
    phase1.stop();
    print("フェーズ1完了 - ");
    phase1.print_elapsed();
    
    // フェーズ2: データ処理
    Stopwatch phase2 = create_stopwatch();
    phase2.start();
    println("\nフェーズ2: データ処理中...");
    int i = 0;
    while (i < 30000) {
        i = i + 1;
    }
    phase2.stop();
    print("フェーズ2完了 - ");
    phase2.print_elapsed();
    
    // フェーズ3: 結果保存
    Stopwatch phase3 = create_stopwatch();
    phase3.start();
    println("\nフェーズ3: 結果保存中...");
    sleep(150);
    phase3.stop();
    print("フェーズ3完了 - ");
    phase3.print_elapsed();
    
    total.stop();
    
    println("\n---");
    print("合計処理時間: ");
    total.print_elapsed();
    
    // 各フェーズの割合を計算
    long total_ms = total.elapsed_ms();
    long phase1_ms = phase1.elapsed_ms();
    long phase2_ms = phase2.elapsed_ms();
    long phase3_ms = phase3.elapsed_ms();
    
    println("\n処理時間の内訳:");
    println("  フェーズ1: %ld ms", phase1_ms);
    println("  フェーズ2: %ld ms", phase2_ms);
    println("  フェーズ3: %ld ms", phase3_ms);
    println("  合計: %ld ms", total_ms);
}

int main() {
    println("========================================");
    println("  実用的なテスト計測の例");
    println("========================================");
    
    println("\n=== 基本的なテスト ===");
    test_simple_calculation();
    test_loop_performance();
    test_with_timeout();
    
    performance_comparison();
    test_suite();
    real_world_example();
    
    println("\n========================================");
    println("  全ての例が完了しました！");
    println("========================================");
    
    return 0;
}
